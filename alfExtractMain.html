<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />



<title>ALFRESCO Data Extraction: Rmpi Code</title>

<script src="libs/jquery-1.11.0/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.1/css/cosmo.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.1/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/respond.min.js"></script>
<style type="text/css">
/* padding for bootstrap navbar */
body {
padding-top: 50px;
padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar) */
.section h2 {
padding-top: 55px;
margin-top: -55px;
}
.section h3 {
padding-top: 55px;
margin-top: -55px;
}
/* don't use link color in navbar */
.dropdown-menu>li>a {
color: black;
}
/* some padding for disqus */
#disqus_thread {
margin-top: 45px;
}
p {
  text-align: justify;
}
img.centered {
  display: block;
  margin-left: auto;
  margin-right: auto;
}
</style>
<link rel="stylesheet" href="libs/font-awesome-4.1.0/css/font-awesome.min.css"/>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; background-color: #303030; color: #cccccc; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; }
td.sourceCode { padding-left: 5px; }
pre, code { color: #cccccc; background-color: #303030; }
code > span.kw { color: #f0dfaf; }
code > span.dt { color: #dfdfbf; }
code > span.dv { color: #dcdccc; }
code > span.bn { color: #dca3a3; }
code > span.fl { color: #c0bed1; }
code > span.ch { color: #dca3a3; }
code > span.st { color: #cc9393; }
code > span.co { color: #7f9f7f; }
code > span.ot { color: #efef8f; }
code > span.al { color: #ffcfaf; }
code > span.fu { color: #efef8f; }
code > span.er { color: #c3bf9f; }
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>



<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-46129458-3', 'auto');
  ga('send', 'pageview');

</script>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img { 
  max-width:100%; 
  height: auto; 
}
</style>
<div class="container-fluid main-container">

<div class="navbar navbar-default navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">SNAP Data QA/QC</a>
      </div>
      <div class="navbar-collapse collapse navbar-responsive-collapse">
        <ul class="nav navbar-nav">
          <li><a href="index.html">Overview</a></li>

          <li class="dropdown">
            <a href="climate" class="dropdown-toggle" data-toggle="dropdown">Climate <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li class="dropdown-header">Extraction</li>
              <li><a href="AR4_AR5_extract.html">Downscaled GCMs</a></li>
              <li><a href="CRU_extract.html">Downscaled CRU 3.x</a></li>
              <li><a href="PRISM_extract.html">2-km PRISM</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">GCM organization</li>
              <li><a href="stats_setup.html">Regions: stats</a></li>
              <li><a href="samples_setup.html">Regions: densities</a></li>
              <li><a href="cities_setup.html">Cities: stats</a></li>
              <li class="dropdown-header">CRU organization</li>
              <li><a href="stats_setup_CRU.html">Regions: stats</a></li>
              <li><a href="samples_setup_CRU.html">Regions: densities</a></li>
              <li><a href="cities_setup_CRU.html">Cities: stats</a></li>
            </ul>

          <li class="dropdown">
            <a href="fire-&-veg" class="dropdown-toggle" data-toggle="dropdown">Fire & Veg <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li class="dropdown-header">Extraction</li>
              <li><a href="alfExtractMain.html">ALFRESCO: Rmpi</a></li>
              <li><a href="alfExtract.html">ALFRESCO: functions</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">Organization</li>
              <li><a href="alfPrep.html">ALFRESCO: final prep</a></li>
            </ul>

          <li class="dropdown">
            <a href="analyses" class="dropdown-toggle" data-toggle="dropdown">Analyses <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li class="dropdown-header">Autocorrelation</li>
              <li><a href="sp_ac_clump.html">Intro/example</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">Working with SNAP data</li>
              <li><a href="pres1_snapdata_alfresco.html">ALFRESCO</a></li>
            </ul>

          <li class="dropdown">
            <a href="app-docs" class="dropdown-toggle" data-toggle="dropdown">App docs <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li><a href="aboutapp.html">About</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">Help documents</li>
              <li><a href="help01_start.html">Getting started</a></li>
              <li><a href="help02_data.html">Working with data</a></li>
              <li><a href="help03_plotOptions.html">Graphical options</a></li>
              <li><a href="help04_updating.html">Updating settings</a></li>
              <li><a href="help05_01_graphTS.html">Graphing: time series</a></li>
              <li><a href="help05_02_graphScatter.html">Graphing: scatter plots</a></li>
              <li><a href="help05_03_graphHeat.html">Graphing: heat maps</a></li>
              <li><a href="help05_04_graphVar.html">Graphing: variability</a></li>
              <li><a href="help05_05_graphSpatial.html">Graphing: distributions</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">Prep R code</li>
              <li><a href="qaqc_app_metadata.html">QA/QC App Metadata</a></li>
            </ul>

          <li class="dropdown">
            <a href="app-code" class="dropdown-toggle" data-toggle="dropdown">App code <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li class="dropdown-header">App R code</li>
              <li><a href="appcode_global.html">global.R</a></li>
              <li><a href="appcode_ui.html">ui.R</a></li>
              <li><a href="appcode_server.html">server.R</a></li>
              <li><a href="appcode_about.html">about.R</a></li>
              <li class="divider"></li>
              <li><a href="appcode_sidebar.html">sidebar.R</a></li>
              <li><a href="appcode_main.html">main.R</a></li>
              <li><a href="appcode_serverHead.html">serverHead.R</a></li>
              <li><a href="appcode_app.html">app.R</a></li>
              <li class="divider"></li>
              <li><a href="appcode_io_sidebar.html">io_sidebar.R</a></li>
              <li><a href="appcode_io_main.html">io_main.R</a></li>
              <li><a href="appcode_reactives.html">reactives.R</a></li>
              <li class="divider"></li>
              <li><a href="appcode_plot_ts.html">plot_ts.R</a></li>
              <li><a href="appcode_plot_scatter.html">plot_scatter.R</a></li>
              <li><a href="appcode_plot_heatmap.html">plot_heatmap.R</a></li>
              <li><a href="appcode_plot_variability.html">plot_variability.R</a></li>
              <li><a href="appcode_plot_spatial.html">plot_spatial.R</a></li>
            </ul>

          <li><a href="http://leonawicz.github.io">All Projects</a></li>
        </ul>
        <ul class="nav navbar-nav navbar-right">
          <a class="btn btn-link" href="https://github.com/leonawicz/SNAPQAQC">
            <i class="fa fa-github fa-lg"></i>
            Github
          </a>
        </ul>
      </div><!--/.nav-collapse -->
    </div>
  </div>

<div id="header">
<h1 class="title">ALFRESCO Data Extraction: Rmpi Code</h1>
</div>


<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>The <code>alfExtractMain.R</code> script uses <code>Rmpi</code> to efficiently extract fire and vegetation statistics from calibrated, finalized ALFRESCO run output over the full Alaska-Canada 1-km resolution ALFRESCO extent. Data are saved to <strong>R</strong> workspaces (.RData files) for analysis and graphing by subsequent <strong>R</strong> code.</p>
<div id="motivation" class="section level3">
<h3>Motivation</h3>
<p>The primary motivation for this code is not just to extract regional data from a large number of high-resolution geotiffs, but to limit the routine recurrence and redundancy of such extractions. It allows for storing commonly required data in a more compact format that can be quickly shared and digested by other projects.</p>
</div>
<div id="details" class="section level3">
<h3>Details</h3>
<p>Extractions occur across multiple climate model and scenario-driven runs for multiple simulation replicates. Statistics are extracted from geotiff output map layers for the entire spatial extent as well as an arbitrary number of spatial subregions. This script is intended to run on a single climate model-driven set of ALFRESCO output files at a time; one model-scenario pair.</p>
</div>
<div id="files-and-data" class="section level3">
<h3>Files and data</h3>
<p>The input files include 1-km Alaska-Canada extent data from ALFRESCO simulations as well as raster layer cell indices pertaining to various regional shapefile polygons. <code>alfExtractMain.R</code> is called via slurm script, <code>alfExtractMain.slurm</code> and is itself a wrapper around <code>alfExtract.R</code> which performs data extractions on multiple CPU cores across multiple compute nodes.</p>
<p>The <code>alfExtractMain.R</code> gathers on a head node the data extracted from ALFRESCO outputs on the CPU cores across all the processing nodes and writes these data to intermediary .RData workspace files:</p>
<ul>
<li>Fire data (burn area, fire frequency and fire sizes) by region and vegetation class</li>
<li>Vegetation age by region and vegetation class</li>
<li>Vegetated area by region and vegetation class</li>
</ul>
<p>Intermediate outputs are handled by additional <strong>R</strong> scripts.</p>
</div>
</div>
<div id="r-code" class="section level2">
<h2>R code</h2>
<div id="setup" class="section level3">
<h3>Setup</h3>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Command line arguments</span>
args =<span class="st"> </span>(<span class="kw">commandArgs</span>(<span class="ot">TRUE</span>))
if (!<span class="kw">length</span>(args)) <span class="kw">q</span>(<span class="st">&quot;no&quot;</span>) else for (i in <span class="dv">1</span>:<span class="kw">length</span>(args)) <span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> args[[i]]))

if (!<span class="kw">exists</span>(<span class="st">&quot;model.index&quot;</span>)) <span class="kw">stop</span>(<span class="st">&quot;Must provide a model.index 1 to 15, e.g., model.index=1&quot;</span>)
<span class="kw">stopifnot</span>(<span class="kw">length</span>(model.index) ==<span class="st"> </span><span class="dv">1</span>)
if (!<span class="kw">exists</span>(<span class="st">&quot;reps&quot;</span>)) <span class="kw">stop</span>(<span class="st">&quot;Must provide replicates as integer(s) 1:200, e.g., reps=1:25&quot;</span>)
if (!<span class="kw">exists</span>(<span class="st">&quot;years&quot;</span>)) years &lt;-<span class="st"> </span><span class="dv">2008</span>:<span class="dv">2100</span>  <span class="co"># Assume if not specified</span>
if (!<span class="kw">exists</span>(<span class="st">&quot;Rmpi&quot;</span>)) Rmpi &lt;-<span class="st"> </span><span class="ot">TRUE</span>
if (Rmpi) {
    if (!<span class="kw">exists</span>(<span class="st">&quot;mpiBy&quot;</span>)) 
        mpiBy &lt;-<span class="st"> &quot;year&quot;</span>
    itervar &lt;-<span class="st"> </span>if (mpiBy ==<span class="st"> &quot;rep&quot;</span>) 
        reps else if (mpiBy ==<span class="st"> &quot;year&quot;</span>) 
        <span class="dv">1</span>:<span class="kw">length</span>(years) else <span class="kw">stop</span>(<span class="st">&quot;mpiBy must be &#39;rep&#39; or &#39;year&#39;.&quot;</span>)
    loopBy &lt;-<span class="st"> </span>if (mpiBy ==<span class="st"> &quot;rep&quot;</span>) 
        <span class="st">&quot;year&quot;</span> else <span class="st">&quot;rep&quot;</span>
}
if (!<span class="kw">exists</span>(<span class="st">&quot;doFire&quot;</span>)) doFire &lt;-<span class="st"> </span><span class="ot">TRUE</span>
if (!<span class="kw">exists</span>(<span class="st">&quot;doAgeVeg&quot;</span>)) doAgeVeg &lt;-<span class="st"> </span><span class="ot">TRUE</span>
if (<span class="kw">exists</span>(<span class="st">&quot;repSample&quot;</span>) &amp;&amp;<span class="st"> </span><span class="kw">is.numeric</span>(repSample)) {
    <span class="kw">set.seed</span>(<span class="dv">47</span>)
    reps &lt;-<span class="st"> </span><span class="kw">sort</span>(<span class="kw">sample</span>(reps, <span class="kw">min</span>(repSample, <span class="kw">length</span>(reps))))
    <span class="kw">cat</span>(<span class="st">&quot;Sampled replicates:</span><span class="ch">\n</span><span class="st">&quot;</span>, reps, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)
}

<span class="kw">library</span>(raster)
<span class="kw">library</span>(data.table)
<span class="kw">library</span>(dplyr)

<span class="co"># Rmpi setup</span>
if (Rmpi) {
    <span class="kw">library</span>(Rmpi)
    <span class="kw">mpi.spawn.Rslaves</span>(<span class="dt">needlog =</span> <span class="ot">TRUE</span>)
    <span class="kw">mpi.bcast.cmd</span>(id &lt;-<span class="st"> </span><span class="kw">mpi.comm.rank</span>())
    <span class="kw">mpi.bcast.cmd</span>(np &lt;-<span class="st"> </span><span class="kw">mpi.comm.size</span>())
    <span class="kw">mpi.bcast.cmd</span>(host &lt;-<span class="st"> </span><span class="kw">mpi.get.processor.name</span>())
} else {
    <span class="kw">library</span>(parallel)
    n.cores &lt;-<span class="st"> </span><span class="dv">32</span>
}

<span class="co"># Load data table of cell indices defining groups of shapefile polygons</span>
<span class="kw">load</span>(<span class="st">&quot;/workspace/UA/mfleonawicz/projects/DataExtraction/workspaces/shapes2cells_akcan1km2km.RData&quot;</span>)
cells &lt;-<span class="st"> </span><span class="kw">filter</span>(cells, Source ==<span class="st"> &quot;akcan1km&quot;</span>) %&gt;%<span class="st"> </span>group_by %&gt;%<span class="st"> </span><span class="kw">select</span>(-Source) %&gt;%<span class="st"> </span>
<span class="st">    </span><span class="kw">group_by</span>(LocGroup, Location)
if (<span class="kw">exists</span>(<span class="st">&quot;locgroup&quot;</span>)) {
    <span class="kw">cat</span>(<span class="st">&quot;locgroup = &quot;</span>)
    <span class="kw">cat</span>(locgroup)
    <span class="kw">cat</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)
    cells &lt;-<span class="st"> </span><span class="kw">filter</span>(cells, LocGroup %in%<span class="st"> </span><span class="kw">unique</span>(cells$LocGroup)[locgroup])
    <span class="kw">print</span>(<span class="kw">unique</span>(cells$LocGroup))
    <span class="kw">stopifnot</span>(<span class="kw">nrow</span>(cells) &gt;<span class="st"> </span><span class="dv">0</span>)
}

dirs &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="st">&quot;/big_scratch/apbennett/Calibration/FinalCalib&quot;</span>, <span class="dt">pattern =</span> <span class="st">&quot;.*.sres.*.&quot;</span>, 
    <span class="dt">full =</span> T)
mainDirs &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="kw">paste0</span>(dirs, <span class="st">&quot;/Maps&quot;</span>)[model.index], <span class="dt">each =</span> <span class="kw">length</span>(itervar))
modname &lt;-<span class="st"> </span><span class="kw">unique</span>(<span class="kw">basename</span>(<span class="kw">dirname</span>(mainDirs)))
if (mpiBy ==<span class="st"> &quot;rep&quot;</span>) <span class="kw">dir.create</span>(ageDir &lt;-<span class="st"> </span><span class="kw">file.path</span>(<span class="st">&quot;/big_scratch/mfleonawicz/Rmpi/outputs/veg&quot;</span>, 
    modname), <span class="dt">recursive =</span> T, <span class="dt">showWarnings =</span> F) else ageDir &lt;-<span class="st"> </span><span class="ot">NULL</span>

<span class="co"># veg.labels &lt;- c(&#39;Black Spruce&#39;, &#39;White Spruce&#39;, &#39;Deciduous&#39;, &#39;Shrub</span>
<span class="co"># Tundra&#39;, &#39;Graminoid Tundra&#39;, &#39;Wetland Tundra&#39;, &#39;Barren lichen-moss&#39;,</span>
<span class="co"># &#39;Temperate Rainforest&#39;)</span>
scen.levels &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;SRES B1&quot;</span>, <span class="st">&quot;SRES A1B&quot;</span>, <span class="st">&quot;SRES A2&quot;</span>, <span class="st">&quot;RCP 4.5&quot;</span>, <span class="st">&quot;RCP 6.0&quot;</span>, <span class="st">&quot;RCP 8.5&quot;</span>)
mod.scen &lt;-<span class="st"> </span><span class="kw">unlist</span>(<span class="kw">strsplit</span>(modname, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">.&quot;</span>))</code></pre>
</div>
<div id="functions" class="section level3">
<h3>Functions</h3>
<p>Define support functions.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Support functions include later: # CCSM4=&#39;CCSM4&#39;, GFDLcm3=&#39;GFDLcm3&#39;,</span>
<span class="co"># GISSe2-r=&#39;GISSe2-r&#39;, IPSLcm5a-lr=&#39;IPSLcm5a-lr&#39;, MRIcgcm3=&#39;MRIcgcm3&#39;</span>
swapModelName &lt;-<span class="st"> </span>function(x) {
    switch(x, <span class="dt">cccma_cgcm3_1 =</span> <span class="st">&quot;CCCMAcgcm31&quot;</span>, <span class="dt">gfdl_cm2_1 =</span> <span class="st">&quot;GFDLcm21&quot;</span>, <span class="dt">miroc3_2_medres =</span> <span class="st">&quot;MIROC32m&quot;</span>, 
        <span class="dt">mpi_echam5 =</span> <span class="st">&quot;MPIecham5&quot;</span>, <span class="dt">ukmo_hadcm3 =</span> <span class="st">&quot;ukmoHADcm3&quot;</span>)
}

<span class="co"># include later: # rcp45=&#39;RCP 4.5&#39;, rcp60=&#39;RCP 6.0&#39;, rcp85=&#39;RCP 8.5&#39;</span>
swapScenarioName &lt;-<span class="st"> </span>function(x) {
    switch(x, <span class="dt">sresb1 =</span> <span class="st">&quot;SRES B1&quot;</span>, <span class="dt">sresa1b =</span> <span class="st">&quot;SRES A1B&quot;</span>, <span class="dt">sresa2 =</span> <span class="st">&quot;SRES A2&quot;</span>)
}

<span class="co"># include later: # rcp45=&#39;AR5&#39;, rcp60=&#39;AR5&#39;, rcp85=&#39;AR5&#39;</span>
getPhase &lt;-<span class="st"> </span>function(x) {
    switch(x, <span class="dt">sresb1 =</span> <span class="st">&quot;AR4&quot;</span>, <span class="dt">sresa1b =</span> <span class="st">&quot;AR4&quot;</span>, <span class="dt">sresa2 =</span> <span class="st">&quot;AR4&quot;</span>)
}
<span class="kw">paste</span>(<span class="st">&quot;Remaining support objects created. Now pushing objects to slaves.&quot;</span>)</code></pre>
</div>
<div id="send-information-from-head-node-to-cpus-on-compute-nodes" class="section level3">
<h3>Send information from head node to CPUs on compute nodes</h3>
<p>Send <strong>R</strong> objects from master to slaves.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Export objects to slaves</span>
if (Rmpi) {
    <span class="kw">mpi.bcast.Robj2slave</span>(cells)
    <span class="kw">mpi.bcast.Robj2slave</span>(reps)
    <span class="kw">mpi.bcast.Robj2slave</span>(years)
    <span class="kw">mpi.bcast.Robj2slave</span>(mainDirs)
    <span class="kw">mpi.bcast.Robj2slave</span>(modname)
    <span class="kw">mpi.bcast.Robj2slave</span>(ageDir)
    <span class="kw">mpi.bcast.Robj2slave</span>(itervar)
    <span class="kw">mpi.bcast.Robj2slave</span>(loopBy)
    <span class="kw">print</span>(<span class="st">&quot;mpi.bcast.Robj2slave calls completed.&quot;</span>)
}</code></pre>
<p>Send <strong>R</strong> commands from master to slaves.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Issue commands to slaves</span>
if (Rmpi) {
    <span class="kw">mpi.bcast.cmd</span>(mainDir &lt;-<span class="st"> </span>mainDirs[id])
    <span class="kw">mpi.bcast.cmd</span>(<span class="kw">source</span>(<span class="st">&quot;/workspace/UA/mfleonawicz/projects/SNAPQAQC/code/alfresco/alfExtract.R&quot;</span>))
    <span class="kw">mpi.bcast.cmd</span>(<span class="kw">dir.create</span>(tmpDir &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;/big_scratch/mfleonawicz/tmp/proc&quot;</span>, 
        id), <span class="dt">showWarnings =</span> F))
    <span class="kw">mpi.bcast.cmd</span>(<span class="kw">rasterOptions</span>(<span class="dt">chunksize =</span> <span class="fl">1e+11</span>, <span class="dt">maxmemory =</span> <span class="fl">1e+12</span>, <span class="dt">tmpdir =</span> tmpDir))
    <span class="kw">print</span>(<span class="st">&quot;mpi.bcast.cmd calls completed. Now running mpi.remote.exec...&quot;</span>)
} else {
    mainDir &lt;-<span class="st"> </span>mainDirs[<span class="dv">1</span>]
    <span class="kw">source</span>(<span class="st">&quot;/workspace/UA/mfleonawicz/projects/SNAPQAQC/code/alfresco/alfExtract.R&quot;</span>)
    tmpDir &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;/big_scratch/mfleonawicz/tmp/procX&quot;</span>)
    <span class="kw">rasterOptions</span>(<span class="dt">chunksize =</span> <span class="fl">1e+11</span>, <span class="dt">maxmemory =</span> <span class="fl">1e+12</span>, <span class="dt">tmpdir =</span> tmpDir)
}</code></pre>
</div>
<div id="gather-data" class="section level3">
<h3>Gather data</h3>
<p>Extract and compile fire statistics.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Compile fire statistics</span>
if (doFire) {
    <span class="kw">print</span>(<span class="st">&quot;#### Compiling fire statistics... ####&quot;</span>)
    if (Rmpi) {
        fsv.dat &lt;-<span class="st"> </span><span class="kw">mpi.remote.exec</span>(<span class="kw">extract_data</span>(<span class="dt">i =</span> itervar[id], <span class="dt">type =</span> <span class="st">&quot;fsv&quot;</span>, 
            <span class="dt">loopBy =</span> loopBy, <span class="dt">mainDir =</span> mainDir, <span class="dt">reps =</span> reps, <span class="dt">years =</span> years, 
            <span class="dt">cells =</span> <span class="kw">select</span>(cells, -Cell_rmNA)))
        fsv.dat &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(fsv.dat)
    } else {
        len &lt;-<span class="st"> </span><span class="kw">length</span>(itervar)
        if (len &lt;=<span class="st"> </span>n.cores) {
            fsv.dat &lt;-<span class="st"> </span><span class="kw">mclapply</span>(itervar, extract_data, <span class="dt">type =</span> <span class="st">&quot;fsv&quot;</span>, <span class="dt">loopBy =</span> loopBy, 
                <span class="dt">mainDir =</span> mainDir, <span class="dt">reps =</span> reps, <span class="dt">years =</span> years, <span class="dt">cells =</span> <span class="kw">select</span>(cells, 
                  -Cell_rmNA), <span class="dt">mc.cores =</span> n.cores)
            fsv.dat &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(fsv.dat)
        } else {
            serial.iters &lt;-<span class="st"> </span><span class="kw">ceiling</span>(len/n.cores)
            n.cores2 &lt;-<span class="st"> </span><span class="kw">which</span>(len/(<span class="dv">1</span>:n.cores) &lt;<span class="st"> </span>serial.iters)[<span class="dv">1</span>]
            fsv.dat &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="st">&quot;list&quot;</span>, serial.iters)
            for (j in <span class="dv">1</span>:serial.iters) {
                itervar.tmp &lt;-<span class="st"> </span><span class="dv">1</span>:n.cores2 +<span class="st"> </span>(j -<span class="st"> </span><span class="dv">1</span>) *<span class="st"> </span>n.cores2
                itervar.tmp &lt;-<span class="st"> </span>itervar.tmp[itervar.tmp &lt;=<span class="st"> </span><span class="kw">max</span>(itervar)]
                fsv.tmp &lt;-<span class="st"> </span><span class="kw">mclapply</span>(itervar.tmp, extract_data, <span class="dt">type =</span> <span class="st">&quot;fsv&quot;</span>, 
                  <span class="dt">loopBy =</span> loopBy, <span class="dt">mainDir =</span> mainDir, <span class="dt">reps =</span> reps, <span class="dt">years =</span> years, 
                  <span class="dt">cells =</span> <span class="kw">select</span>(cells, -Cell_rmNA), <span class="dt">mc.cores =</span> n.cores)
                fsv.dat[[j]] &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(fsv.tmp)
                <span class="kw">rm</span>(fsv.tmp)
                <span class="kw">gc</span>()
                <span class="kw">print</span>(<span class="kw">paste</span>(<span class="st">&quot;Replicate batch&quot;</span>, j, <span class="st">&quot;of&quot;</span>, serial.iters, <span class="st">&quot;complete.&quot;</span>))
            }
            fsv.dat &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(fsv.dat)
        }
    }
    
    fsv.dat.names.ini &lt;-<span class="st"> </span><span class="kw">copy</span>(<span class="kw">names</span>(fsv.dat))
    fsv.dat[, <span class="st">`</span><span class="dt">:=</span><span class="st">`</span>(Model, <span class="kw">swapModelName</span>(mod.scen[<span class="dv">1</span>]))]
    fsv.dat[, <span class="st">`</span><span class="dt">:=</span><span class="st">`</span>(Scenario, <span class="kw">swapScenarioName</span>(mod.scen[<span class="dv">2</span>]))]
    fsv.dat[, <span class="st">`</span><span class="dt">:=</span><span class="st">`</span>(Scenario, <span class="kw">factor</span>(Scenario, <span class="dt">levels =</span> scen.levels))]
    fsv.dat[, <span class="st">`</span><span class="dt">:=</span><span class="st">`</span>(Phase, <span class="kw">getPhase</span>(mod.scen[<span class="dv">2</span>]))]
    fsv.dat &lt;-<span class="st"> </span><span class="kw">setcolorder</span>(fsv.dat, <span class="kw">c</span>(<span class="st">&quot;Phase&quot;</span>, <span class="st">&quot;Scenario&quot;</span>, <span class="st">&quot;Model&quot;</span>, fsv.dat.names.ini))
    <span class="kw">setkey</span>(fsv.dat, Location)
    
    <span class="kw">print</span>(<span class="st">&quot;Fire size by vegetation class completed.&quot;</span>)
    <span class="kw">print</span>(<span class="st">&quot;Saving fire size by vegetation class data frames by location to .RData file.&quot;</span>)
    locs &lt;-<span class="st"> </span><span class="kw">unique</span>(fsv.dat$Location)
    <span class="kw">dir.create</span>(fsvDir &lt;-<span class="st"> &quot;/big_scratch/mfleonawicz/Rmpi/outputs/fsv&quot;</span>, <span class="dt">recursive =</span> <span class="ot">TRUE</span>, 
        <span class="dt">showWarnings =</span> <span class="ot">FALSE</span>)
    for (j in <span class="dv">1</span>:<span class="kw">length</span>(locs)) {
        filename.tmp &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;fsv__&quot;</span>, locs[j], <span class="st">&quot;__&quot;</span>, modname)
        d.fsv &lt;-<span class="st"> </span>fsv.dat[locs[j]]
        <span class="kw">save</span>(d.fsv, <span class="dt">file =</span> <span class="kw">paste0</span>(fsvDir, <span class="st">&quot;/&quot;</span>, filename.tmp, <span class="st">&quot;.RData&quot;</span>))
        <span class="kw">print</span>(<span class="kw">paste</span>(filename.tmp, <span class="st">&quot;object&quot;</span>, j, <span class="st">&quot;of&quot;</span>, <span class="kw">length</span>(locs), <span class="st">&quot;saved.&quot;</span>))
    }
    <span class="kw">print</span>(<span class="kw">tables</span>())
    <span class="kw">rm</span>(fsv.dat, d.fsv)
    <span class="kw">gc</span>()
}</code></pre>
<p>Extract and compile vegetation class and age statistics.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Compile vegetation class and age statistics</span>
if (doAgeVeg) {
    <span class="kw">print</span>(<span class="st">&quot;#### Compiling vegetation class and age statistics... ####&quot;</span>)
    if (Rmpi) {
        va.dat &lt;-<span class="st"> </span><span class="kw">mpi.remote.exec</span>(<span class="kw">extract_data</span>(<span class="dt">i =</span> itervar[id], <span class="dt">type =</span> <span class="st">&quot;av&quot;</span>, 
            <span class="dt">loopBy =</span> loopBy, <span class="dt">mainDir =</span> mainDir, <span class="dt">ageDir =</span> ageDir, <span class="dt">reps =</span> reps, 
            <span class="dt">years =</span> years, <span class="dt">cells =</span> <span class="kw">select</span>(cells, -Cell)))
        d.area &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">lapply</span>(va.dat, function(x) x$d.area))
        if (mpiBy ==<span class="st"> &quot;year&quot;</span>) 
            d.age &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">lapply</span>(va.dat, function(x) x$d.age))
    } else {
        len &lt;-<span class="st"> </span><span class="kw">length</span>(itervar)
        if (len &lt;=<span class="st"> </span>n.cores) {
            va.dat &lt;-<span class="st"> </span><span class="kw">mclapply</span>(itervar, extract_data, <span class="dt">type =</span> <span class="st">&quot;av&quot;</span>, <span class="dt">loopBy =</span> loopBy, 
                <span class="dt">mainDir =</span> mainDir, <span class="dt">ageDir =</span> ageDir, <span class="dt">reps =</span> reps, <span class="dt">years =</span> years, 
                <span class="dt">cells =</span> <span class="kw">select</span>(cells, -Cell), <span class="dt">mc.cores =</span> n.cores)
            d.area &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">lapply</span>(va.dat, function(x) x$d.area))
            if (mpiBy ==<span class="st"> &quot;year&quot;</span>) 
                d.age &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">lapply</span>(va.dat, function(x) x$d.age))
        } else {
            serial.iters &lt;-<span class="st"> </span><span class="kw">ceiling</span>(len/n.cores)
            n.cores2 &lt;-<span class="st"> </span><span class="kw">which</span>(len/(<span class="dv">1</span>:n.cores) &lt;<span class="st"> </span>serial.iters)[<span class="dv">1</span>]
            d.age &lt;-<span class="st"> </span>d.area &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="st">&quot;list&quot;</span>, serial.iters)
            for (j in <span class="dv">1</span>:serial.iters) {
                itervar.tmp &lt;-<span class="st"> </span><span class="dv">1</span>:n.cores2 +<span class="st"> </span>(j -<span class="st"> </span><span class="dv">1</span>) *<span class="st"> </span>n.cores2
                itervar.tmp &lt;-<span class="st"> </span>itervar.tmp[itervar.tmp &lt;=<span class="st"> </span><span class="kw">max</span>(itervar)]
                va.dat &lt;-<span class="st"> </span><span class="kw">mclapply</span>(itervar.tmp, extract_data, <span class="dt">type =</span> <span class="st">&quot;av&quot;</span>, <span class="dt">loopBy =</span> loopBy, 
                  <span class="dt">mainDir =</span> mainDir, <span class="dt">ageDir =</span> ageDir, <span class="dt">reps =</span> reps, <span class="dt">years =</span> years, 
                  <span class="dt">cells =</span> <span class="kw">select</span>(cells, -Cell), <span class="dt">mc.cores =</span> n.cores)
                d.area[[j]] &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">lapply</span>(va.dat, function(x) x$d.area))
                if (mpiBy ==<span class="st"> &quot;year&quot;</span>) 
                  d.age[[j]] &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">lapply</span>(va.dat, function(x) x$d.age))
                <span class="kw">rm</span>(va.dat)
                <span class="kw">gc</span>()
                <span class="kw">print</span>(<span class="kw">paste</span>(<span class="st">&quot;Replicate batch&quot;</span>, j, <span class="st">&quot;of&quot;</span>, serial.iters, <span class="st">&quot;complete.&quot;</span>))
            }
            d.area &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(d.area)
            if (mpiBy ==<span class="st"> &quot;year&quot;</span>) 
                d.age &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(d.age)
        }
    }
    
    d.area.names.ini &lt;-<span class="st"> </span><span class="kw">copy</span>(<span class="kw">names</span>(d.area))
    d.area[, <span class="st">`</span><span class="dt">:=</span><span class="st">`</span>(Model, <span class="kw">swapModelName</span>(mod.scen[<span class="dv">1</span>]))]
    d.area[, <span class="st">`</span><span class="dt">:=</span><span class="st">`</span>(Scenario, <span class="kw">swapScenarioName</span>(mod.scen[<span class="dv">2</span>]))]
    d.area[, <span class="st">`</span><span class="dt">:=</span><span class="st">`</span>(Scenario, <span class="kw">factor</span>(Scenario, <span class="dt">levels =</span> scen.levels))]
    d.area[, <span class="st">`</span><span class="dt">:=</span><span class="st">`</span>(Phase, <span class="kw">getPhase</span>(mod.scen[<span class="dv">2</span>]))]
    d.area &lt;-<span class="st"> </span><span class="kw">setcolorder</span>(d.area, <span class="kw">c</span>(<span class="st">&quot;Phase&quot;</span>, <span class="st">&quot;Scenario&quot;</span>, <span class="st">&quot;Model&quot;</span>, d.area.names.ini))
    <span class="kw">setkey</span>(d.area, Location)
    <span class="kw">print</span>(<span class="st">&quot;Vegetation area completed.&quot;</span>)
    <span class="kw">print</span>(<span class="st">&quot;Saving vegetation area data tables by location to .RData files.&quot;</span>)
    locs &lt;-<span class="st"> </span><span class="kw">unique</span>(d.area$Location)
    <span class="kw">dir.create</span>(vegDir &lt;-<span class="st"> &quot;/big_scratch/mfleonawicz/Rmpi/outputs/veg&quot;</span>, <span class="dt">showWarnings =</span> F)
    
    for (j in <span class="dv">1</span>:<span class="kw">length</span>(locs)) {
        filename.tmp &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;veg__&quot;</span>, locs[j], <span class="st">&quot;__&quot;</span>, modname)
        d.vegarea &lt;-<span class="st"> </span>d.area[locs[j]]
        <span class="kw">save</span>(d.vegarea, <span class="dt">file =</span> <span class="kw">paste0</span>(vegDir, <span class="st">&quot;/&quot;</span>, filename.tmp, <span class="st">&quot;.RData&quot;</span>))
        <span class="kw">print</span>(<span class="kw">paste</span>(filename.tmp, <span class="st">&quot;object&quot;</span>, j, <span class="st">&quot;of&quot;</span>, <span class="kw">length</span>(locs), <span class="st">&quot;saved.&quot;</span>))
    }
    <span class="kw">print</span>(<span class="kw">tables</span>())
    <span class="kw">rm</span>(d.area, d.vegarea)
    <span class="kw">gc</span>()
    
    if (mpiBy ==<span class="st"> &quot;year&quot;</span>) {
        d.age.names.ini &lt;-<span class="st"> </span><span class="kw">copy</span>(<span class="kw">names</span>(d.age))
        d.age[, <span class="st">`</span><span class="dt">:=</span><span class="st">`</span>(Model, <span class="kw">swapModelName</span>(mod.scen[<span class="dv">1</span>]))]
        d.age[, <span class="st">`</span><span class="dt">:=</span><span class="st">`</span>(Scenario, <span class="kw">swapScenarioName</span>(mod.scen[<span class="dv">2</span>]))]
        d.age[, <span class="st">`</span><span class="dt">:=</span><span class="st">`</span>(Scenario, <span class="kw">factor</span>(Scenario, <span class="dt">levels =</span> scen.levels))]
        d.age[, <span class="st">`</span><span class="dt">:=</span><span class="st">`</span>(Phase, <span class="kw">getPhase</span>(mod.scen[<span class="dv">2</span>]))]
        d.age &lt;-<span class="st"> </span><span class="kw">setcolorder</span>(d.age, <span class="kw">c</span>(<span class="st">&quot;Phase&quot;</span>, <span class="st">&quot;Scenario&quot;</span>, <span class="st">&quot;Model&quot;</span>, d.age.names.ini))
        <span class="kw">setkey</span>(d.age, Location)
        <span class="kw">print</span>(<span class="st">&quot;Vegetation area by age completed.&quot;</span>)
        <span class="kw">print</span>(<span class="st">&quot;Saving vegetation area by age data tables by location to .RData files.&quot;</span>)
        locs &lt;-<span class="st"> </span><span class="kw">unique</span>(d.age$Location)
        <span class="kw">dir.create</span>(ageDir &lt;-<span class="st"> &quot;/big_scratch/mfleonawicz/Rmpi/outputs/age&quot;</span>, <span class="dt">showWarnings =</span> F)
        
        for (j in <span class="dv">1</span>:<span class="kw">length</span>(locs)) {
            filename.tmp &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;age__&quot;</span>, locs[j], <span class="st">&quot;__&quot;</span>, modname)
            d.vegage &lt;-<span class="st"> </span>d.age[locs[j]]
            <span class="kw">save</span>(d.vegage, <span class="dt">file =</span> <span class="kw">paste0</span>(ageDir, <span class="st">&quot;/&quot;</span>, filename.tmp, <span class="st">&quot;.RData&quot;</span>))
            <span class="kw">print</span>(<span class="kw">paste</span>(filename.tmp, <span class="st">&quot;object&quot;</span>, j, <span class="st">&quot;of&quot;</span>, <span class="kw">length</span>(locs), <span class="st">&quot;saved.&quot;</span>))
        }
        <span class="kw">print</span>(<span class="kw">tables</span>())
        <span class="kw">rm</span>(d.age, d.vegage)
        <span class="kw">gc</span>()
    }
}

<span class="co"># All done</span>
if (Rmpi) {
    <span class="kw">mpi.close.Rslaves</span>(<span class="dt">dellog =</span> <span class="ot">FALSE</span>)
    <span class="kw">mpi.exit</span>()
}</code></pre>
</div>
</div>

<!-- some extra javascript for older browsers -->
<script type="text/javascript" src="libs/polyfill.js"></script>
<script>
  // manage active state of menu based on current page
  $(document).ready(function () {
  
    // active menu
    href = window.location.pathname
    href = href.substr(href.lastIndexOf('/') + 1)
    $('a[href="' + href + '"]').parent().addClass('active');
    
    // manage active menu header
    if (href.startsWith('authoring_'))
      $('a[href="' + 'authoring' + '"]').parent().addClass('active');
    else if (href.endsWith('_format.html'))
      $('a[href="' + 'formats' + '"]').parent().addClass('active');
    else if (href.startsWith('developer_'))
      $('a[href="' + 'developer' + '"]').parent().addClass('active');
	  
  });
</script>

</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>


</body>
</html>
