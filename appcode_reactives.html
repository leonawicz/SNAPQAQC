<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />



<title></title>

<script src="libs/jquery-1.11.0/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.1/css/united.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.1/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/respond.min.js"></script>
<style type="text/css">
/* padding for bootstrap navbar */
body {
padding-top: 50px;
padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar) */
.section h2 {
padding-top: 55px;
margin-top: -55px;
}
.section h3 {
padding-top: 55px;
margin-top: -55px;
}
/* don't use link color in navbar */
.dropdown-menu>li>a {
color: black;
}
/* some padding for disqus */
#disqus_thread {
margin-top: 45px;
}
p {
  text-align: justify;
}
img.centered {
  display: block;
  margin-left: auto;
  margin-right: auto;
}
</style>
<link rel="stylesheet" href="libs/font-awesome-4.1.0/css/font-awesome.min.css"/>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; background-color: #303030; color: #cccccc; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; }
td.sourceCode { padding-left: 5px; }
pre, code { color: #cccccc; background-color: #303030; }
code > span.kw { color: #f0dfaf; }
code > span.dt { color: #dfdfbf; }
code > span.dv { color: #dcdccc; }
code > span.bn { color: #dca3a3; }
code > span.fl { color: #c0bed1; }
code > span.ch { color: #dca3a3; }
code > span.st { color: #cc9393; }
code > span.co { color: #7f9f7f; }
code > span.ot { color: #efef8f; }
code > span.al { color: #ffcfaf; }
code > span.fu { color: #efef8f; }
code > span.er { color: #c3bf9f; }
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>



<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-46129458-3', 'auto');
  ga('send', 'pageview');

</script>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img { 
  max-width:100%; 
  height: auto; 
}
</style>
<div class="container-fluid main-container">

<div class="navbar navbar-default navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">SNAP Data QA/QC</a>
      </div>
      <div class="navbar-collapse collapse navbar-responsive-collapse">
        <ul class="nav navbar-nav">
          <li><a href="index.html">Overview</a></li>

          <li class="dropdown">
            <a href="climate" class="dropdown-toggle" data-toggle="dropdown">Climate <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li class="dropdown-header">Extraction</li>
              <li><a href="AR4_AR5_extract.html">Downscaled GCMs</a></li>
              <li><a href="CRU_extract.html">Downscaled CRU 3.x</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">GCM organization</li>
              <li><a href="stats_setup.html">Regions: stats</a></li>
              <li><a href="samples_setup.html">Regions: densities</a></li>
              <li><a href="cities_setup.html">Cities: stats</a></li>
              <li class="dropdown-header">CRU organization</li>
              <li><a href="stats_setup_CRU.html">Regions: stats</a></li>
              <li><a href="samples_setup_CRU.html">Regions: densities</a></li>
              <li><a href="cities_setup_CRU.html">Cities: stats</a></li>
            </ul>

          <li class="dropdown">
            <a href="fire-&-veg" class="dropdown-toggle" data-toggle="dropdown">Fire & Veg <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li class="dropdown-header">Extraction</li>
              <li><a href="alfStatsByRep_Rmpi.html">ALFRESCO: Rmpi</a></li>
              <li><a href="alfStatsByRep.html">ALFRESCO: functions</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">Organization</li>
              <li><a href="getAlfStatsAndDensities.html">ALFRESCO: stats and densities</a></li>
            </ul>

          <li class="dropdown">
            <a href="app-docs" class="dropdown-toggle" data-toggle="dropdown">App docs <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li><a href="aboutapp.html">About</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">Help documents</li>
              <li><a href="help01_start.html">Getting started</a></li>
              <li><a href="help02_data.html">Working with data</a></li>
              <li><a href="help03_plotOptions.html">Graphical options</a></li>
              <li><a href="help04_updating.html">Updating settings</a></li>
              <li><a href="help05_01_graphTS.html">Graphing: time series</a></li>
              <li><a href="help05_02_graphScatter.html">Graphing: scatter plots</a></li>
              <li><a href="help05_03_graphHeat.html">Graphing: heat maps</a></li>
              <li><a href="help05_04_graphVar.html">Graphing: variability</a></li>
              <li><a href="help05_05_graphSpatial.html">Graphing: distributions</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">Prep R code</li>
              <li><a href="qaqc_app_metadata.html">QA/QC App Metadata</a></li>
            </ul>

          <li class="dropdown">
            <a href="app-code" class="dropdown-toggle" data-toggle="dropdown">App code <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li class="dropdown-header">App R code</li>
              <li><a href="appcode_global.html">global.R</a></li>
              <li><a href="appcode_ui.html">ui.R</a></li>
              <li><a href="appcode_server.html">server.R</a></li>
              <li><a href="appcode_about.html">about.R</a></li>
              <li class="divider"></li>
              <li><a href="appcode_sidebar.html">sidebar.R</a></li>
              <li><a href="appcode_main.html">main.R</a></li>
              <li><a href="appcode_serverHead.html">serverHead.R</a></li>
              <li><a href="appcode_app.html">app.R</a></li>
              <li class="divider"></li>
              <li><a href="appcode_io_sidebar.html">io_sidebar.R</a></li>
              <li><a href="appcode_io_main.html">io_main.R</a></li>
              <li><a href="appcode_reactives.html">reactives.R</a></li>
              <li class="divider"></li>
              <li><a href="appcode_plot_ts.html">plot_ts.R</a></li>
              <li><a href="appcode_plot_scatter.html">plot_scatter.R</a></li>
              <li><a href="appcode_plot_heatmap.html">plot_heatmap.R</a></li>
              <li><a href="appcode_plot_variability.html">plot_variability.R</a></li>
              <li><a href="appcode_plot_spatial.html">plot_spatial.R</a></li>
            </ul>

          <li><a href="http://leonawicz.github.io">All Projects</a></li>
        </ul>
        <ul class="nav navbar-nav navbar-right">
          <a class="btn btn-link" href="https://github.com/leonawicz/SNAPQAQC">
            <i class="fa fa-github fa-lg"></i>
            Github
          </a>
        </ul>
      </div><!--/.nav-collapse -->
    </div>
  </div>



<div id="section" class="section level2">
<h2></h2>
</div>
<div id="section-1" class="section level2">
<h2></h2>
</div>
<div id="snap-data-qaqc-shiny-app-r-code" class="section level2">
<h2>SNAP data QA/QC Shiny app R code</h2>
<p>The <code>reactives.R</code> script is sourced by <code>app.R</code> which is in turn sourced by <code>server.R</code>. This script contains strict server-side reactive expressions.</p>
<div id="reactives.r" class="section level3">
<h3>reactives.R</h3>
<div id="button-status" class="section level4">
<h4>Button status</h4>
<pre class="sourceCode r"><code class="sourceCode r">goBtnNullOrZero &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">nullOrZero</span>(input$goButton)
})

twoBtnNullOrZero_ts &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">goBtnNullOrZero</span>() ||<span class="st"> </span><span class="kw">nullOrZero</span>(input$plotButton_ts)
})

twoBtnNullOrZero_sc &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">goBtnNullOrZero</span>() ||<span class="st"> </span><span class="kw">nullOrZero</span>(input$plotButton_sc)
})

twoBtnNullOrZero_hm &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">goBtnNullOrZero</span>() ||<span class="st"> </span><span class="kw">nullOrZero</span>(input$plotButton_hm)
})

twoBtnNullOrZero_vr &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">goBtnNullOrZero</span>() ||<span class="st"> </span><span class="kw">nullOrZero</span>(input$plotButton_vr)
})

twoBtnNullOrZero_sp &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">goBtnNullOrZero</span>() ||<span class="st"> </span><span class="kw">nullOrZero</span>(input$plotButton_sp)
})

<span class="co"># anyBtnNullOrZero &lt;- reactive({ any(c(goBtnNullOrZero(),</span>
<span class="co"># twoBtnNullOrZero_ts(), twoBtnNullOrZero_ts(), twoBtnNullOrZero_ts(),</span>
<span class="co"># twoBtnNullOrZero_ts(), twoBtnNullOrZero_ts())) })</span></code></pre>
</div>
<div id="time-months-seasons-years-decades-and-long-term-periods" class="section level4">
<h4>Time: months, seasons, years, decades, and long-term periods</h4>
<pre class="sourceCode r"><code class="sourceCode r">Decades_original &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    x &lt;-<span class="st"> </span>input$decs
    if (!<span class="kw">length</span>(x)) 
        x &lt;-<span class="st"> </span>decades
    x
})

currentYears &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    if (!<span class="kw">is.null</span>(input$yrs)) 
        <span class="kw">as.numeric</span>(input$yrs[<span class="dv">1</span>]):<span class="kw">as.numeric</span>(input$yrs[<span class="dv">2</span>])
})

Months_original &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    x &lt;-<span class="st"> </span>input$mos
    if (!<span class="kw">length</span>(x)) 
        x &lt;-<span class="st"> </span>month.abb
    x
})

Decades &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    x &lt;-<span class="st"> </span><span class="kw">Decades_original</span>()
    if (!<span class="kw">is.null</span>(input$decades2periods)) {
        if (input$decades2periods &amp;<span class="st"> </span>!<span class="kw">is.null</span>(<span class="kw">dat_master</span>())) 
            x &lt;-<span class="st"> </span><span class="kw">unique</span>(<span class="kw">dat_master</span>()$Decade)
    }
    x
})

limitedYears &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    rng &lt;-<span class="st"> </span><span class="kw">range</span>(<span class="kw">as.numeric</span>(<span class="kw">substr</span>(<span class="kw">Decades</span>(), <span class="dv">1</span>, <span class="dv">4</span>))) +<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">9</span>)
    yrs &lt;-<span class="st"> </span><span class="kw">intersect</span>(<span class="kw">currentYears</span>(), <span class="kw">seq</span>(rng[<span class="dv">1</span>], rng[<span class="dv">2</span>]))
    yrs
})

Months &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    x &lt;-<span class="st"> </span><span class="kw">Months_original</span>()
    if (!<span class="kw">is.null</span>(input$months2seasons)) {
        if (input$months2seasons &amp;<span class="st"> </span>!<span class="kw">is.null</span>(<span class="kw">dat_master</span>())) 
            x &lt;-<span class="st"> </span><span class="kw">unique</span>(<span class="kw">as.character</span>(<span class="kw">dat_master</span>()$Month))
    }
    x
})

SeasonLength &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    if (<span class="kw">length</span>(input$mos) &lt;=<span class="st"> </span><span class="dv">1</span>) 
        <span class="ot">NULL</span> else <span class="kw">periodLength</span>(<span class="dt">x =</span> <span class="kw">match</span>(input$mos, month.abb))
})


PeriodLength &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    if (<span class="kw">length</span>(input$decs) &lt;=<span class="st"> </span><span class="dv">1</span>) 
        <span class="ot">NULL</span> else <span class="kw">periodLength</span>(<span class="dt">x =</span> <span class="kw">as.numeric</span>(<span class="kw">substr</span>(input$decs, <span class="dv">1</span>, <span class="dv">4</span>))/<span class="dv">10</span>)
})</code></pre>
</div>
<div id="models-scenarios-pair-logicals-and-composites" class="section level4">
<h4>Models, scenarios, pair logicals, and composites</h4>
<pre class="sourceCode r"><code class="sourceCode r">modelScenPair1 &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    if (<span class="kw">length</span>(input$cmip3scens) &amp;<span class="st"> </span><span class="kw">length</span>(input$cmip3models)) 
        <span class="ot">TRUE</span> else <span class="ot">FALSE</span>
})

modelScenPair2 &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    if (<span class="kw">length</span>(input$cmip5scens) &amp;<span class="st"> </span><span class="kw">length</span>(input$cmip5models)) 
        <span class="ot">TRUE</span> else <span class="ot">FALSE</span>
})

allModelScenPair &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    if (<span class="kw">modelScenPair1</span>() &amp;<span class="st"> </span><span class="kw">modelScenPair2</span>()) 
        <span class="ot">TRUE</span> else <span class="ot">FALSE</span>
})

anyModelScenPair &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    if (<span class="kw">modelScenPair1</span>() |<span class="st"> </span><span class="kw">modelScenPair2</span>()) 
        <span class="ot">TRUE</span> else <span class="ot">FALSE</span>
})

scenarios &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    x &lt;-<span class="st"> </span><span class="kw">c</span>()
    if (!<span class="kw">is.null</span>(input$cmip3scens)) 
        x &lt;-<span class="st"> </span>input$cmip3scens
    if (!<span class="kw">is.null</span>(input$cmip5scens)) 
        x &lt;-<span class="st"> </span><span class="kw">c</span>(x, input$cmip5scens)
    ind &lt;-<span class="st"> </span><span class="kw">which</span>(x ==<span class="st"> &quot;&quot;</span>)
    if (<span class="kw">length</span>(ind)) 
        x &lt;-<span class="st"> </span>x[-ind]
    if (!<span class="kw">length</span>(x)) 
        x &lt;-<span class="st"> </span><span class="ot">NULL</span>
    x
})

models_original &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    x &lt;-<span class="st"> </span><span class="kw">c</span>()
    if (!<span class="kw">is.null</span>(input$cmip3models)) 
        x &lt;-<span class="st"> </span>input$cmip3models
    if (!<span class="kw">is.null</span>(input$cmip5models)) 
        x &lt;-<span class="st"> </span><span class="kw">c</span>(x, input$cmip5models)
    ind &lt;-<span class="st"> </span><span class="kw">which</span>(x ==<span class="st"> &quot;&quot;</span>)
    if (<span class="kw">length</span>(ind)) 
        x &lt;-<span class="st"> </span>x[-ind]
    if (!<span class="kw">length</span>(x)) 
        x &lt;-<span class="st"> </span><span class="ot">NULL</span>
    x
})

models &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    x &lt;-<span class="st"> </span><span class="kw">models_original</span>()
    if (!<span class="kw">is.null</span>(input$compositeModel)) {
        if (input$compositeModel &amp;<span class="st"> </span>!<span class="kw">is.null</span>(<span class="kw">dat_master</span>())) 
            x &lt;-<span class="st"> </span><span class="kw">unique</span>(<span class="kw">dat_master</span>()$Model)
    }
    x
})

composite &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    x &lt;-<span class="st"> </span><span class="ot">FALSE</span>
    comp &lt;-<span class="st"> </span>input$compositeModel
    if (!<span class="kw">is.null</span>(comp)) {
        l1 &lt;-<span class="st"> </span><span class="kw">length</span>(input$cmip3models)
        l2 &lt;-<span class="st"> </span><span class="kw">length</span>(input$cmip5models)
        if (comp &amp;<span class="st"> </span>((<span class="kw">modelScenPair1</span>() &amp;<span class="st"> </span>l1 &gt;<span class="st"> </span><span class="dv">1</span>) |<span class="st"> </span>(<span class="kw">modelScenPair2</span>() &amp;<span class="st"> </span>l2 &gt;<span class="st"> </span><span class="dv">1</span>)) &amp;<span class="st"> </span>
<span class="st">            </span>!<span class="kw">allModelScenPair</span>()) {
            x &lt;-<span class="st"> </span><span class="dv">1</span>
        } else if (l1 &gt;<span class="st"> </span><span class="dv">1</span> &amp;<span class="st"> </span>l2 &gt;<span class="st"> </span><span class="dv">1</span> &amp;<span class="st"> </span><span class="kw">allModelScenPair</span>()) {
            if (l1 ==<span class="st"> </span>l2 &amp;<span class="st"> </span>comp) 
                x &lt;-<span class="st"> </span><span class="dv">2</span>
        }
    }
    x
})</code></pre>
</div>
<div id="units-statistics-and-bootstrap-sample-sizes" class="section level4">
<h4>Units, statistics, and bootstrap sample sizes</h4>
<pre class="sourceCode r"><code class="sourceCode r">currentUnits &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    if (input$convert_units) 
        <span class="kw">c</span>(<span class="st">&quot;F&quot;</span>, <span class="st">&quot;in&quot;</span>) else <span class="kw">c</span>(<span class="st">&quot;C&quot;</span>, <span class="st">&quot;mm&quot;</span>)
})

aggStatsID &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    agg.stat.colnames[<span class="kw">which</span>(agg.stat.names ==<span class="st"> </span>input$aggStats)]
})

aggStatsID2 &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    agg.stat.colnames[<span class="kw">which</span>(agg.stat.names ==<span class="st"> </span>input$aggStats2)]
})

BootSamples &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    x &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(input$bootSamples)
    if (<span class="kw">is.na</span>(x) ||<span class="st"> </span>x &gt;<span class="st"> </span><span class="dv">10000</span>) 
        x &lt;-<span class="st"> </span><span class="dv">50</span>
    x
})</code></pre>
</div>
<div id="geographic-locations" class="section level4">
<h4>Geographic locations</h4>
<pre class="sourceCode r"><code class="sourceCode r">Locs &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    if (<span class="kw">is.null</span>(input$loctype) ||<span class="st"> </span>input$loctype !=<span class="st"> &quot;Cities&quot;</span>) 
        input$locs_regions else if (input$loctype ==<span class="st"> &quot;Cities&quot;</span>) 
        input$locs_cities else <span class="ot">NULL</span>
})

regionSelected &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    input$loctype !=<span class="st"> &quot;Cities&quot;</span> &amp;<span class="st"> </span><span class="kw">length</span>(<span class="kw">Locs</span>())
})

citySelected &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    input$loctype ==<span class="st"> &quot;Cities&quot;</span> &amp;<span class="st"> </span><span class="kw">length</span>(<span class="kw">Locs</span>())
})

locSelected &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">length</span>(<span class="kw">Locs</span>())
})</code></pre>
</div>
<div id="plot-annotations-and-plot-permission-check" class="section level4">
<h4>Plot annotations and plot permission check</h4>
<pre class="sourceCode r"><code class="sourceCode r">plot_ts_title &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">getPlotTitle</span>(<span class="dt">grp =</span> input$group, <span class="dt">facet =</span> input$facet, <span class="dt">pooled =</span> <span class="kw">pooled.var</span>(), 
        <span class="dt">yrs =</span> <span class="kw">range</span>(<span class="kw">limitedYears</span>()), <span class="dt">mos =</span> input$mos, <span class="dt">mod =</span> <span class="kw">models</span>(), <span class="dt">scen =</span> <span class="kw">scenarios</span>(), 
        <span class="dt">loc =</span> <span class="kw">Locs</span>())
})
plot_sp_title &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">getPlotTitle</span>(<span class="dt">grp =</span> input$group2, <span class="dt">facet =</span> input$facet2, <span class="dt">pooled =</span> <span class="kw">pooled.var2</span>(), 
        <span class="dt">yrs =</span> <span class="kw">range</span>(<span class="kw">limitedYears</span>()), <span class="dt">mos =</span> input$mos, <span class="dt">mod =</span> <span class="kw">models</span>(), <span class="dt">scen =</span> <span class="kw">scenarios</span>(), 
        <span class="dt">loc =</span> <span class="kw">Locs</span>())
})
plot_hm_title &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">getPlotTitle</span>(<span class="dt">grp =</span> <span class="st">&quot;&quot;</span>, <span class="dt">facet =</span> input$facetHeatmap, <span class="dt">pooled =</span> <span class="kw">pooledVarHeatmap</span>(), 
        <span class="dt">yrs =</span> <span class="kw">range</span>(<span class="kw">limitedYears</span>()), <span class="dt">mos =</span> input$mos, <span class="dt">mod =</span> <span class="kw">models</span>(), <span class="dt">scen =</span> <span class="kw">scenarios</span>(), 
        <span class="dt">loc =</span> <span class="kw">Locs</span>())
})
plot_var_title &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">getPlotTitle</span>(<span class="dt">grp =</span> input$group3, <span class="dt">facet =</span> input$facet3, <span class="dt">pooled =</span> <span class="kw">pooled.var3</span>(), 
        <span class="dt">yrs =</span> <span class="kw">range</span>(<span class="kw">limitedYears</span>()), <span class="dt">mos =</span> input$mos, <span class="dt">mod =</span> <span class="kw">models</span>(), <span class="dt">scen =</span> <span class="kw">scenarios</span>(), 
        <span class="dt">loc =</span> <span class="kw">Locs</span>())
})
plot_spatial_title &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">getPlotTitle</span>(<span class="dt">grp =</span> input$groupSpatial, <span class="dt">facet =</span> input$facetSpatial, <span class="dt">pooled =</span> <span class="kw">pooledVarSpatial</span>(), 
        <span class="dt">yrs =</span> <span class="kw">range</span>(<span class="kw">limitedYears</span>()), <span class="dt">mos =</span> input$mos, <span class="dt">mod =</span> <span class="kw">models</span>(), <span class="dt">scen =</span> <span class="kw">scenarios</span>(), 
        <span class="dt">loc =</span> <span class="kw">Locs</span>())
})

plot_ts_subtitle &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">getPlotSubTitle</span>(<span class="dt">pooled =</span> <span class="kw">pooled.var</span>(), <span class="dt">yrs =</span> <span class="kw">limitedYears</span>(), <span class="dt">mos =</span> input$mos, 
        <span class="dt">mod =</span> <span class="kw">models</span>(), <span class="dt">scen =</span> <span class="kw">scenarios</span>(), <span class="dt">loc =</span> <span class="kw">Locs</span>())
})
plot_sp_subtitle &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">getPlotSubTitle</span>(<span class="dt">pooled =</span> <span class="kw">pooled.var2</span>(), <span class="dt">yrs =</span> <span class="kw">limitedYears</span>(), <span class="dt">mos =</span> input$mos, 
        <span class="dt">mod =</span> <span class="kw">models</span>(), <span class="dt">scen =</span> <span class="kw">scenarios</span>(), <span class="dt">loc =</span> <span class="kw">Locs</span>())
})
plot_hm_subtitle &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">getPlotSubTitle</span>(<span class="dt">pooled =</span> <span class="kw">pooledVarHeatmap</span>(), <span class="dt">yrs =</span> <span class="kw">limitedYears</span>(), <span class="dt">mos =</span> input$mos, 
        <span class="dt">mod =</span> <span class="kw">models</span>(), <span class="dt">scen =</span> <span class="kw">scenarios</span>(), <span class="dt">loc =</span> <span class="kw">Locs</span>())
})
plot_var_subtitle &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">getPlotSubTitle</span>(<span class="dt">pooled =</span> <span class="kw">pooled.var3</span>(), <span class="dt">yrs =</span> <span class="kw">limitedYears</span>(), <span class="dt">mos =</span> input$mos, 
        <span class="dt">mod =</span> <span class="kw">models</span>(), <span class="dt">scen =</span> <span class="kw">scenarios</span>(), <span class="dt">loc =</span> <span class="kw">Locs</span>())
})
plot_spatial_subtitle &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">getPlotSubTitle</span>(<span class="dt">pooled =</span> <span class="kw">pooledVarSpatial</span>(), <span class="dt">yrs =</span> <span class="kw">limitedYears</span>(), <span class="dt">mos =</span> input$mos, 
        <span class="dt">mod =</span> <span class="kw">models</span>(), <span class="dt">scen =</span> <span class="kw">scenarios</span>(), <span class="dt">loc =</span> <span class="kw">Locs</span>())
})

permitPlot &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    if (!(<span class="kw">is.null</span>(<span class="kw">Months</span>()) |<span class="st"> </span><span class="kw">is.null</span>(<span class="kw">currentYears</span>()) |<span class="st"> </span><span class="kw">is.null</span>(<span class="kw">Decades</span>()) |<span class="st"> </span>
<span class="st">        </span><span class="kw">is.null</span>(input$vars) |<span class="st"> </span><span class="kw">is.null</span>(input$convert_units) |<span class="st"> </span><span class="kw">is.null</span>(<span class="kw">scenarios</span>()) |<span class="st"> </span>
<span class="st">        </span><span class="kw">is.null</span>(<span class="kw">models</span>()) |<span class="st"> </span>(!<span class="kw">length</span>(<span class="kw">Locs</span>()) &amp;&amp;<span class="st"> </span>!<span class="kw">length</span>(input$locs_cities)))) {
        if (input$vars[<span class="dv">1</span>] !=<span class="st"> &quot;&quot;</span> &amp;<span class="st"> </span><span class="kw">anyModelScenPair</span>()) {
            x &lt;-<span class="st"> </span><span class="ot">TRUE</span>
        } else {
            x &lt;-<span class="st"> </span><span class="ot">FALSE</span>
        }
    } else x &lt;-<span class="st"> </span><span class="ot">FALSE</span>
    x
})</code></pre>
</div>
<div id="master-gcm-data-set" class="section level4">
<h4>Master GCM data set</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Initially retain all climate variables regardless of user&#39;s selection</span>
dat_master &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    if (<span class="kw">goBtnNullOrZero</span>()) 
        <span class="kw">return</span>()
    prog_d_master &lt;-<span class="st"> </span>Progress$<span class="kw">new</span>(session, <span class="dt">min =</span> <span class="dv">0</span>, <span class="dt">max =</span> <span class="dv">10</span>)
    <span class="kw">on.exit</span>(prog_d_master$<span class="kw">close</span>())
    <span class="kw">isolate</span>(if (<span class="kw">is.null</span>(<span class="kw">Months_original</span>()) |<span class="st"> </span><span class="kw">is.null</span>(input$vars) |<span class="st"> </span><span class="kw">is.null</span>(<span class="kw">scenarios</span>()) |<span class="st"> </span>
<span class="st">        </span><span class="kw">is.null</span>(<span class="kw">models_original</span>()) |<span class="st"> </span><span class="kw">locSelected</span>() ==<span class="st"> </span><span class="ot">FALSE</span>) {
        x &lt;-<span class="st"> </span><span class="ot">NULL</span>
    } else {
        prog_d_master$<span class="kw">set</span>(<span class="dt">message =</span> <span class="st">&quot;Loading GCM aggregate time series statistics...&quot;</span>, 
            <span class="dt">value =</span> <span class="dv">1</span>)
        if (input$loctype ==<span class="st"> &quot;Cities&quot;</span> &amp;&amp;<span class="st"> </span><span class="kw">length</span>(input$locs_cities) &amp;&amp;<span class="st"> </span>input$locs_cities[<span class="dv">1</span>] !=<span class="st"> </span>
<span class="st">            &quot;&quot;</span>) {
            city.ind &lt;-<span class="st"> </span><span class="kw">which</span>(city.names %in%<span class="st"> </span><span class="kw">Locs</span>())
            for (i in <span class="dv">1</span>:<span class="kw">length</span>(city.ind)) {
                <span class="co"># still must subset city.gcm.files to specific resolution (2-km or</span>
                <span class="co"># 10-minute), and below for CRU, perhaps make a reactive variable to store</span>
                <span class="co"># the subset outside this reactive</span>
                <span class="kw">load</span>(city.gcm.files[city.ind[i]], <span class="dt">envir =</span> <span class="kw">environment</span>())
                if (i ==<span class="st"> </span><span class="dv">1</span>) 
                  city.dat.final &lt;-<span class="st"> </span>city.dat else city.dat.final &lt;-<span class="st"> </span><span class="kw">rbind</span>(city.dat.final, city.dat)
            }
            prog_d_master$<span class="kw">set</span>(<span class="dt">message =</span> <span class="st">&quot;Subsetting GCM time series data...&quot;</span>, 
                <span class="dt">value =</span> <span class="fl">2.5</span>)
            x &lt;-<span class="st"> </span><span class="kw">subset</span>(city.dat.final, Month %in%<span class="st"> </span>month.abb[<span class="kw">match</span>(<span class="kw">Months_original</span>(), 
                month.abb)] &amp;<span class="st"> </span>Year %in%<span class="st"> </span><span class="kw">currentYears</span>() &amp;<span class="st"> </span>Decade %in%<span class="st"> </span><span class="kw">substr</span>(<span class="kw">Decades_original</span>(), 
                <span class="dv">1</span>, <span class="dv">4</span>) &amp;<span class="st"> </span>Scenario %in%<span class="st"> </span><span class="kw">scenarios</span>() &amp;<span class="st"> </span>Model %in%<span class="st"> </span><span class="kw">models_original</span>() &amp;<span class="st"> </span>
<span class="st">                </span>Location %in%<span class="st"> </span>input$locs_cities)
        } else if (input$loctype !=<span class="st"> &quot;Cities&quot;</span>) {
            reg.nam &lt;-<span class="st"> </span><span class="kw">sort</span>(region.names.out[[input$loctype]])
            region.ind &lt;-<span class="st"> </span><span class="kw">which</span>(reg.nam %in%<span class="st"> </span><span class="kw">Locs</span>())
            for (i in <span class="dv">1</span>:<span class="kw">length</span>(region.ind)) {
                filename &lt;-<span class="st"> </span>switch(input$vars[<span class="dv">1</span>], <span class="dt">Temperature =</span> <span class="st">&quot;stats_climate&quot;</span>, 
                  <span class="dt">Precipitation =</span> <span class="st">&quot;stats_climate&quot;</span>)
                <span class="kw">load</span>(<span class="kw">paste0</span>(region.gcm.stats.files[[input$loctype]][region.ind[i]], 
                  <span class="st">&quot;/&quot;</span>, filename, <span class="st">&quot;.RData&quot;</span>), <span class="dt">envir =</span> <span class="kw">environment</span>())  <span class="co"># Still can only load onevariable file, okay as long as app only contains T &amp; P</span>
                gcm.stats.df[, stats.columns] &lt;-<span class="st"> </span>region.dat
                gcm.stats.df$Location &lt;-<span class="st"> </span>reg.nam[region.ind[i]]
                if (i ==<span class="st"> </span><span class="dv">1</span>) 
                  region.dat.final &lt;-<span class="st"> </span>gcm.stats.df else region.dat.final &lt;-<span class="st"> </span><span class="kw">rbind</span>(region.dat.final, gcm.stats.df)
            }
            prog_d_master$<span class="kw">set</span>(<span class="dt">message =</span> <span class="st">&quot;Subsetting GCM time series data...&quot;</span>, 
                <span class="dt">value =</span> <span class="fl">2.5</span>)
            stat &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">aggStatsID</span>(), <span class="kw">aggStatsID2</span>())
            cols.drop &lt;-<span class="st"> </span><span class="kw">match</span>(agg.stat.colnames[<span class="kw">which</span>(!(agg.stat.colnames %in%<span class="st"> </span>
<span class="st">                </span>stat))], <span class="kw">names</span>(region.dat.final))
            x &lt;-<span class="st"> </span><span class="kw">subset</span>(region.dat.final, Month %in%<span class="st"> </span>month.abb[<span class="kw">match</span>(<span class="kw">Months_original</span>(), 
                month.abb)] &amp;<span class="st"> </span>Year %in%<span class="st"> </span><span class="kw">currentYears</span>() &amp;<span class="st"> </span>Decade %in%<span class="st"> </span><span class="kw">substr</span>(<span class="kw">Decades_original</span>(), 
                <span class="dv">1</span>, <span class="dv">4</span>) &amp;<span class="st"> </span>Scenario %in%<span class="st"> </span><span class="kw">scenarios</span>() &amp;<span class="st"> </span>Model %in%<span class="st"> </span><span class="kw">models_original</span>(), 
                <span class="dt">select =</span> -cols.drop)
        }
        if (!<span class="kw">is.null</span>(input$months2seasons) &amp;&amp;<span class="st"> </span>input$months2seasons) {
            prog_d_master$<span class="kw">set</span>(<span class="dt">message =</span> <span class="st">&quot;GCM time series: aggregating months...&quot;</span>, 
                <span class="dt">value =</span> <span class="dv">4</span>)
            x &lt;-<span class="st"> </span><span class="kw">collapseMonths</span>(x, <span class="kw">aggStatsID</span>(), <span class="kw">as.numeric</span>(input$n_seasons), 
                <span class="kw">Months_original</span>())
        }
        if (!<span class="kw">is.null</span>(input$decades2periods) &amp;&amp;<span class="st"> </span>input$decades2periods) {
            prog_d_master$<span class="kw">set</span>(<span class="dt">message =</span> <span class="st">&quot;GCM time series: aggregating decades...&quot;</span>, 
                <span class="dt">value =</span> <span class="dv">6</span>)
            x &lt;-<span class="st"> </span><span class="kw">periodsFromDecades</span>(x, <span class="kw">as.numeric</span>(input$n_periods), <span class="kw">Decades_original</span>())
        }
        <span class="co"># data from only one phase with multiple models in that phase selected, or</span>
        <span class="co"># two phases with equal number &gt; 1 of models selected from each phase.</span>
        <span class="co"># Otherwise compositing prohibited.  can assume both phases have multiple</span>
        <span class="co"># models, so split always works nicely</span>
        if (<span class="kw">composite</span>() ==<span class="st"> </span><span class="dv">2</span>) {
            prog_d_master$<span class="kw">set</span>(<span class="dt">message =</span> <span class="st">&quot;Averaging model statistics...&quot;</span>, <span class="dt">value =</span> <span class="dv">8</span>)
            n &lt;-<span class="st"> </span><span class="kw">length</span>(input$cmip3models)  <span class="co"># will match length(input$cmip5models)</span>
            x &lt;-<span class="st"> </span><span class="kw">split</span>(x, x$Phase)
            x1 &lt;-<span class="st"> </span><span class="kw">split</span>(x[[<span class="dv">1</span>]], x[[<span class="dv">1</span>]]$Model)
            x2 &lt;-<span class="st"> </span><span class="kw">split</span>(x[[<span class="dv">2</span>]], x[[<span class="dv">2</span>]]$Model)
            v1 &lt;-<span class="st"> </span>v2 &lt;-<span class="st"> </span><span class="kw">list</span>()
            for (k in <span class="dv">1</span>:<span class="kw">length</span>(stat)) {
                v1[[k]] &lt;-<span class="st"> </span><span class="kw">Reduce</span>(<span class="st">&quot;+&quot;</span>, <span class="kw">lapply</span>(x1, <span class="st">&quot;[&quot;</span>, stat[k]))[, <span class="dv">1</span>]/n
                v2[[k]] &lt;-<span class="st"> </span><span class="kw">Reduce</span>(<span class="st">&quot;+&quot;</span>, <span class="kw">lapply</span>(x2, <span class="st">&quot;[&quot;</span>, stat[k]))[, <span class="dv">1</span>]/n
            }
            x1[[<span class="dv">1</span>]]$Model &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;AR4 &quot;</span>, n, <span class="st">&quot;-Model Avg&quot;</span>)
            x2[[<span class="dv">1</span>]]$Model &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;AR5 &quot;</span>, n, <span class="st">&quot;-Model Avg&quot;</span>)
            x &lt;-<span class="st"> </span><span class="kw">rbind</span>(x1[[<span class="dv">1</span>]], x2[[<span class="dv">1</span>]])
            for (k in <span class="dv">1</span>:<span class="kw">length</span>(stat)) {
                x[[stat[k]]] &lt;-<span class="st"> </span><span class="kw">c</span>(v1[[k]], v2[[k]])
                x[[stat[k]]][x$Var ==<span class="st"> &quot;Temperature&quot;</span>] &lt;-<span class="st"> </span><span class="kw">round</span>(x[[stat[k]]][x$Var ==<span class="st"> </span>
<span class="st">                  &quot;Temperature&quot;</span>], <span class="dv">1</span>)
                x[[stat[k]]][x$Var ==<span class="st"> &quot;Precipitation&quot;</span>] &lt;-<span class="st"> </span><span class="kw">round</span>(x[[stat[k]]][x$Var ==<span class="st"> </span>
<span class="st">                  &quot;Precipitation&quot;</span>])
            }
        } else if (<span class="kw">composite</span>() ==<span class="st"> </span><span class="dv">1</span>) {
            prog_d_master$<span class="kw">set</span>(<span class="dt">message =</span> <span class="st">&quot;Averaging model statistics...&quot;</span>, <span class="dt">value =</span> <span class="dv">8</span>)
            if (<span class="kw">modelScenPair1</span>()) 
                n &lt;-<span class="st"> </span><span class="kw">length</span>(input$cmip3models) else if (<span class="kw">modelScenPair2</span>()) 
                n &lt;-<span class="st"> </span><span class="kw">length</span>(input$cmip5models)
            x1 &lt;-<span class="st"> </span><span class="kw">split</span>(x, x$Model)
            v1 &lt;-<span class="st"> </span><span class="kw">list</span>()
            for (k in <span class="dv">1</span>:<span class="kw">length</span>(stat)) v1[[k]] &lt;-<span class="st"> </span><span class="kw">Reduce</span>(<span class="st">&quot;+&quot;</span>, <span class="kw">lapply</span>(x1, <span class="st">&quot;[&quot;</span>, 
                stat[k]))[, <span class="dv">1</span>]/n
            x1[[<span class="dv">1</span>]]$Model &lt;-<span class="st"> </span><span class="kw">paste0</span>(n, <span class="st">&quot;-Model Avg&quot;</span>)
            x &lt;-<span class="st"> </span>x1[[<span class="dv">1</span>]]
            for (k in <span class="dv">1</span>:<span class="kw">length</span>(stat)) {
                x[[stat[k]]] &lt;-<span class="st"> </span>v1[[k]]
                x[[stat[k]]][x$Var ==<span class="st"> &quot;Temperature&quot;</span>] &lt;-<span class="st"> </span><span class="kw">round</span>(x[[stat[k]]][x$Var ==<span class="st"> </span>
<span class="st">                  &quot;Temperature&quot;</span>], <span class="dv">1</span>)
                x[[stat[k]]][x$Var ==<span class="st"> &quot;Precipitation&quot;</span>] &lt;-<span class="st"> </span><span class="kw">round</span>(x[[stat[k]]][x$Var ==<span class="st"> </span>
<span class="st">                  &quot;Precipitation&quot;</span>])
            }
        }
        if (input$convert_units) {
            prog_d_master$<span class="kw">set</span>(<span class="dt">message =</span> <span class="st">&quot;Unit conversion...&quot;</span>, <span class="dt">value =</span> <span class="dv">9</span>)
            for (k in <span class="dv">1</span>:<span class="kw">length</span>(stat)) {
                x[[stat[k]]][x$Var ==<span class="st"> &quot;Temperature&quot;</span>] &lt;-<span class="st"> </span><span class="kw">round</span>((<span class="dv">9</span>/<span class="dv">5</span>) *<span class="st"> </span>x[[stat[k]]][x$Var ==<span class="st"> </span>
<span class="st">                  &quot;Temperature&quot;</span>] +<span class="st"> </span><span class="dv">32</span>, <span class="dv">1</span>)
                x[[stat[k]]][x$Var ==<span class="st"> &quot;Precipitation&quot;</span>] &lt;-<span class="st"> </span><span class="kw">round</span>(x[[stat[k]]][x$Var ==<span class="st"> </span>
<span class="st">                  &quot;Precipitation&quot;</span>]/<span class="fl">25.4</span>, <span class="dv">3</span>)
            }
        }
        prog_d_master$<span class="kw">set</span>(<span class="dt">message =</span> <span class="st">&quot;GCM statistics complete.&quot;</span>, <span class="dt">value =</span> <span class="dv">10</span>)
        <span class="kw">rownames</span>(x) &lt;-<span class="st"> </span><span class="ot">NULL</span>
    })
    x
})</code></pre>
</div>
<div id="master-cru-data-set" class="section level4">
<h4>Master CRU data set</h4>
<pre class="sourceCode r"><code class="sourceCode r">CRU_master &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    if (<span class="kw">goBtnNullOrZero</span>()) 
        <span class="kw">return</span>()
    <span class="co"># prog_d_cru_master &lt;- Progress$new(session, min=1, max=10)</span>
    <span class="co"># on.exit(prog_d_cru_master$close())</span>
    <span class="kw">isolate</span>(if (<span class="kw">is.null</span>(<span class="kw">Months_original</span>()) |<span class="st"> </span><span class="kw">is.null</span>(input$vars) |<span class="st"> </span><span class="kw">is.null</span>(input$convert_units) |<span class="st"> </span>
<span class="st">        </span><span class="kw">locSelected</span>() ==<span class="st"> </span><span class="ot">FALSE</span>) {
        x &lt;-<span class="st"> </span><span class="ot">NULL</span>
    } else {
        <span class="co"># prog_d_cru_master$set(message=&#39;Loading CRU 3.2 aggregate time series</span>
        <span class="co"># statistics...&#39;)</span>
        if (input$loctype ==<span class="st"> &quot;Cities&quot;</span> &amp;&amp;<span class="st"> </span><span class="kw">length</span>(input$locs_cities) &amp;&amp;<span class="st"> </span>input$locs_cities[<span class="dv">1</span>] !=<span class="st"> </span>
<span class="st">            &quot;&quot;</span>) {
            city.ind &lt;-<span class="st"> </span><span class="kw">which</span>(city.names %in%<span class="st"> </span><span class="kw">Locs</span>())
            for (i in <span class="dv">1</span>:<span class="kw">length</span>(city.ind)) {
                <span class="kw">load</span>(city.cru.files[city.ind[i]], <span class="dt">envir =</span> <span class="kw">environment</span>())
                if (i ==<span class="st"> </span><span class="dv">1</span>) 
                  city.cru.dat.final &lt;-<span class="st"> </span>city.cru.dat else city.cru.dat.final &lt;-<span class="st"> </span><span class="kw">rbind</span>(city.cru.dat.final, city.cru.dat)
            }
            <span class="co"># prog_d_cru_master$set(message=&#39;Subsetting CRU 3.2 time series data...&#39;)</span>
            x &lt;-<span class="st"> </span><span class="kw">subset</span>(city.cru.dat.final, Month %in%<span class="st"> </span>month.abb[<span class="kw">match</span>(<span class="kw">Months_original</span>(), 
                month.abb)] &amp;<span class="st"> </span>Year %in%<span class="st"> </span><span class="kw">currentYears</span>() &amp;<span class="st"> </span>Decade %in%<span class="st"> </span><span class="kw">substr</span>(<span class="kw">Decades_original</span>(), 
                <span class="dv">1</span>, <span class="dv">4</span>))  <span class="co"># &amp; </span>
            <span class="co"># Scenario %in% scenarios() &amp; Model %in% models_original())# &amp; Location %in%</span>
            <span class="co"># input$locs_cities)</span>
        } else if (input$loctype !=<span class="st"> &quot;Cities&quot;</span>) {
            reg.nam &lt;-<span class="st"> </span><span class="kw">sort</span>(region.names.out[[input$loctype]])
            region.ind &lt;-<span class="st"> </span><span class="kw">which</span>(reg.nam %in%<span class="st"> </span><span class="kw">Locs</span>())
            for (i in <span class="dv">1</span>:<span class="kw">length</span>(region.ind)) {
                filename &lt;-<span class="st"> </span>switch(input$vars[<span class="dv">1</span>], <span class="dt">Temperature =</span> <span class="st">&quot;stats_climate&quot;</span>, 
                  <span class="dt">Precipitation =</span> <span class="st">&quot;stats_climate&quot;</span>)  <span class="co"># Still can only load onevariable file, okay as long as app only contains T &amp; P</span>
                <span class="kw">load</span>(<span class="kw">paste0</span>(region.cru.stats.files[[input$loctype]][region.ind[i]], 
                  <span class="st">&quot;/&quot;</span>, filename, <span class="st">&quot;.RData&quot;</span>), <span class="dt">envir =</span> <span class="kw">environment</span>())
                if (i ==<span class="st"> </span><span class="dv">1</span>) 
                  region.cru.dat.final &lt;-<span class="st"> </span>region.cru.dat else region.cru.dat.final &lt;-<span class="st"> </span><span class="kw">rbind</span>(region.cru.dat.final, region.cru.dat)
            }
            <span class="co"># prog_d_cru_master$set(message=&#39;Subsetting CRU 3.2 time series data...&#39;)</span>
            stat &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">aggStatsID</span>(), <span class="kw">aggStatsID2</span>())
            cols.drop &lt;-<span class="st"> </span><span class="kw">match</span>(agg.stat.colnames[<span class="kw">which</span>(!(agg.stat.colnames %in%<span class="st"> </span>
<span class="st">                </span>stat))], <span class="kw">names</span>(region.cru.dat.final))
            x &lt;-<span class="st"> </span><span class="kw">subset</span>(region.cru.dat.final, Month %in%<span class="st"> </span>month.abb[<span class="kw">match</span>(<span class="kw">Months_original</span>(), 
                month.abb)] &amp;<span class="st"> </span>Year %in%<span class="st"> </span><span class="kw">currentYears</span>() &amp;<span class="st"> </span>Decade %in%<span class="st"> </span><span class="kw">substr</span>(<span class="kw">Decades_original</span>(), 
                <span class="dv">1</span>, <span class="dv">4</span>), <span class="dt">select =</span> -cols.drop)
        }
        if (<span class="kw">nrow</span>(x) ==<span class="st"> </span><span class="dv">0</span>) 
            <span class="kw">return</span>()
        if (!<span class="kw">is.null</span>(input$months2seasons) &amp;&amp;<span class="st"> </span>input$months2seasons) {
            <span class="co"># prog_d_cru_master$set(message=&#39;CRU 3.2 time series: aggregating</span>
            <span class="co"># months...&#39;)</span>
            x &lt;-<span class="st"> </span><span class="kw">collapseMonths</span>(x, <span class="kw">aggStatsID</span>(), <span class="kw">as.numeric</span>(input$n_seasons), 
                <span class="kw">Months_original</span>())
        }
        if (!<span class="kw">is.null</span>(input$decades2periods) &amp;&amp;<span class="st"> </span>input$decades2periods) {
            <span class="co"># prog_d_cru_master$set(message=&#39;CRU 3.2 time series: aggregating</span>
            <span class="co"># decades...&#39;)</span>
            x &lt;-<span class="st"> </span><span class="kw">periodsFromDecades</span>(x, <span class="kw">as.numeric</span>(input$n_periods), <span class="kw">Decades_original</span>(), 
                <span class="dt">check.years =</span> <span class="ot">TRUE</span>)
        }
        if (<span class="kw">is.null</span>(x)) 
            <span class="kw">return</span>()
        <span class="co"># data from only one phase with multiple models in that phase selected, or</span>
        <span class="co"># two phases with equal number &gt; 1 of models selected from each phase.</span>
        <span class="co"># Otherwise compositing prohibited.</span>
        if (input$convert_units) {
            <span class="co"># prog_d_cru_master$set(message=&#39;Unit conversion...&#39;)</span>
            for (k in <span class="dv">1</span>:<span class="kw">length</span>(stat)) {
                x[[stat[k]]][x$Var ==<span class="st"> &quot;Temperature&quot;</span>] &lt;-<span class="st"> </span><span class="kw">round</span>((<span class="dv">9</span>/<span class="dv">5</span>) *<span class="st"> </span>x[[stat[k]]][x$Var ==<span class="st"> </span>
<span class="st">                  &quot;Temperature&quot;</span>] +<span class="st"> </span><span class="dv">32</span>, <span class="dv">1</span>)
                x[[stat[k]]][x$Var ==<span class="st"> &quot;Precipitation&quot;</span>] &lt;-<span class="st"> </span><span class="kw">round</span>(x[[stat[k]]][x$Var ==<span class="st"> </span>
<span class="st">                  &quot;Precipitation&quot;</span>]/<span class="fl">25.4</span>, <span class="dv">3</span>)
            }
        }
        <span class="kw">rownames</span>(x) &lt;-<span class="st"> </span><span class="ot">NULL</span>
        x$Model &lt;-<span class="st"> </span>x$Scenario &lt;-<span class="st"> </span>x$Phase &lt;-<span class="st"> &quot;CRU 3.2&quot;</span>
        <span class="co"># prog_d_cru_master$set(message=&#39;CRU 3.2 statistics complete.&#39;)</span>
        x &lt;-<span class="st"> </span>x[<span class="kw">c</span>(<span class="kw">ncol</span>(x) -<span class="st"> </span><span class="kw">c</span>(<span class="dv">2</span>:<span class="dv">0</span>), <span class="dv">1</span>:(<span class="kw">ncol</span>(x) -<span class="st"> </span><span class="dv">3</span>))]
    })
    x
})</code></pre>
</div>
<div id="gcm-data-subsets" class="section level4">
<h4>GCM data subsets</h4>
<pre class="sourceCode r"><code class="sourceCode r">dat &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    if (<span class="kw">goBtnNullOrZero</span>()) 
        <span class="kw">return</span>()
    <span class="kw">isolate</span>({
        if (<span class="kw">is.null</span>(<span class="kw">dat_master</span>())) {
            x &lt;-<span class="st"> </span><span class="ot">NULL</span>
        } else {
            if (<span class="kw">aggStatsID</span>() ==<span class="st"> </span><span class="kw">aggStatsID2</span>()) 
                keep.cols &lt;-<span class="st"> </span><span class="dv">1</span>:<span class="kw">ncol</span>(<span class="kw">dat_master</span>()) else keep.cols &lt;-<span class="st"> </span><span class="kw">which</span>(!(<span class="kw">names</span>(<span class="kw">dat_master</span>()) %in%<span class="st"> </span><span class="kw">aggStatsID2</span>()))
            x &lt;-<span class="st"> </span><span class="kw">subset</span>(<span class="kw">dat_master</span>(), Var %in%<span class="st"> </span>input$vars, keep.cols)  <span class="co"># only one (first) climate variable permitted for use in TS plot</span>
            <span class="kw">rownames</span>(x) &lt;-<span class="st"> </span><span class="ot">NULL</span>
        }
    })
    x
})

dat_heatmap &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    if (<span class="kw">goBtnNullOrZero</span>() ||<span class="st"> </span><span class="kw">is.null</span>(<span class="kw">dat</span>())) 
        <span class="kw">return</span>()
    input$heatmap_x
    input$heatmap_y
    input$facetHeatmap
    input$hm_showCRU
    <span class="kw">isolate</span>({
        d &lt;-<span class="st"> </span><span class="kw">dat</span>()
        if (input$hm_showCRU &amp;<span class="st"> </span>!<span class="kw">is.null</span>(<span class="kw">CRU</span>())) {
            n.d &lt;-<span class="st"> </span><span class="kw">nrow</span>(d)
            mods.d &lt;-<span class="st"> </span><span class="kw">unique</span>(d$Model)
            yrs.tmp &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">c</span>(<span class="kw">as.character</span>(d$Year), <span class="kw">as.character</span>(<span class="kw">CRU</span>()$Year)))
            d &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">rbind</span>(d[<span class="dv">1</span>:<span class="dv">7</span>], <span class="kw">CRU</span>()[<span class="dv">1</span>:<span class="dv">7</span>]), <span class="dt">Year =</span> yrs.tmp, <span class="kw">rbind</span>(d[<span class="dv">9</span>:<span class="kw">ncol</span>(d)], 
                <span class="kw">CRU</span>()[<span class="dv">9</span>:<span class="kw">ncol</span>(<span class="kw">CRU</span>())]))
            d$Year &lt;-<span class="st"> </span>yrs.tmp
            d$Source &lt;-<span class="st"> </span><span class="kw">factor</span>(<span class="kw">c</span>(<span class="kw">rep</span>(<span class="st">&quot;Modeled&quot;</span>, n.d), <span class="kw">rep</span>(<span class="st">&quot;Observed&quot;</span>, <span class="kw">nrow</span>(<span class="kw">CRU</span>()))))
            d$Model &lt;-<span class="st"> </span><span class="kw">factor</span>(d$Model, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="kw">CRU</span>()$Model[<span class="dv">1</span>], mods.d))
        }
        if (!<span class="kw">is.null</span>(input$heatmap_x) &amp;<span class="st"> </span>!<span class="kw">is.null</span>(input$heatmap_y)) {
            x &lt;-<span class="st"> </span><span class="kw">c</span>(input$heatmap_x, input$heatmap_y)
            if (!(<span class="kw">is.null</span>(input$facetHeatmap) ||<span class="st"> </span>input$facetHeatmap ==<span class="st"> &quot;None&quot;</span>)) 
                x &lt;-<span class="st"> </span><span class="kw">c</span>(x, input$facetHeatmap)
            stat &lt;-<span class="st"> </span><span class="kw">aggStatsID</span>()
            if (input$vars ==<span class="st"> &quot;Temperature&quot;</span>) 
                d &lt;-<span class="st"> </span><span class="kw">ddply</span>(d, x, <span class="kw">here</span>(summarise), <span class="dt">XMean =</span> <span class="kw">round</span>(<span class="kw">mean</span>(<span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> stat))), 
                  <span class="dv">1</span>), <span class="dt">XSD =</span> <span class="kw">round</span>(<span class="kw">sd</span>(<span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> stat))), <span class="dv">1</span>))
            if (input$vars ==<span class="st"> &quot;Precipitation&quot;</span>) 
                d &lt;-<span class="st"> </span><span class="kw">ddply</span>(d, x, <span class="kw">here</span>(summarise), <span class="dt">XMean =</span> <span class="kw">round</span>(<span class="kw">mean</span>(<span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> stat)))), 
                  <span class="dt">XTotal =</span> <span class="kw">round</span>(<span class="kw">sum</span>(<span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> stat)))), <span class="dt">XSD =</span> <span class="kw">round</span>(<span class="kw">sd</span>(<span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> stat)))))
            <span class="kw">names</span>(d) &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;X&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="kw">names</span>(d))
            if (<span class="kw">all</span>(<span class="kw">is.na</span>(d$SD))) 
                d &lt;-<span class="st"> </span>d[, -<span class="kw">ncol</span>(d)]
        }
    })
    d
})

dat2 &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    if (<span class="kw">goBtnNullOrZero</span>()) 
        <span class="kw">return</span>()
    <span class="kw">isolate</span>({
        x &lt;-<span class="st"> </span><span class="ot">NULL</span>
        if (!<span class="kw">is.null</span>(<span class="kw">dat_master</span>()) &amp;&amp;<span class="st"> </span><span class="kw">length</span>(input$vars) &amp;&amp;<span class="st"> </span><span class="kw">length</span>(input$vars2)) 
            x &lt;-<span class="st"> </span><span class="kw">dcast</span>(<span class="kw">dat_master</span>(), Phase +<span class="st"> </span>Model +<span class="st"> </span>Scenario +<span class="st"> </span>Location +<span class="st"> </span>Year +<span class="st"> </span>
<span class="st">                </span>Month +<span class="st"> </span>Decade ~<span class="st"> </span>Var, <span class="dt">value.var =</span> <span class="kw">aggStatsID</span>()) else x &lt;-<span class="st"> </span><span class="ot">NULL</span>
        if (!<span class="kw">is.null</span>(x) &amp;&amp;<span class="st"> </span><span class="kw">aggStatsID</span>() !=<span class="st"> </span><span class="kw">aggStatsID2</span>()) 
            x[input$vars2] &lt;-<span class="st"> </span><span class="kw">dat_master</span>()[<span class="kw">dat_master</span>()$Var ==<span class="st"> </span>input$vars2, 
                <span class="kw">aggStatsID2</span>()]
    })
    x
})</code></pre>
</div>
<div id="cru-data-subsets" class="section level4">
<h4>CRU data subsets</h4>
<pre class="sourceCode r"><code class="sourceCode r">CRU &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    if (<span class="kw">goBtnNullOrZero</span>()) 
        <span class="kw">return</span>()
    <span class="kw">isolate</span>(if (<span class="kw">is.null</span>(<span class="kw">CRU_master</span>())) {
        x &lt;-<span class="st"> </span><span class="ot">NULL</span>
    } else {
        if (<span class="kw">aggStatsID</span>() ==<span class="st"> </span><span class="kw">aggStatsID2</span>()) 
            keep.cols &lt;-<span class="st"> </span><span class="dv">1</span>:<span class="kw">ncol</span>(<span class="kw">CRU_master</span>()) else keep.cols &lt;-<span class="st"> </span><span class="kw">which</span>(!(<span class="kw">names</span>(<span class="kw">CRU_master</span>()) %in%<span class="st"> </span><span class="kw">aggStatsID2</span>()))
        x &lt;-<span class="st"> </span><span class="kw">subset</span>(<span class="kw">CRU_master</span>(), Var %in%<span class="st"> </span>input$vars, keep.cols)  <span class="co"># only one (first) climate variable permitted for use in TS plot</span>
        <span class="kw">rownames</span>(x) &lt;-<span class="st"> </span><span class="ot">NULL</span>
    })
    x
})

CRU2 &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    if (<span class="kw">goBtnNullOrZero</span>()) 
        <span class="kw">return</span>()
    <span class="kw">isolate</span>({
        x &lt;-<span class="st"> </span><span class="ot">NULL</span>
        if (!<span class="kw">is.null</span>(<span class="kw">CRU_master</span>()) &amp;&amp;<span class="st"> </span><span class="kw">length</span>(input$vars) &amp;&amp;<span class="st"> </span><span class="kw">length</span>(input$vars2)) 
            x &lt;-<span class="st"> </span><span class="kw">dcast</span>(<span class="kw">CRU_master</span>(), Phase +<span class="st"> </span>Model +<span class="st"> </span>Scenario +<span class="st"> </span>Location +<span class="st"> </span>Year +<span class="st"> </span>
<span class="st">                </span>Month +<span class="st"> </span>Decade ~<span class="st"> </span>Var, <span class="dt">value.var =</span> <span class="kw">aggStatsID</span>()) else <span class="ot">NULL</span>
        if (!<span class="kw">is.null</span>(x) &amp;&amp;<span class="st"> </span><span class="kw">aggStatsID</span>() !=<span class="st"> </span><span class="kw">aggStatsID2</span>()) 
            x[input$vars2] &lt;-<span class="st"> </span><span class="kw">CRU_master</span>()[<span class="kw">CRU_master</span>()$Var ==<span class="st"> </span>input$vars2, 
                <span class="kw">aggStatsID2</span>()]
    })
    x
})</code></pre>
</div>
<div id="gcm-distributions-data-files" class="section level4">
<h4>GCM distributions data files</h4>
<pre class="sourceCode r"><code class="sourceCode r">gcm_samples_files &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    if (<span class="kw">anyModelScenPair</span>() &amp;<span class="st"> </span><span class="kw">length</span>(input$vars)) {
        s &lt;-<span class="st"> </span><span class="kw">substr</span>(<span class="kw">scenarios</span>(), <span class="dv">1</span>, <span class="dv">3</span>)
        AR &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;RCP&quot;</span>, <span class="st">&quot;AR5&quot;</span>, <span class="kw">gsub</span>(<span class="st">&quot;SRE&quot;</span>, <span class="st">&quot;AR4&quot;</span>, s))
        y &lt;-<span class="st"> </span><span class="kw">sapply</span>(<span class="kw">models_original</span>(), mod2ar)
        x &lt;-<span class="st"> </span><span class="kw">list</span>()
        for (i in <span class="dv">1</span>:<span class="kw">length</span>(y)) {
            x[[i]] &lt;-<span class="st"> </span><span class="kw">paste</span>(y[i], <span class="kw">c</span>(<span class="st">&quot;Hist&quot;</span>, <span class="kw">gsub</span>(<span class="st">&quot; &quot;</span>, <span class="st">&quot;&quot;</span>, <span class="kw">scenarios</span>())[AR ==<span class="st"> </span>
<span class="st">                </span>y[i]]), <span class="kw">models_original</span>()[i], <span class="dt">sep =</span> <span class="st">&quot;_&quot;</span>)
            x[[i]] &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="kw">rep</span>(x[[i]], <span class="dt">each =</span> <span class="kw">length</span>(input$vars)), <span class="st">&quot;_&quot;</span>, input$vars, 
                <span class="st">&quot;.RData&quot;</span>)
        }
    } else x &lt;-<span class="st"> </span><span class="ot">NULL</span>
    x
})</code></pre>
</div>
<div id="master-gcm-distributions-data-set" class="section level4">
<h4>Master GCM distributions data set</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Keep first climate variables only</span>
dat_spatial &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    if (<span class="kw">goBtnNullOrZero</span>()) 
        <span class="kw">return</span>()
    prog_d_spatial &lt;-<span class="st"> </span>Progress$<span class="kw">new</span>(session, <span class="dt">min =</span> <span class="dv">0</span>, <span class="dt">max =</span> <span class="dv">10</span>)
    <span class="kw">on.exit</span>(prog_d_spatial$<span class="kw">close</span>())
    <span class="kw">isolate</span>(if (<span class="kw">is.null</span>(<span class="kw">Months_original</span>()) |<span class="st"> </span><span class="kw">is.null</span>(input$vars) |<span class="st"> </span><span class="kw">is.null</span>(<span class="kw">scenarios</span>()) |<span class="st"> </span>
<span class="st">        </span><span class="kw">is.null</span>(<span class="kw">models_original</span>()) |<span class="st"> </span><span class="kw">locSelected</span>() ==<span class="st"> </span><span class="ot">FALSE</span>) {
        x &lt;-<span class="st"> </span><span class="ot">NULL</span>
    } else {
        if (input$loctype ==<span class="st"> &quot;Cities&quot;</span> &amp;&amp;<span class="st"> </span><span class="kw">length</span>(input$locs_cities) &amp;&amp;<span class="st"> </span>input$locs_cities[<span class="dv">1</span>] !=<span class="st"> </span>
<span class="st">            &quot;&quot;</span>) {
            #### Deal with cities under spatial data conditions later
            city.ind &lt;-<span class="st"> </span><span class="kw">which</span>(city.names %in%<span class="st"> </span><span class="kw">Locs</span>())
            for (i in <span class="dv">1</span>:<span class="kw">length</span>(city.ind)) {
                prog_d_spatial$<span class="kw">set</span>(<span class="dt">message =</span> <span class="st">&quot;Loading GCM spatial distributions...&quot;</span>, 
                  <span class="dt">value =</span> <span class="dv">1</span> +<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span>i/<span class="kw">length</span>(city.ind))
                <span class="kw">load</span>(city.gcm.files[city.ind[i]], <span class="dt">envir =</span> <span class="kw">environment</span>())
                if (i ==<span class="st"> </span><span class="dv">1</span>) 
                  city.dat.final &lt;-<span class="st"> </span>city.dat else city.dat.final &lt;-<span class="st"> </span><span class="kw">rbind</span>(city.dat.final, city.dat)
            }
            prog_d_spatial$<span class="kw">set</span>(<span class="dt">message =</span> <span class="st">&quot;Subsetting GCM spatial samples...&quot;</span>, 
                <span class="dt">value =</span> <span class="dv">4</span>)
            x &lt;-<span class="st"> </span><span class="kw">subset</span>(city.dat.final, Month %in%<span class="st"> </span>month.abb[<span class="kw">match</span>(<span class="kw">Months_original</span>(), 
                month.abb)] &amp;<span class="st"> </span>Year %in%<span class="st"> </span><span class="kw">currentYears</span>() &amp;<span class="st"> </span>Decade %in%<span class="st"> </span><span class="kw">substr</span>(<span class="kw">Decades_original</span>(), 
                <span class="dv">1</span>, <span class="dv">4</span>) &amp;<span class="st"> </span>Scenario %in%<span class="st"> </span><span class="kw">scenarios</span>() &amp;<span class="st"> </span>Model %in%<span class="st"> </span><span class="kw">models_original</span>() &amp;<span class="st"> </span>
<span class="st">                </span>Location %in%<span class="st"> </span>input$locs_cities)
        } else if (input$loctype !=<span class="st"> &quot;Cities&quot;</span>) {
            #### Regions: only this is under development for now
            prog_d_spatial$<span class="kw">set</span>(<span class="dt">message =</span> <span class="st">&quot;GCM spatial samples...&quot;</span>, <span class="dt">value =</span> <span class="dv">1</span>)
            reg.nam &lt;-<span class="st"> </span><span class="kw">sort</span>(region.names.out[[input$loctype]])
            region.ind &lt;-<span class="st"> </span><span class="kw">which</span>(reg.nam %in%<span class="st"> </span><span class="kw">Locs</span>())
            rsd.list &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="st">&quot;list&quot;</span>, <span class="kw">length</span>(region.ind))
            for (i in <span class="dv">1</span>:<span class="kw">length</span>(region.ind)) {
                <span class="co"># by region</span>
                locDir &lt;-<span class="st"> </span><span class="kw">file.path</span>(region.gcm.samples.files[[input$loctype]][region.ind[i]], 
                  <span class="st">&quot;climate&quot;</span>)
                loc.files &lt;-<span class="st"> </span><span class="kw">list.files</span>(locDir, <span class="dt">pattern =</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">.RData&quot;</span>)
                rsd.list1 &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="st">&quot;list&quot;</span>, <span class="kw">length</span>(<span class="kw">gcm_samples_files</span>()))
                for (z in <span class="dv">1</span>:<span class="kw">length</span>(<span class="kw">gcm_samples_files</span>())) {
                  <span class="co"># by model</span>
                  mod.files &lt;-<span class="st"> </span><span class="kw">gcm_samples_files</span>()[[z]]
                  mod.files.list &lt;-<span class="st"> </span><span class="kw">split</span>(mod.files, <span class="kw">substr</span>(mod.files, <span class="kw">nchar</span>(mod.files) -<span class="st"> </span>
<span class="st">                    </span><span class="dv">16</span>, <span class="kw">nchar</span>(mod.files) -<span class="st"> </span><span class="dv">6</span>))  <span class="co"># by variable</span>
                  rsd.list2 &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="st">&quot;list&quot;</span>, <span class="kw">length</span>(mod.files.list))
                  for (zz in <span class="dv">1</span>:<span class="kw">length</span>(mod.files.list)) {
                    var.files &lt;-<span class="st"> </span>mod.files.list[[zz]]
                    rsd.list3 &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="st">&quot;list&quot;</span>, <span class="kw">length</span>(var.files) -<span class="st"> </span><span class="dv">1</span>)
                    for (zzz in <span class="dv">1</span>:<span class="kw">length</span>(var.files)) {
                      <span class="kw">load</span>(<span class="kw">file.path</span>(locDir, var.files[zzz]), <span class="dt">envir =</span> <span class="kw">environment</span>())  <span class="co"># Historical df loaded first (*alphabetical*)</span>
                      if (zzz ==<span class="st"> </span><span class="dv">1</span>) {
                        rsd.h &lt;-<span class="st"> </span><span class="kw">subset</span>(rsd.h, Month %in%<span class="st"> </span>month.abb[<span class="kw">match</span>(<span class="kw">Months_original</span>(), 
                          month.abb)] &amp;<span class="st"> </span>Year %in%<span class="st"> </span><span class="kw">currentYears</span>() &amp;<span class="st"> </span>Decade %in%<span class="st"> </span>
<span class="st">                          </span><span class="kw">substr</span>(<span class="kw">Decades_original</span>(), <span class="dv">1</span>, <span class="dv">4</span>))
                        rsd.h &lt;-<span class="st"> </span><span class="kw">data.frame</span>(rsd.h)
                        if (<span class="kw">nrow</span>(rsd.h) &gt;<span class="st"> </span><span class="dv">0</span>) 
                          rsd.h[, samples.columns] &lt;-<span class="st"> </span>rsd.h[, samples.columns]/<span class="kw">rep</span>(samples.multipliers, 
                            <span class="dt">each =</span> <span class="kw">nrow</span>(rsd.h))
                      }
                      if (zzz &gt;<span class="st"> </span><span class="dv">1</span>) {
                        if (<span class="kw">nrow</span>(rsd.h) &gt;<span class="st"> </span><span class="dv">0</span>) {
                          rsd.h$Phase &lt;-<span class="st"> </span>rsd$Phase[<span class="dv">1</span>]
                          rsd.h$Scenario &lt;-<span class="st"> </span>rsd$Scenario[<span class="dv">1</span>]
                          rsd.h$Model &lt;-<span class="st"> </span>rsd$Model[<span class="dv">1</span>]
                        }
                        rsd &lt;-<span class="st"> </span><span class="kw">subset</span>(rsd, Month %in%<span class="st"> </span>month.abb[<span class="kw">match</span>(<span class="kw">Months_original</span>(), 
                          month.abb)] &amp;<span class="st"> </span>Year %in%<span class="st"> </span><span class="kw">currentYears</span>() &amp;<span class="st"> </span>Decade %in%<span class="st"> </span>
<span class="st">                          </span><span class="kw">substr</span>(<span class="kw">Decades_original</span>(), <span class="dv">1</span>, <span class="dv">4</span>))
                        if (<span class="kw">nrow</span>(rsd.h) &gt;<span class="st"> </span><span class="dv">0</span> &amp;<span class="st"> </span><span class="kw">nrow</span>(rsd) &gt;<span class="st"> </span><span class="dv">0</span>) {
                          rsd &lt;-<span class="st"> </span><span class="kw">data.frame</span>(rsd)
                          rsd[, samples.columns] &lt;-<span class="st"> </span>rsd[, samples.columns]/<span class="kw">rep</span>(samples.multipliers, 
                            <span class="dt">each =</span> <span class="kw">nrow</span>(rsd))
                          rsd.list3[[zzz -<span class="st"> </span><span class="dv">1</span>]] &lt;-<span class="st"> </span><span class="kw">rbind</span>(rsd.h, rsd)
                        } else if (<span class="kw">nrow</span>(rsd.h) &gt;<span class="st"> </span><span class="dv">0</span>) {
                          rsd.list3[[zzz -<span class="st"> </span><span class="dv">1</span>]] &lt;-<span class="st"> </span>rsd.h
                        } else if (<span class="kw">nrow</span>(rsd) &gt;<span class="st"> </span><span class="dv">0</span>) {
                          rsd.list3[[zzz -<span class="st"> </span><span class="dv">1</span>]] &lt;-<span class="st"> </span>rsd
                        } else <span class="kw">return</span>(<span class="ot">NULL</span>)
                      }
                    }
                    rsd.list2[[zz]] &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(rsd.list3)
                    <span class="kw">rm</span>(rsd.list3)
                  }
                  rsd.list1[[z]] &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(rsd.list2)
                  <span class="kw">rm</span>(rsd.list2)
                }
                rsd.list[[i]] &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(rsd.list1)
                <span class="kw">rm</span>(rsd.list1)
            }
            x &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(rsd.list)
            <span class="kw">rm</span>(rsd.list, rsd, rsd.h)
            <span class="kw">gc</span>()
        }
        prog_d_spatial$<span class="kw">set</span>(<span class="dt">message =</span> <span class="st">&quot;Bootstrap resampling...&quot;</span>, <span class="dt">value =</span> <span class="dv">5</span>)
        rnd &lt;-<span class="st"> </span>if (input$vars[<span class="dv">1</span>] ==<span class="st"> &quot;Precipitation&quot;</span>) 
            <span class="dv">0</span> else <span class="dv">1</span>
        x &lt;-<span class="st"> </span><span class="kw">density2bootstrap</span>(x, <span class="dt">n.density =</span> n.samples, <span class="dt">n.boot =</span> <span class="kw">BootSamples</span>(), 
            <span class="dt">interp =</span> <span class="ot">TRUE</span>, <span class="dt">n.interp =</span> <span class="dv">1000</span>, <span class="dt">digits =</span> rnd)  <span class="co"># n.boot and n.interp values tentative</span>
        if (!<span class="kw">is.null</span>(input$months2seasons) &amp;&amp;<span class="st"> </span>input$months2seasons) {
            prog_d_spatial$<span class="kw">set</span>(<span class="dt">message =</span> <span class="st">&quot;Aggregating months...&quot;</span>, <span class="dt">value =</span> <span class="dv">6</span>)
            x &lt;-<span class="st"> </span><span class="kw">collapseMonths</span>(x, <span class="st">&quot;Val&quot;</span>, <span class="kw">as.numeric</span>(input$n_seasons), <span class="kw">Months_original</span>(), 
                <span class="dt">n.samples =</span> <span class="dv">1000</span>)
        }
        if (!<span class="kw">is.null</span>(input$decades2periods) &amp;&amp;<span class="st"> </span>input$decades2periods) {
            prog_d_spatial$<span class="kw">set</span>(<span class="dt">message =</span> <span class="st">&quot;Aggregating decades...&quot;</span>, <span class="dt">value =</span> <span class="dv">7</span>)
            x &lt;-<span class="st"> </span><span class="kw">periodsFromDecades</span>(x, <span class="kw">as.numeric</span>(input$n_periods), <span class="kw">Decades_original</span>(), 
                <span class="dt">n.samples =</span> <span class="dv">1000</span>)
        }
        <span class="co"># data from only one phase with multiple models in that phase selected, or</span>
        <span class="co"># two phases with equal number &gt; 1 of models selected from each phase.</span>
        <span class="co"># Otherwise compositing prohibited.  can assume both phases have multiple</span>
        <span class="co"># models, so split always works nicely</span>
        if (<span class="kw">composite</span>() ==<span class="st"> </span><span class="dv">2</span>) {
            prog_d_spatial$<span class="kw">set</span>(<span class="dt">message =</span> <span class="st">&quot;Averaging samples...&quot;</span>, <span class="dt">value =</span> <span class="fl">7.5</span>)
            n &lt;-<span class="st"> </span><span class="kw">length</span>(input$cmip3models)  <span class="co"># will match length(input$cmip5models)</span>
            x &lt;-<span class="st"> </span><span class="kw">split</span>(x, x$Phase)
            x1 &lt;-<span class="st"> </span><span class="kw">split</span>(x[[<span class="dv">1</span>]], x[[<span class="dv">1</span>]]$Model)
            x2 &lt;-<span class="st"> </span><span class="kw">split</span>(x[[<span class="dv">2</span>]], x[[<span class="dv">2</span>]]$Model)
            v1 &lt;-<span class="st"> </span><span class="kw">Reduce</span>(<span class="st">&quot;+&quot;</span>, <span class="kw">lapply</span>(x1, <span class="st">&quot;[&quot;</span>, <span class="kw">c</span>(<span class="st">&quot;Val&quot;</span>)))[, <span class="dv">1</span>]/n  #### Compositing definitely will not work with samples as defined (Should I produce new samples and dispense with Prob column here?)
            v2 &lt;-<span class="st"> </span><span class="kw">Reduce</span>(<span class="st">&quot;+&quot;</span>, <span class="kw">lapply</span>(x2, <span class="st">&quot;[&quot;</span>, <span class="kw">c</span>(<span class="st">&quot;Val&quot;</span>)))[, <span class="dv">1</span>]/n  #### See code snippet at top of spatial plot script for possibly early integration of bootstrap resampling.
            x1[[<span class="dv">1</span>]]$Model &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;AR4 &quot;</span>, n, <span class="st">&quot;-Model Avg&quot;</span>)  #### Probably also better to integrate here because it removes data manip from plotting stage and also offers user a more useful dataset to download
            x2[[<span class="dv">1</span>]]$Model &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;AR5 &quot;</span>, n, <span class="st">&quot;-Model Avg&quot;</span>)
            x &lt;-<span class="st"> </span><span class="kw">rbind</span>(x1[[<span class="dv">1</span>]], x2[[<span class="dv">1</span>]])
            x$Val &lt;-<span class="st"> </span><span class="kw">c</span>(v1, v2)
            x$Val[x$Var ==<span class="st"> &quot;Temperature&quot;</span>] &lt;-<span class="st"> </span><span class="kw">round</span>(x$Val[x$Var ==<span class="st"> &quot;Temperature&quot;</span>], 
                <span class="dv">1</span>)
            x$Val[x$Var ==<span class="st"> &quot;Precipitation&quot;</span>] &lt;-<span class="st"> </span><span class="kw">round</span>(x$Val[x$Var ==<span class="st"> &quot;Precipitation&quot;</span>])
        } else if (<span class="kw">composite</span>() ==<span class="st"> </span><span class="dv">1</span>) {
            prog_d_spatial$<span class="kw">set</span>(<span class="dt">message =</span> <span class="st">&quot;Averaging samples...&quot;</span>, <span class="dt">value =</span> <span class="fl">8.5</span>)
            if (<span class="kw">modelScenPair1</span>()) 
                n &lt;-<span class="st"> </span><span class="kw">length</span>(input$cmip3models) else if (<span class="kw">modelScenPair2</span>()) 
                n &lt;-<span class="st"> </span><span class="kw">length</span>(input$cmip5models)
            x1 &lt;-<span class="st"> </span><span class="kw">split</span>(x, x$Model)
            v1 &lt;-<span class="st"> </span><span class="kw">Reduce</span>(<span class="st">&quot;+&quot;</span>, <span class="kw">lapply</span>(x1, <span class="st">&quot;[&quot;</span>, <span class="kw">c</span>(<span class="st">&quot;Val&quot;</span>)))[, <span class="dv">1</span>]/n
            x1[[<span class="dv">1</span>]]$Model &lt;-<span class="st"> </span><span class="kw">paste0</span>(n, <span class="st">&quot;-Model Avg&quot;</span>)
            x &lt;-<span class="st"> </span>x1[[<span class="dv">1</span>]]
            x$Val &lt;-<span class="st"> </span>v1
            x$Val[x$Var ==<span class="st"> &quot;Temperature&quot;</span>] &lt;-<span class="st"> </span><span class="kw">round</span>(x$Val[x$Var ==<span class="st"> &quot;Temperature&quot;</span>], 
                <span class="dv">1</span>)
            x$Val[x$Var ==<span class="st"> &quot;Precipitation&quot;</span>] &lt;-<span class="st"> </span><span class="kw">round</span>(x$Val[x$Var ==<span class="st"> &quot;Precipitation&quot;</span>])
        }
        if (input$convert_units) {
            prog_d_spatial$<span class="kw">set</span>(<span class="dt">message =</span> <span class="st">&quot;Unit conversion...&quot;</span>, <span class="dt">value =</span> <span class="fl">9.5</span>)
            x$Val[x$Var ==<span class="st"> &quot;Temperature&quot;</span>] &lt;-<span class="st"> </span><span class="kw">round</span>((<span class="dv">9</span>/<span class="dv">5</span>) *<span class="st"> </span>x$Val[x$Var ==<span class="st"> &quot;Temperature&quot;</span>] +<span class="st"> </span>
<span class="st">                </span><span class="dv">32</span>, <span class="dv">1</span>)
            x$Val[x$Var ==<span class="st"> &quot;Precipitation&quot;</span>] &lt;-<span class="st"> </span><span class="kw">round</span>(x$Val[x$Var ==<span class="st"> &quot;Precipitation&quot;</span>]/<span class="fl">25.4</span>, 
                <span class="dv">3</span>)
        }
        prog_d_spatial$<span class="kw">set</span>(<span class="dt">message =</span> <span class="st">&quot;GCM distributions complete.&quot;</span>, <span class="dt">value =</span> <span class="dv">10</span>)
        <span class="kw">rownames</span>(x) &lt;-<span class="st"> </span><span class="ot">NULL</span>
    })
    x
})</code></pre>
</div>
<div id="master-cru-distributions-data-set" class="section level4">
<h4>Master CRU distributions data set</h4>
<pre class="sourceCode r"><code class="sourceCode r">CRU_spatial &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    #### All CRU datasets require recoding for externalization
    if (<span class="kw">goBtnNullOrZero</span>()) 
        <span class="kw">return</span>()
    <span class="co"># prog_d_cru_spatial &lt;- Progress$new(session, min=1, max=10)</span>
    <span class="co"># on.exit(prog_d_cru_spatial$close())</span>
    <span class="kw">isolate</span>(if (<span class="kw">is.null</span>(<span class="kw">Months_original</span>()) |<span class="st"> </span><span class="kw">is.null</span>(input$vars) |<span class="st"> </span><span class="kw">is.null</span>(input$convert_units) |<span class="st"> </span>
<span class="st">        </span><span class="kw">locSelected</span>() ==<span class="st"> </span><span class="ot">FALSE</span>) {
        x &lt;-<span class="st"> </span><span class="ot">NULL</span>
    } else {
        <span class="co"># prog_d_cru_spatial$set(message=&#39;Subsetting CRU 3.2 spatial</span>
        <span class="co"># distributions...&#39;, value=1)</span>
        if (input$loctype ==<span class="st"> &quot;Cities&quot;</span> &amp;&amp;<span class="st"> </span><span class="kw">length</span>(input$locs_cities) &amp;&amp;<span class="st"> </span>input$locs_cities[<span class="dv">1</span>] !=<span class="st"> </span>
<span class="st">            &quot;&quot;</span>) {
            x &lt;-<span class="st"> </span><span class="kw">subset</span>(d.cities.cru31, Month %in%<span class="st"> </span>month.abb[<span class="kw">match</span>(<span class="kw">Months_original</span>(), 
                month.abb)] &amp;<span class="st"> </span>Year %in%<span class="st"> </span><span class="kw">currentYears</span>() &amp;<span class="st"> </span>Decade %in%<span class="st"> </span><span class="kw">substr</span>(<span class="kw">Decades_original</span>(), 
                <span class="dv">1</span>, <span class="dv">4</span>) &amp;<span class="st"> </span>Location %in%<span class="st"> </span>input$locs_cities)
        } else if (input$loctype !=<span class="st"> &quot;Cities&quot;</span>) {
            reg.nam &lt;-<span class="st"> </span><span class="kw">sort</span>(region.names.out[[input$loctype]])
            region.ind &lt;-<span class="st"> </span><span class="kw">which</span>(reg.nam %in%<span class="st"> </span><span class="kw">Locs</span>())
            for (i in <span class="dv">1</span>:<span class="kw">length</span>(region.ind)) {
                <span class="kw">load</span>(<span class="kw">paste0</span>(region.cru.samples.files[[input$loctype]][region.ind[i]], 
                  <span class="st">&quot;/&quot;</span>, <span class="kw">tolower</span>(input$vars[<span class="dv">1</span>]), <span class="st">&quot;.RData&quot;</span>), <span class="dt">envir =</span> <span class="kw">environment</span>())  <span class="co"># Still can only load one variable file, okay as long as app only contains T &amp; P</span>
                cru32.samples.df[, samples.columns.cru] &lt;-<span class="st"> </span>rsd.cru/<span class="kw">rep</span>(samples.multipliers.cru, 
                  <span class="dt">each =</span> <span class="kw">length</span>(rsd.cru)/<span class="dv">2</span>)
                cru32.samples.df$Var &lt;-<span class="st"> </span>input$vars[<span class="dv">1</span>]
                cru32.samples.df$Location &lt;-<span class="st"> </span>reg.nam[region.ind[i]]
                if (i ==<span class="st"> </span><span class="dv">1</span>) 
                  rsd.cru.final &lt;-<span class="st"> </span>cru32.samples.df else rsd.cru.final &lt;-<span class="st"> </span><span class="kw">rbind</span>(rsd.cru.final, cru32.samples.df)
            }
            x &lt;-<span class="st"> </span><span class="kw">subset</span>(rsd.cru.final, Month %in%<span class="st"> </span>month.abb[<span class="kw">match</span>(<span class="kw">Months_original</span>(), 
                month.abb)] &amp;<span class="st"> </span>Year %in%<span class="st"> </span><span class="kw">currentYears</span>() &amp;<span class="st"> </span>Decade %in%<span class="st"> </span><span class="kw">substr</span>(<span class="kw">Decades_original</span>(), 
                <span class="dv">1</span>, <span class="dv">4</span>))  <span class="co"># &amp; Location %in% input$locs_regions &amp; Var %in% input$vars[1])</span>
        }
        if (<span class="kw">nrow</span>(x) ==<span class="st"> </span><span class="dv">0</span>) 
            <span class="kw">return</span>()
        rnd &lt;-<span class="st"> </span>if (input$vars[<span class="dv">1</span>] ==<span class="st"> &quot;Precipitation&quot;</span>) 
            <span class="dv">0</span> else <span class="dv">1</span>
        <span class="co"># prog_d_cru_spatial$set(message=&#39;CRU 3.2 bootstrap resampling...&#39;, value=3)</span>
        x &lt;-<span class="st"> </span><span class="kw">density2bootstrap</span>(x, <span class="dt">n.density =</span> n.samples, <span class="dt">n.boot =</span> <span class="kw">BootSamples</span>(), 
            <span class="dt">interp =</span> <span class="ot">TRUE</span>, <span class="dt">n.interp =</span> <span class="dv">1000</span>, <span class="dt">digits =</span> rnd)  <span class="co"># n.boot and n.interp values tentative</span>
        if (!<span class="kw">is.null</span>(input$months2seasons) &amp;&amp;<span class="st"> </span>input$months2seasons) {
            <span class="co"># prog_d_cru_spatial$set(message=&#39;CRU 3.2 spatial distributions: aggregating</span>
            <span class="co"># months...&#39;, value=7)</span>
            x &lt;-<span class="st"> </span><span class="kw">collapseMonths</span>(x, <span class="st">&quot;Val&quot;</span>, <span class="kw">as.numeric</span>(input$n_seasons), <span class="kw">Months_original</span>(), 
                <span class="dt">n.samples =</span> <span class="dv">1000</span>)
        }
        if (!<span class="kw">is.null</span>(input$decades2periods) &amp;&amp;<span class="st"> </span>input$decades2periods) {
            <span class="co"># prog_d_cru_spatial$set(message=&#39;CRU 3.2 spatial distributions: aggregating</span>
            <span class="co"># decades...&#39;, value=8)</span>
            x &lt;-<span class="st"> </span><span class="kw">periodsFromDecades</span>(x, <span class="kw">as.numeric</span>(input$n_periods), <span class="kw">Decades_original</span>(), 
                <span class="dt">check.years =</span> <span class="ot">TRUE</span>, <span class="dt">n.samples =</span> <span class="dv">1000</span>)
        }
        if (<span class="kw">is.null</span>(x)) 
            <span class="kw">return</span>()
        <span class="co"># data from only one phase with multiple models in that phase selected, or</span>
        <span class="co"># two phases with equal number &gt; 1 of models selected from each phase.</span>
        <span class="co"># Otherwise compositing prohibited.</span>
        if (input$convert_units) {
            <span class="co"># prog_d_cru_spatial$set(message=&#39;Unit conversion...&#39;, value=9)</span>
            x$Val[x$Var ==<span class="st"> &quot;Temperature&quot;</span>] &lt;-<span class="st"> </span><span class="kw">round</span>((<span class="dv">9</span>/<span class="dv">5</span>) *<span class="st"> </span>x$Val[x$Var ==<span class="st"> &quot;Temperature&quot;</span>] +<span class="st"> </span>
<span class="st">                </span><span class="dv">32</span>, <span class="dv">1</span>)
            x$Val[x$Var ==<span class="st"> &quot;Precipitation&quot;</span>] &lt;-<span class="st"> </span><span class="kw">round</span>(x$Val[x$Var ==<span class="st"> &quot;Precipitation&quot;</span>]/<span class="fl">25.4</span>, 
                <span class="dv">3</span>)
        }
        <span class="kw">rownames</span>(x) &lt;-<span class="st"> </span><span class="ot">NULL</span>
        x$Model &lt;-<span class="st"> </span>x$Scenario &lt;-<span class="st"> </span>x$Phase &lt;-<span class="st"> &quot;CRU 3.2&quot;</span>
        <span class="co"># prog_d_cru_spatial$set(message=&#39;CRU 3.2 distributions complete.&#39;,</span>
        <span class="co"># value=10)</span>
        x &lt;-<span class="st"> </span>x[<span class="kw">c</span>(<span class="kw">ncol</span>(x) -<span class="st"> </span><span class="kw">c</span>(<span class="dv">2</span>:<span class="dv">0</span>), <span class="dv">1</span>:(<span class="kw">ncol</span>(x) -<span class="st"> </span><span class="dv">3</span>))]
    })
    x
})</code></pre>
<p>The below plot-specific reactive expresssions pertain grouping, faceting, and pooling, and additinal plot settings where applicable.</p>
</div>
<div id="time-series" class="section level4">
<h4>Time series</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># ggplot2 grouping, faceting, pooling</span>
groupFacetChoicesTS &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    if (!<span class="kw">is.null</span>(input$xtime)) {
        if (input$xtime ==<span class="st"> &quot;Year&quot;</span>) {
            ind &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">unlist</span>(<span class="kw">lapply</span>(<span class="kw">list</span>(phases, <span class="kw">models</span>(), <span class="kw">scenarios</span>(), <span class="kw">Months</span>(), 
                <span class="kw">Decades</span>(), <span class="kw">Locs</span>()), length)) &gt;<span class="st"> </span><span class="dv">1</span>)
            choices &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Phase&quot;</span>, <span class="st">&quot;Model&quot;</span>, <span class="st">&quot;Scenario&quot;</span>, <span class="st">&quot;Month&quot;</span>, <span class="st">&quot;Decade&quot;</span>, <span class="st">&quot;Location&quot;</span>)[ind]
        } else if (input$xtime ==<span class="st"> &quot;Month&quot;</span>) {
            ind &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">unlist</span>(<span class="kw">lapply</span>(<span class="kw">list</span>(phases, <span class="kw">models</span>(), <span class="kw">scenarios</span>(), <span class="kw">Decades</span>(), 
                <span class="kw">Locs</span>()), length)) &gt;<span class="st"> </span><span class="dv">1</span>)
            choices &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Phase&quot;</span>, <span class="st">&quot;Model&quot;</span>, <span class="st">&quot;Scenario&quot;</span>, <span class="st">&quot;Decade&quot;</span>, <span class="st">&quot;Location&quot;</span>)[ind]
        } else if (input$xtime ==<span class="st"> &quot;Decade&quot;</span>) {
            ind &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">unlist</span>(<span class="kw">lapply</span>(<span class="kw">list</span>(phases, <span class="kw">models</span>(), <span class="kw">scenarios</span>(), <span class="kw">Months</span>(), 
                <span class="kw">Locs</span>()), length)) &gt;<span class="st"> </span><span class="dv">1</span>)
            choices &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Phase&quot;</span>, <span class="st">&quot;Model&quot;</span>, <span class="st">&quot;Scenario&quot;</span>, <span class="st">&quot;Month&quot;</span>, <span class="st">&quot;Location&quot;</span>)[ind]
        }
        choices &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;None&quot;</span>, choices)
        if (<span class="kw">length</span>(<span class="kw">scenarios</span>()) &lt;<span class="st"> </span><span class="dv">2</span>) 
            choices &lt;-<span class="st"> </span>choices[choices !=<span class="st"> &quot;Scenario&quot;</span>]
        if (<span class="kw">length</span>(<span class="kw">models</span>()) &lt;<span class="st"> </span><span class="dv">2</span>) 
            choices &lt;-<span class="st"> </span>choices[choices !=<span class="st"> &quot;Model&quot;</span>]
        if (!<span class="kw">length</span>(input$cmip3scens) |<span class="st"> </span>!<span class="kw">length</span>(input$cmip5scens)) 
            choices &lt;-<span class="st"> </span>choices[choices !=<span class="st"> &quot;Phase&quot;</span>]
        if (!<span class="kw">length</span>(input$cmip3models) |<span class="st"> </span>!<span class="kw">length</span>(input$cmip5models)) 
            choices &lt;-<span class="st"> </span>choices[choices !=<span class="st"> &quot;Phase&quot;</span>]
        if (!<span class="kw">is.null</span>(choices) &amp;&amp;<span class="st"> </span><span class="kw">length</span>(choices) ==<span class="st"> </span><span class="dv">1</span>) 
            choices &lt;-<span class="st"> </span><span class="ot">NULL</span>
    } else choices &lt;-<span class="st"> </span><span class="ot">NULL</span>
    choices
})

n.groups &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">nGroups</span>(input$group, <span class="kw">scenarios</span>(), <span class="kw">models</span>(), input$mos, input$decs, <span class="kw">Locs</span>())
})

facet.panels &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">getFacetPanels</span>(input$facet, <span class="kw">models</span>(), <span class="kw">scenarios</span>(), input$mos, input$decs, 
        <span class="kw">Locs</span>())
})

pooled.var &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    x &lt;-<span class="st"> </span><span class="kw">getPooledVars</span>(<span class="dt">inx =</span> input$xtime, <span class="dt">ingrp =</span> input$group, <span class="dt">infct =</span> input$facet, 
        <span class="dt">grp.fct.choices =</span> <span class="kw">groupFacetChoicesTS</span>(), <span class="dt">choices =</span> <span class="kw">c</span>(<span class="st">&quot;Phase&quot;</span>, <span class="st">&quot;Scenario&quot;</span>, 
            <span class="st">&quot;Model&quot;</span>, <span class="st">&quot;Month&quot;</span>, <span class="st">&quot;Year&quot;</span>, <span class="st">&quot;Decade&quot;</span>, <span class="st">&quot;Location&quot;</span>), <span class="dt">mos =</span> <span class="kw">Months</span>(), 
        <span class="dt">years =</span> <span class="kw">currentYears</span>(), <span class="dt">decades =</span> <span class="kw">Decades</span>(), <span class="dt">locs =</span> <span class="kw">Locs</span>(), <span class="dt">scenarios =</span> <span class="kw">scenarios</span>(), 
        <span class="dt">models =</span> <span class="kw">models</span>(), <span class="dt">cmip3scens =</span> input$cmip3scens, <span class="dt">cmip5scens =</span> input$cmip5scens, 
        <span class="dt">cmip3mods =</span> input$cmip3models, <span class="dt">cmip5mods =</span> input$cmip5models)
    x
})

subjectChoices &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">getSubjectChoices</span>(<span class="dt">inx =</span> input$xtime, <span class="dt">ingrp =</span> input$group, <span class="dt">pooled.vars =</span> <span class="kw">pooled.var</span>())
})</code></pre>
</div>
<div id="scatter-plot" class="section level4">
<h4>Scatter plot</h4>
<pre class="sourceCode r"><code class="sourceCode r">sc_flip_xy &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    if (<span class="kw">is.null</span>(<span class="kw">c</span>(input$vars, input$vars2))) 
        <span class="kw">return</span>(<span class="ot">FALSE</span>)
    if (input$sc_x ==<span class="st"> </span>input$vars) 
        <span class="ot">FALSE</span> else <span class="ot">TRUE</span>
})

groupFacetChoicesScatter &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    ind &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">unlist</span>(<span class="kw">lapply</span>(<span class="kw">list</span>(phases, <span class="kw">models</span>(), <span class="kw">scenarios</span>(), <span class="kw">Months</span>(), 
        <span class="kw">Decades</span>(), <span class="kw">Locs</span>()), length)) &gt;<span class="st"> </span><span class="dv">1</span>)
    choices &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;None&quot;</span>, <span class="kw">c</span>(<span class="st">&quot;Phase&quot;</span>, <span class="st">&quot;Model&quot;</span>, <span class="st">&quot;Scenario&quot;</span>, <span class="st">&quot;Month&quot;</span>, <span class="st">&quot;Decade&quot;</span>, 
        <span class="st">&quot;Location&quot;</span>)[ind])
    if (!<span class="kw">is.null</span>(choices)) {
        if (<span class="kw">length</span>(<span class="kw">scenarios</span>()) &lt;<span class="st"> </span><span class="dv">2</span>) 
            choices &lt;-<span class="st"> </span>choices[choices !=<span class="st"> &quot;Scenario&quot;</span>]
        if (<span class="kw">length</span>(<span class="kw">models</span>()) &lt;<span class="st"> </span><span class="dv">2</span>) 
            choices &lt;-<span class="st"> </span>choices[choices !=<span class="st"> &quot;Model&quot;</span>]
        if (!<span class="kw">length</span>(input$cmip3scens) |<span class="st"> </span>!<span class="kw">length</span>(input$cmip5scens)) 
            choices &lt;-<span class="st"> </span>choices[choices !=<span class="st"> &quot;Phase&quot;</span>]
        if (!<span class="kw">length</span>(input$cmip3models) |<span class="st"> </span>!<span class="kw">length</span>(input$cmip5models)) 
            choices &lt;-<span class="st"> </span>choices[choices !=<span class="st"> &quot;Phase&quot;</span>]
        if (!<span class="kw">is.null</span>(choices) &amp;&amp;<span class="st"> </span><span class="kw">length</span>(choices) ==<span class="st"> </span><span class="dv">1</span>) 
            choices &lt;-<span class="st"> </span><span class="ot">NULL</span>
    } else choices &lt;-<span class="st"> </span><span class="ot">NULL</span>
    choices
})

n.groups2 &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">nGroups</span>(input$group2, <span class="kw">scenarios</span>(), <span class="kw">models</span>(), input$mos, input$decs, <span class="kw">Locs</span>())
})

facet.panels2 &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">getFacetPanels</span>(input$facet2, <span class="kw">models</span>(), <span class="kw">scenarios</span>(), input$mos, input$decs, 
        <span class="kw">Locs</span>())
})

pooled.var2 &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    x &lt;-<span class="st"> </span><span class="kw">getPooledVars</span>(<span class="dt">inx =</span> input$sc_x, <span class="dt">ingrp =</span> input$group2, <span class="dt">infct =</span> input$facet2, 
        <span class="dt">grp.fct.choices =</span> <span class="kw">groupFacetChoicesScatter</span>(), <span class="dt">choices =</span> <span class="kw">c</span>(<span class="st">&quot;Phase&quot;</span>, <span class="st">&quot;Scenario&quot;</span>, 
            <span class="st">&quot;Model&quot;</span>, <span class="st">&quot;Month&quot;</span>, <span class="st">&quot;Year&quot;</span>, <span class="st">&quot;Decade&quot;</span>, <span class="st">&quot;Location&quot;</span>), <span class="dt">mos =</span> <span class="kw">Months</span>(), 
        <span class="dt">years =</span> <span class="kw">currentYears</span>(), <span class="dt">decades =</span> <span class="kw">Decades</span>(), <span class="dt">locs =</span> <span class="kw">Locs</span>(), <span class="dt">scenarios =</span> <span class="kw">scenarios</span>(), 
        <span class="dt">models =</span> <span class="kw">models</span>(), <span class="dt">cmip3scens =</span> input$cmip3scens, <span class="dt">cmip5scens =</span> input$cmip5scens, 
        <span class="dt">cmip3mods =</span> input$cmip3models, <span class="dt">cmip5mods =</span> input$cmip5models)
    x
})</code></pre>
</div>
<div id="heat-map" class="section level4">
<h4>Heat map</h4>
<pre class="sourceCode r"><code class="sourceCode r">heatmap_x_choices &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">getHeatmapAxisChoices</span>(<span class="kw">scenarios</span>(), <span class="kw">models</span>(), <span class="kw">Locs</span>(), <span class="kw">Months</span>(), <span class="kw">currentYears</span>(), 
        <span class="kw">Decades</span>(), input$cmip3scens, input$cmip5scens, input$cmip3models, input$cmip5models)
})

heatmap_y_choices &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">getHeatmapAxisChoices</span>(<span class="kw">scenarios</span>(), <span class="kw">models</span>(), <span class="kw">Locs</span>(), <span class="kw">Months</span>(), <span class="kw">currentYears</span>(), 
        <span class="kw">Decades</span>(), input$cmip3scens, input$cmip5scens, input$cmip3models, input$cmip5models)
})

facetChoicesHeatmap &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">getFacetChoicesHeatmap</span>(<span class="dt">inx =</span> input$heatmap_x, <span class="dt">iny =</span> input$heatmap_y, <span class="dt">x.choices =</span> <span class="kw">heatmap_x_choices</span>())
})

facetPanelsHeatmap &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">getFacetPanels</span>(input$facetHeatmap, <span class="kw">models</span>(), <span class="kw">scenarios</span>(), input$mos, input$decs, 
        <span class="kw">Locs</span>())
})

pooledVarHeatmap &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    x &lt;-<span class="st"> </span><span class="kw">getPooledVars</span>(<span class="dt">inx =</span> input$heatmap_x, <span class="dt">iny =</span> input$heatmap_y, <span class="dt">infct =</span> input$facetHeatmap, 
        <span class="dt">grp.fct.choices =</span> <span class="kw">facetChoicesHeatmap</span>(), <span class="dt">choices =</span> <span class="kw">c</span>(<span class="st">&quot;Phase&quot;</span>, <span class="st">&quot;Scenario&quot;</span>, 
            <span class="st">&quot;Model&quot;</span>, <span class="st">&quot;Month&quot;</span>, <span class="st">&quot;Year&quot;</span>, <span class="st">&quot;Decade&quot;</span>, <span class="st">&quot;Location&quot;</span>), <span class="dt">mos =</span> <span class="kw">Months</span>(), 
        <span class="dt">years =</span> <span class="kw">currentYears</span>(), <span class="dt">decades =</span> <span class="kw">Decades</span>(), <span class="dt">locs =</span> <span class="kw">Locs</span>(), <span class="dt">scenarios =</span> <span class="kw">scenarios</span>(), 
        <span class="dt">models =</span> <span class="kw">models</span>(), <span class="dt">cmip3scens =</span> input$cmip3scens, <span class="dt">cmip5scens =</span> input$cmip5scens, 
        <span class="dt">cmip3mods =</span> input$cmip3models, <span class="dt">cmip5mods =</span> input$cmip5models)
    x
})</code></pre>
</div>
<div id="variability-plots" class="section level4">
<h4>Variability plots</h4>
<pre class="sourceCode r"><code class="sourceCode r">xvarChoices &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    ind &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">unlist</span>(<span class="kw">lapply</span>(<span class="kw">list</span>(phases, <span class="kw">scenarios</span>(), <span class="kw">models</span>(), <span class="kw">Locs</span>(), <span class="kw">Months</span>(), 
        <span class="kw">currentYears</span>(), <span class="kw">Decades</span>()), length)) &gt;<span class="st"> </span><span class="dv">1</span>)
    if (<span class="kw">length</span>(ind)) 
        choices &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Phase&quot;</span>, <span class="st">&quot;Scenario&quot;</span>, <span class="st">&quot;Model&quot;</span>, <span class="st">&quot;Location&quot;</span>, <span class="st">&quot;Month&quot;</span>, <span class="st">&quot;Year&quot;</span>, 
            <span class="st">&quot;Decade&quot;</span>)[ind] else choices &lt;-<span class="st"> </span><span class="ot">NULL</span>
    if (<span class="kw">length</span>(choices)) {
        if (<span class="kw">length</span>(<span class="kw">scenarios</span>()) &lt;<span class="st"> </span><span class="dv">2</span>) 
            choices &lt;-<span class="st"> </span>choices[choices !=<span class="st"> &quot;Scenario&quot;</span>]
        if (<span class="kw">length</span>(<span class="kw">models</span>()) &lt;<span class="st"> </span><span class="dv">2</span>) 
            choices &lt;-<span class="st"> </span>choices[choices !=<span class="st"> &quot;Model&quot;</span>]
        if (!<span class="kw">length</span>(input$cmip3scens) |<span class="st"> </span>!<span class="kw">length</span>(input$cmip5scens)) 
            choices &lt;-<span class="st"> </span>choices[choices !=<span class="st"> &quot;Phase&quot;</span>]
        if (!<span class="kw">length</span>(input$cmip3models) |<span class="st"> </span>!<span class="kw">length</span>(input$cmip5models)) 
            choices &lt;-<span class="st"> </span>choices[choices !=<span class="st"> &quot;Phase&quot;</span>]
    } else choices &lt;-<span class="st"> </span><span class="ot">NULL</span>
    choices
})

groupFacetChoicesVar &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    if (!<span class="kw">is.null</span>(input$xvar)) {
        ind &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">unlist</span>(<span class="kw">lapply</span>(<span class="kw">list</span>(phases, <span class="kw">models</span>(), <span class="kw">scenarios</span>(), <span class="kw">Months</span>(), 
            <span class="kw">Decades</span>(), <span class="kw">Locs</span>()), length)) &gt;<span class="st"> </span><span class="dv">1</span>)
        choices &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;None&quot;</span>, <span class="kw">c</span>(<span class="st">&quot;Phase&quot;</span>, <span class="st">&quot;Model&quot;</span>, <span class="st">&quot;Scenario&quot;</span>, <span class="st">&quot;Month&quot;</span>, <span class="st">&quot;Decade&quot;</span>, 
            <span class="st">&quot;Location&quot;</span>)[ind])
        if (!<span class="kw">is.null</span>(choices)) {
            choices &lt;-<span class="st"> </span>choices[choices !=<span class="st"> </span>input$xvar]
            if (<span class="kw">length</span>(<span class="kw">scenarios</span>()) &lt;<span class="st"> </span><span class="dv">2</span>) 
                choices &lt;-<span class="st"> </span>choices[choices !=<span class="st"> &quot;Scenario&quot;</span>]
            if (<span class="kw">length</span>(<span class="kw">models</span>()) &lt;<span class="st"> </span><span class="dv">2</span>) 
                choices &lt;-<span class="st"> </span>choices[choices !=<span class="st"> &quot;Model&quot;</span>]
            if (!<span class="kw">length</span>(input$cmip3scens) |<span class="st"> </span>!<span class="kw">length</span>(input$cmip5scens)) 
                choices &lt;-<span class="st"> </span>choices[choices !=<span class="st"> &quot;Phase&quot;</span>]
            if (!<span class="kw">length</span>(input$cmip3models) |<span class="st"> </span>!<span class="kw">length</span>(input$cmip5models)) 
                choices &lt;-<span class="st"> </span>choices[choices !=<span class="st"> &quot;Phase&quot;</span>]
            if (!<span class="kw">is.null</span>(choices) &amp;&amp;<span class="st"> </span><span class="kw">length</span>(choices) ==<span class="st"> </span><span class="dv">1</span>) 
                choices &lt;-<span class="st"> </span><span class="ot">NULL</span>
        } else choices &lt;-<span class="st"> </span><span class="ot">NULL</span>
    } else choices &lt;-<span class="st"> </span><span class="ot">NULL</span>
    choices
})

n.groups3 &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">nGroups</span>(input$group3, <span class="kw">scenarios</span>(), <span class="kw">models</span>(), input$mos, input$decs, <span class="kw">Locs</span>())
})

facet.panels3 &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">getFacetPanels</span>(input$facet3, <span class="kw">models</span>(), <span class="kw">scenarios</span>(), input$mos, input$decs, 
        <span class="kw">Locs</span>())
})

pooled.var3 &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    x &lt;-<span class="st"> </span><span class="kw">getPooledVars</span>(<span class="dt">inx =</span> input$xvar, <span class="dt">ingrp =</span> input$group3, <span class="dt">infct =</span> input$facet3, 
        <span class="dt">grp.fct.choices =</span> <span class="kw">groupFacetChoicesVar</span>(), <span class="dt">choices =</span> <span class="kw">c</span>(<span class="st">&quot;Phase&quot;</span>, <span class="st">&quot;Scenario&quot;</span>, 
            <span class="st">&quot;Model&quot;</span>, <span class="st">&quot;Month&quot;</span>, <span class="st">&quot;Year&quot;</span>, <span class="st">&quot;Decade&quot;</span>, <span class="st">&quot;Location&quot;</span>), <span class="dt">mos =</span> <span class="kw">Months</span>(), 
        <span class="dt">years =</span> <span class="kw">currentYears</span>(), <span class="dt">decades =</span> <span class="kw">Decades</span>(), <span class="dt">locs =</span> <span class="kw">Locs</span>(), <span class="dt">scenarios =</span> <span class="kw">scenarios</span>(), 
        <span class="dt">models =</span> <span class="kw">models</span>(), <span class="dt">cmip3scens =</span> input$cmip3scens, <span class="dt">cmip5scens =</span> input$cmip5scens, 
        <span class="dt">cmip3mods =</span> input$cmip3models, <span class="dt">cmip5mods =</span> input$cmip5models)
    x
})

subjectChoices3 &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">getSubjectChoices</span>(<span class="dt">inx =</span> input$xvar, <span class="dt">ingrp =</span> input$group3, <span class="dt">pooled.vars =</span> <span class="kw">pooled.var3</span>())
})

Variability &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    if (!<span class="kw">is.null</span>(input$variability)) 
        !input$variability else <span class="ot">NULL</span>
})</code></pre>
</div>
<div id="distribution-plots" class="section level4">
<h4>Distribution plots</h4>
<pre class="sourceCode r"><code class="sourceCode r">spatial_x_choices &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    ind &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">unlist</span>(<span class="kw">lapply</span>(<span class="kw">list</span>(phases, <span class="kw">scenarios</span>(), <span class="kw">models</span>(), <span class="kw">Locs</span>(), <span class="kw">Months</span>(), 
        <span class="kw">currentYears</span>(), <span class="kw">Decades</span>()), length)) &gt;<span class="st"> </span><span class="dv">1</span>)
    if (<span class="kw">length</span>(ind)) 
        choices &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Phase&quot;</span>, <span class="st">&quot;Scenario&quot;</span>, <span class="st">&quot;Model&quot;</span>, <span class="st">&quot;Location&quot;</span>, <span class="st">&quot;Month&quot;</span>, <span class="st">&quot;Year&quot;</span>, 
            <span class="st">&quot;Decade&quot;</span>)[ind] else choices &lt;-<span class="st"> </span><span class="ot">NULL</span>
    if (<span class="kw">length</span>(choices)) {
        if (!<span class="kw">is.null</span>(input$vars)) 
            choices &lt;-<span class="st"> </span><span class="kw">c</span>(input$vars[<span class="dv">1</span>], choices)
        if (<span class="kw">length</span>(<span class="kw">scenarios</span>()) &lt;<span class="st"> </span><span class="dv">2</span>) 
            choices &lt;-<span class="st"> </span>choices[choices !=<span class="st"> &quot;Scenario&quot;</span>]
        if (<span class="kw">length</span>(<span class="kw">models</span>()) &lt;<span class="st"> </span><span class="dv">2</span>) 
            choices &lt;-<span class="st"> </span>choices[choices !=<span class="st"> &quot;Model&quot;</span>]
        if (!<span class="kw">length</span>(input$cmip3scens) |<span class="st"> </span>!<span class="kw">length</span>(input$cmip5scens)) 
            choices &lt;-<span class="st"> </span>choices[choices !=<span class="st"> &quot;Phase&quot;</span>]
        if (!<span class="kw">length</span>(input$cmip3models) |<span class="st"> </span>!<span class="kw">length</span>(input$cmip5models)) 
            choices &lt;-<span class="st"> </span>choices[choices !=<span class="st"> &quot;Phase&quot;</span>]
    } else choices &lt;-<span class="st"> </span><span class="ot">NULL</span>
    choices
})

groupFacetChoicesSpatial &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    if (!<span class="kw">is.null</span>(input$spatial_x)) {
        ind &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">unlist</span>(<span class="kw">lapply</span>(<span class="kw">list</span>(phases, <span class="kw">models</span>(), <span class="kw">scenarios</span>(), <span class="kw">Months</span>(), 
            <span class="kw">Decades</span>(), <span class="kw">Locs</span>()), length)) &gt;<span class="st"> </span><span class="dv">1</span>)
        choices &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;None&quot;</span>, <span class="kw">c</span>(<span class="st">&quot;Phase&quot;</span>, <span class="st">&quot;Model&quot;</span>, <span class="st">&quot;Scenario&quot;</span>, <span class="st">&quot;Month&quot;</span>, <span class="st">&quot;Decade&quot;</span>, 
            <span class="st">&quot;Location&quot;</span>)[ind])
        if (!<span class="kw">is.null</span>(choices)) {
            choices &lt;-<span class="st"> </span>choices[choices !=<span class="st"> </span>input$spatial_x]
            if (<span class="kw">length</span>(<span class="kw">scenarios</span>()) &lt;<span class="st"> </span><span class="dv">2</span>) 
                choices &lt;-<span class="st"> </span>choices[choices !=<span class="st"> &quot;Scenario&quot;</span>]
            if (<span class="kw">length</span>(<span class="kw">models</span>()) &lt;<span class="st"> </span><span class="dv">2</span>) 
                choices &lt;-<span class="st"> </span>choices[choices !=<span class="st"> &quot;Model&quot;</span>]
            if (!<span class="kw">length</span>(input$cmip3scens) |<span class="st"> </span>!<span class="kw">length</span>(input$cmip5scens)) 
                choices &lt;-<span class="st"> </span>choices[choices !=<span class="st"> &quot;Phase&quot;</span>]
            if (!<span class="kw">length</span>(input$cmip3models) |<span class="st"> </span>!<span class="kw">length</span>(input$cmip5models)) 
                choices &lt;-<span class="st"> </span>choices[choices !=<span class="st"> &quot;Phase&quot;</span>]
            if (!<span class="kw">is.null</span>(choices) &amp;&amp;<span class="st"> </span><span class="kw">length</span>(choices) ==<span class="st"> </span><span class="dv">1</span>) 
                choices &lt;-<span class="st"> </span><span class="ot">NULL</span>
        } else choices &lt;-<span class="st"> </span><span class="ot">NULL</span>
    } else choices &lt;-<span class="st"> </span><span class="ot">NULL</span>
    choices
})

nGroupsSpatial &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">nGroups</span>(input$groupSpatial, <span class="kw">scenarios</span>(), <span class="kw">models</span>(), input$mos, input$decs, 
        <span class="kw">Locs</span>())
})

facetPanelsSpatial &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">getFacetPanels</span>(input$facetSpatial, <span class="kw">models</span>(), <span class="kw">scenarios</span>(), input$mos, input$decs, 
        <span class="kw">Locs</span>())
})

pooledVarSpatial &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    x &lt;-<span class="st"> </span><span class="kw">getPooledVars</span>(<span class="dt">inx =</span> input$spatial_x, <span class="dt">ingrp =</span> input$groupSpatial, <span class="dt">infct =</span> input$facetSpatial, 
        <span class="dt">grp.fct.choices =</span> <span class="kw">groupFacetChoicesSpatial</span>(), <span class="dt">choices =</span> <span class="kw">c</span>(<span class="st">&quot;Phase&quot;</span>, <span class="st">&quot;Scenario&quot;</span>, 
            <span class="st">&quot;Model&quot;</span>, <span class="st">&quot;Month&quot;</span>, <span class="st">&quot;Year&quot;</span>, <span class="st">&quot;Decade&quot;</span>, <span class="st">&quot;Location&quot;</span>), <span class="dt">mos =</span> <span class="kw">Months</span>(), 
        <span class="dt">years =</span> <span class="kw">currentYears</span>(), <span class="dt">decades =</span> <span class="kw">Decades</span>(), <span class="dt">locs =</span> <span class="kw">Locs</span>(), <span class="dt">scenarios =</span> <span class="kw">scenarios</span>(), 
        <span class="dt">models =</span> <span class="kw">models</span>(), <span class="dt">cmip3scens =</span> input$cmip3scens, <span class="dt">cmip5scens =</span> input$cmip5scens, 
        <span class="dt">cmip3mods =</span> input$cmip3models, <span class="dt">cmip5mods =</span> input$cmip5models)
    x
})

subjectChoicesSpatial &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">getSubjectChoices</span>(<span class="dt">inx =</span> input$spatial_x, <span class="dt">ingrp =</span> input$groupSpatial, <span class="dt">pooled.vars =</span> <span class="kw">pooledVarSpatial</span>())
})

plotTypeChoicesSpatial &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    if (<span class="kw">is.null</span>(input$spatial_x)) 
        <span class="kw">return</span>()
    if (input$spatial_x ==<span class="st"> &quot;Temperature&quot;</span> |<span class="st"> </span>input$spatial_x ==<span class="st"> &quot;Precipitation&quot;</span>) 
        <span class="kw">c</span>(<span class="st">&quot;Histogram&quot;</span>, <span class="st">&quot;Density&quot;</span>) else <span class="kw">c</span>(<span class="st">&quot;Stripchart&quot;</span>)
})</code></pre>
</div>
<div id="data-aggregation" class="section level4">
<h4>Data aggregation</h4>
<p>These reactive expressions perform further data manipulation on input data sets so that summary statistics and aggregated information can be added to a plot.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Data aggregation</span>
datCollapseGroups &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    if (!<span class="kw">is.null</span>(<span class="kw">dat</span>()) &amp;<span class="st"> </span>!<span class="kw">is.null</span>(input$group)) {
        d &lt;-<span class="st"> </span><span class="kw">dat</span>()
        d[input$group] &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="st">&quot;Average&quot;</span>, <span class="kw">nrow</span>(<span class="kw">dat</span>()))
        d
    } else <span class="kw">return</span>()
})

datCollapsePooled &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    if (!<span class="kw">is.null</span>(<span class="kw">dat</span>())) {
        d &lt;-<span class="st"> </span><span class="kw">dat</span>()
        if (!<span class="kw">is.null</span>(<span class="kw">pooled.var</span>())) 
            for (k in <span class="dv">1</span>:<span class="kw">length</span>(<span class="kw">pooled.var</span>())) d[<span class="kw">pooled.var</span>()[k]] &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="st">&quot;Average&quot;</span>, 
                <span class="kw">nrow</span>(<span class="kw">dat</span>()))
        d
    } else <span class="kw">return</span>()
})

datCollapseGroups2 &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    if (!<span class="kw">is.null</span>(<span class="kw">dat2</span>()) &amp;<span class="st"> </span>!<span class="kw">is.null</span>(input$group)) {
        d &lt;-<span class="st"> </span><span class="kw">dat2</span>()
        d[input$group] &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="st">&quot;Average&quot;</span>, <span class="kw">nrow</span>(<span class="kw">dat2</span>()))
        d
    } else <span class="kw">return</span>()
})

datCollapsePooled2 &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    if (!<span class="kw">is.null</span>(<span class="kw">dat2</span>())) {
        d &lt;-<span class="st"> </span><span class="kw">dat2</span>()
        if (!<span class="kw">is.null</span>(<span class="kw">pooled.var</span>())) 
            for (k in <span class="dv">1</span>:<span class="kw">length</span>(<span class="kw">pooled.var</span>())) d[<span class="kw">pooled.var</span>()[k]] &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="st">&quot;Average&quot;</span>, 
                <span class="kw">nrow</span>(<span class="kw">dat2</span>()))
        d
    } else <span class="kw">return</span>()
})

stat &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    if (!<span class="kw">is.null</span>(input$variability)) {
        if (input$variability) 
            stat &lt;-<span class="st"> </span>input$errorBars else stat &lt;-<span class="st"> </span>input$dispersion
    }
    if (<span class="kw">is.null</span>(stat)) 
        stat &lt;-<span class="st"> &quot;SD&quot;</span>
    stat
})</code></pre>
</div>
<div id="plot-specific-color-sequences-based-on-input-data" class="section level4">
<h4>Plot-specific color sequences based on input data</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Color sequences</span>
colorseq_ts &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">getColorSeq</span>(<span class="dt">d =</span> <span class="kw">dat</span>(), <span class="dt">grp =</span> input$group, <span class="dt">n.grp =</span> <span class="kw">n.groups</span>())
})

colorseq_sc &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">getColorSeq</span>(<span class="dt">d =</span> <span class="kw">dat2</span>(), <span class="dt">grp =</span> input$group2, <span class="dt">n.grp =</span> <span class="kw">n.groups2</span>())
})

colorseq_hm &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">getColorSeq</span>(<span class="dt">d =</span> <span class="kw">dat_heatmap</span>(), <span class="dt">heat =</span> <span class="ot">TRUE</span>)
})

colorseq_vr &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">getColorSeq</span>(<span class="dt">d =</span> <span class="kw">dat</span>(), <span class="dt">grp =</span> input$group3, <span class="dt">n.grp =</span> <span class="kw">n.groups3</span>(), <span class="dt">overlay =</span> input$vr_showCRU)
})

colorseq_sp &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="kw">getColorSeq</span>(<span class="dt">d =</span> <span class="kw">dat_spatial</span>(), <span class="dt">grp =</span> input$groupSpatial, <span class="dt">n.grp =</span> <span class="kw">nGroupsSpatial</span>(), 
        <span class="dt">overlay =</span> input$sp_showCRU)
})</code></pre>
</div>
</div>
</div>


</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>


</body>
</html>
