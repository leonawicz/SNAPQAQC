<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />



<title>ALFRESCO Data Extraction: Function Code</title>

<script src="libs/jquery-1.11.0/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.1/css/cosmo.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.1/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/respond.min.js"></script>
<style type="text/css">
/* padding for bootstrap navbar */
body {
padding-top: 50px;
padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar) */
.section h2 {
padding-top: 55px;
margin-top: -55px;
}
.section h3 {
padding-top: 55px;
margin-top: -55px;
}
/* don't use link color in navbar */
.dropdown-menu>li>a {
color: black;
}
/* some padding for disqus */
#disqus_thread {
margin-top: 45px;
}
p {
  text-align: justify;
}
img.centered {
  display: block;
  margin-left: auto;
  margin-right: auto;
}
</style>
<link rel="stylesheet" href="libs/font-awesome-4.1.0/css/font-awesome.min.css"/>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; background-color: #303030; color: #cccccc; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; }
td.sourceCode { padding-left: 5px; }
pre, code { color: #cccccc; background-color: #303030; }
code > span.kw { color: #f0dfaf; }
code > span.dt { color: #dfdfbf; }
code > span.dv { color: #dcdccc; }
code > span.bn { color: #dca3a3; }
code > span.fl { color: #c0bed1; }
code > span.ch { color: #dca3a3; }
code > span.st { color: #cc9393; }
code > span.co { color: #7f9f7f; }
code > span.ot { color: #efef8f; }
code > span.al { color: #ffcfaf; }
code > span.fu { color: #efef8f; }
code > span.er { color: #c3bf9f; }
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>



<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-46129458-3', 'auto');
  ga('send', 'pageview');

</script>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img { 
  max-width:100%; 
  height: auto; 
}
</style>
<div class="container-fluid main-container">

<div class="navbar navbar-default navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">SNAP Data QA/QC</a>
      </div>
      <div class="navbar-collapse collapse navbar-responsive-collapse">
        <ul class="nav navbar-nav">
          <li><a href="index.html">Overview</a></li>

          <li class="dropdown">
            <a href="climate" class="dropdown-toggle" data-toggle="dropdown">Climate <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li class="dropdown-header">Extraction</li>
              <li><a href="AR4_AR5_extract.html">Downscaled GCMs</a></li>
              <li><a href="CRU_extract.html">Downscaled CRU 3.x</a></li>
              <li><a href="PRISM_extract.html">2-km PRISM</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">GCM organization</li>
              <li><a href="stats_setup.html">Regions: stats</a></li>
              <li><a href="samples_setup.html">Regions: densities</a></li>
              <li><a href="cities_setup.html">Cities: stats</a></li>
              <li class="dropdown-header">CRU organization</li>
              <li><a href="stats_setup_CRU.html">Regions: stats</a></li>
              <li><a href="samples_setup_CRU.html">Regions: densities</a></li>
              <li><a href="cities_setup_CRU.html">Cities: stats</a></li>
            </ul>

          <li class="dropdown">
            <a href="fire-&-veg" class="dropdown-toggle" data-toggle="dropdown">Fire & Veg <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li class="dropdown-header">Extraction</li>
              <li><a href="alfExtractMain.html">ALFRESCO: Rmpi</a></li>
              <li><a href="alfExtract.html">ALFRESCO: functions</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">Organization</li>
              <li><a href="alfPrep.html">ALFRESCO: final prep</a></li>
            </ul>

          <li class="dropdown">
            <a href="analyses" class="dropdown-toggle" data-toggle="dropdown">Analyses <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li class="dropdown-header">Autocorrelation</li>
              <li><a href="sp_ac_clump.html">Intro/example</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">Working with SNAP data</li>
              <li><a href="pres1_snapdata_alfresco.html">ALFRESCO</a></li>
            </ul>

          <li class="dropdown">
            <a href="app-docs" class="dropdown-toggle" data-toggle="dropdown">App docs <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li><a href="aboutapp.html">About</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">Help documents</li>
              <li><a href="help01_start.html">Getting started</a></li>
              <li><a href="help02_data.html">Working with data</a></li>
              <li><a href="help03_plotOptions.html">Graphical options</a></li>
              <li><a href="help04_updating.html">Updating settings</a></li>
              <li><a href="help05_01_graphTS.html">Graphing: time series</a></li>
              <li><a href="help05_02_graphScatter.html">Graphing: scatter plots</a></li>
              <li><a href="help05_03_graphHeat.html">Graphing: heat maps</a></li>
              <li><a href="help05_04_graphVar.html">Graphing: variability</a></li>
              <li><a href="help05_05_graphSpatial.html">Graphing: distributions</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">Prep R code</li>
              <li><a href="qaqc_app_metadata.html">QA/QC App Metadata</a></li>
            </ul>

          <li class="dropdown">
            <a href="app-code" class="dropdown-toggle" data-toggle="dropdown">App code <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li class="dropdown-header">App R code</li>
              <li><a href="appcode_global.html">global.R</a></li>
              <li><a href="appcode_ui.html">ui.R</a></li>
              <li><a href="appcode_server.html">server.R</a></li>
              <li><a href="appcode_about.html">about.R</a></li>
              <li class="divider"></li>
              <li><a href="appcode_sidebar.html">sidebar.R</a></li>
              <li><a href="appcode_main.html">main.R</a></li>
              <li><a href="appcode_serverHead.html">serverHead.R</a></li>
              <li><a href="appcode_app.html">app.R</a></li>
              <li class="divider"></li>
              <li><a href="appcode_io_sidebar.html">io_sidebar.R</a></li>
              <li><a href="appcode_io_main.html">io_main.R</a></li>
              <li><a href="appcode_reactives.html">reactives.R</a></li>
              <li class="divider"></li>
              <li><a href="appcode_plot_ts.html">plot_ts.R</a></li>
              <li><a href="appcode_plot_scatter.html">plot_scatter.R</a></li>
              <li><a href="appcode_plot_heatmap.html">plot_heatmap.R</a></li>
              <li><a href="appcode_plot_variability.html">plot_variability.R</a></li>
              <li><a href="appcode_plot_spatial.html">plot_spatial.R</a></li>
            </ul>

          <li><a href="http://leonawicz.github.io">All Projects</a></li>
        </ul>
        <ul class="nav navbar-nav navbar-right">
          <a class="btn btn-link" href="https://github.com/leonawicz/SNAPQAQC">
            <i class="fa fa-github fa-lg"></i>
            Github
          </a>
        </ul>
      </div><!--/.nav-collapse -->
    </div>
  </div>

<div id="header">
<h1 class="title">ALFRESCO Data Extraction: Function Code</h1>
</div>


<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>The <code>alfExtract.R</code> script uses extract fire and vegetation statistics from calibrated, finalized ALFRESCO run output over the full Alaska-Canada 1-km resolution ALFRESCO extent. Data are saved to <strong>R</strong> workspaces (.RData files) for analysis and graphing by subsequent <strong>R</strong> code.</p>
<div id="details" class="section level3">
<h3>Details</h3>
<p>This script is called by the wrapper script, <code>alfExtractMain.R</code> as part of a non-interactive <strong>R</strong> SLURM job process using <code>Rmpi</code>. The script consists of functions, which are loaded onto each CPU core. The execution calls still originate from the parent <code>Rpmi</code> script on the head node.</p>
</div>
<div id="files-and-data" class="section level3">
<h3>Files and data</h3>
<p>The input files include 1-km Alaska-Canada extent data from ALFRESCO simulations as well as raster layer cell indices pertaining to various regional shapefile polygons. All input data are passed directly from the <code>alfExtractMain.R</code> master <strong>R</strong> session running on the head node. <code>alfExtract.R</code> performs data extractions on multiple CPU cores across multiple compute nodes based on the data passed down to each CPU. Each CPU on the compute nodes is responsible for processing data for a unique ALFRESCO simulation spatial time series replicate.</p>
<p><code>alfExtract.R</code> passed some computed ALFRESCO output statistics back to <code>alfExtractMain.R</code> on the head node to be combined, organized and written to intermediary files:</p>
<ul>
<li>Fire data (burn area, fire frequency and fire sizes) by region and vegetation class</li>
<li>Vegetation age by region and vegetation class</li>
<li>Vegetated area by region and vegetation class</li>
</ul>
</div>
</div>
<div id="r-code" class="section level2">
<h2>R code</h2>
<div id="setup" class="section level3">
<h3>Setup</h3>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">suppressMessages</span>(<span class="kw">library</span>(rgdal))
<span class="kw">suppressMessages</span>(<span class="kw">library</span>(raster))
<span class="kw">suppressMessages</span>(<span class="kw">library</span>(data.table))
<span class="kw">suppressMessages</span>(<span class="kw">library</span>(dplyr))
<span class="kw">rasterOptions</span>(<span class="dt">chunksize =</span> <span class="dv">10</span>^<span class="dv">12</span>, <span class="dt">maxmemory =</span> <span class="dv">10</span>^<span class="dv">11</span>)

prep_alf_files &lt;-<span class="st"> </span>function(i, loopBy, mainDir, reps, years) {
    if (<span class="kw">is.null</span>(years)) 
        years &lt;-<span class="st"> </span><span class="dv">2008</span>:<span class="dv">2100</span>
    if (loopBy ==<span class="st"> &quot;rep&quot;</span>) {
        iter &lt;-<span class="st"> </span>reps
        keep &lt;-<span class="st"> </span>reps -<span class="st"> </span><span class="dv">1</span>
        id &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;_&quot;</span>, years[i], <span class="st">&quot;.tif$&quot;</span>)
    } else if (loopBy ==<span class="st"> &quot;year&quot;</span>) {
        keep &lt;-<span class="st"> </span>iter &lt;-<span class="st"> </span>years
        id &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;_&quot;</span>, <span class="kw">c</span>(<span class="dv">0</span>:<span class="dv">199</span>)[i], <span class="st">&quot;_.*.tif$&quot;</span>)
    }
    p &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="kw">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;V&quot;</span>, <span class="st">&quot;FireS&quot;</span>), function(p, id) <span class="kw">gsub</span>(<span class="st">&quot;expression&quot;</span>, <span class="st">&quot;&quot;</span>, 
        <span class="kw">paste</span>(<span class="kw">bquote</span>(<span class="kw">expression</span>(<span class="st">&quot;^&quot;</span>, .(p), <span class="st">&quot;.*.&quot;</span>, .(id))), <span class="dt">collapse =</span> <span class="st">&quot;&quot;</span>)), 
        <span class="dt">id =</span> id)
    files &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="dv">1</span>:<span class="kw">length</span>(p), function(i, dir, p) <span class="kw">list.files</span>(dir, <span class="dt">pattern =</span> p[[i]], 
        <span class="dt">full =</span> <span class="ot">TRUE</span>), <span class="dt">dir =</span> mainDir, <span class="dt">p =</span> p)
    <span class="kw">names</span>(files) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Age&quot;</span>, <span class="st">&quot;Veg&quot;</span>, <span class="st">&quot;FID&quot;</span>)
    if (loopBy ==<span class="st"> &quot;rep&quot;</span>) 
        files.idx &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">gsub</span>(<span class="st">&quot;FireScar_&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="kw">gsub</span>(<span class="st">&quot;_</span><span class="ch">\\</span><span class="st">d+</span><span class="ch">\\</span><span class="st">.tif&quot;</span>, <span class="st">&quot;&quot;</span>, 
            <span class="kw">basename</span>(files$FID)))) +<span class="st"> </span><span class="dv">1</span>
    if (loopBy ==<span class="st"> &quot;year&quot;</span>) 
        files.idx &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">gsub</span>(<span class="st">&quot;FireScar_</span><span class="ch">\\</span><span class="st">d+_&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="kw">gsub</span>(<span class="st">&quot;.tif&quot;</span>, <span class="st">&quot;&quot;</span>, 
            <span class="kw">basename</span>(files$FID))))
    ord &lt;-<span class="st"> </span><span class="kw">order</span>(files.idx)
    files &lt;-<span class="st"> </span><span class="kw">lapply</span>(files, function(x, ord) x[ord], <span class="dt">ord =</span> ord)
    if (loopBy ==<span class="st"> &quot;rep&quot;</span>) 
        files &lt;-<span class="st"> </span><span class="kw">lapply</span>(files, function(x, idx) x[idx], <span class="dt">idx =</span> reps)
    if (loopBy ==<span class="st"> &quot;year&quot;</span>) 
        files &lt;-<span class="st"> </span><span class="kw">lapply</span>(files, function(x, file.idx, keep) {
            k &lt;-<span class="st"> </span>file.idx %in%<span class="st"> </span>keep
            if (<span class="kw">any</span>(k)) 
                x[<span class="kw">which</span>(k)] else x
        }, <span class="dt">file.idx =</span> files.idx, <span class="dt">keep =</span> keep)
    files$iter &lt;-<span class="st"> </span>if (<span class="kw">is.null</span>(iter)) 
        files.idx[ord] else iter
    <span class="kw">stopifnot</span>(!<span class="kw">any</span>(<span class="kw">unlist</span>(<span class="kw">sapply</span>(files, is.na))))
    <span class="kw">stopifnot</span>(<span class="kw">all</span>(<span class="kw">diff</span>(<span class="kw">unlist</span>(<span class="kw">sapply</span>(files, length))) ==<span class="st"> </span><span class="dv">0</span>))
    files
}</code></pre>
</div>
<div id="processing-functions" class="section level3">
<h3>Processing functions</h3>
<div id="extract_data" class="section level4">
<h4>extract_data</h4>
<pre class="sourceCode r"><code class="sourceCode r">extract_data &lt;-<span class="st"> </span>function(i, type, loopBy, mainDir, <span class="dt">ageDir =</span> <span class="ot">NULL</span>, <span class="dt">reps =</span> <span class="ot">NULL</span>, 
    <span class="dt">years =</span> <span class="ot">NULL</span>, cells, ...) {
    <span class="kw">stopifnot</span>(<span class="kw">length</span>(type) &gt;<span class="st"> </span><span class="dv">0</span> &amp;&amp;<span class="st"> </span>type %in%<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;av&quot;</span>, <span class="st">&quot;fsv&quot;</span>))
    if (type ==<span class="st"> &quot;av&quot;</span>) 
        <span class="kw">return</span>(<span class="kw">extract_av</span>(i, loopBy, mainDir, ageDir, reps, years, cells, ...))
    if (type ==<span class="st"> &quot;fsv&quot;</span>) 
        <span class="kw">return</span>(<span class="kw">extract_fsv</span>(i, loopBy, mainDir, reps, years, cells, ...))
}</code></pre>
</div>
<div id="extract_fsv" class="section level4">
<h4>extract_fsv</h4>
<pre class="sourceCode r"><code class="sourceCode r">extract_fsv &lt;-<span class="st"> </span>function(i, loopBy, mainDir, <span class="dt">reps =</span> <span class="ot">NULL</span>, <span class="dt">years =</span> <span class="ot">NULL</span>, cells, 
    ...) {
    if (<span class="kw">is.null</span>(<span class="kw">list</span>(...)$veg.labels)) {
        veg.labels &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Black Spruce&quot;</span>, <span class="st">&quot;White Spruce&quot;</span>, <span class="st">&quot;Deciduous&quot;</span>, <span class="st">&quot;Shrub Tundra&quot;</span>, 
            <span class="st">&quot;Graminoid Tundra&quot;</span>, <span class="st">&quot;Wetland Tundra&quot;</span>, <span class="st">&quot;Barren lichen-moss&quot;</span>, <span class="st">&quot;Temperate Rainforest&quot;</span>)
    } else veg.labels &lt;-<span class="st"> </span><span class="kw">list</span>(...)$veg.labels
    x &lt;-<span class="st"> </span><span class="kw">prep_alf_files</span>(<span class="dt">i =</span> i, <span class="dt">loopBy =</span> loopBy, <span class="dt">mainDir =</span> mainDir, <span class="dt">reps =</span> reps, 
        <span class="dt">years =</span> years)
    cells &lt;-<span class="st"> </span><span class="kw">group_by</span>(cells, LocGroup, Location)
    d.fs &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="st">&quot;list&quot;</span>, <span class="kw">length</span>(x$iter))
    for (j in <span class="dv">1</span>:<span class="kw">length</span>(x$iter)) {
        <span class="co"># fire size by vegetation class</span>
        v &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">FID =</span> <span class="kw">getValues</span>(<span class="kw">raster</span>(x$FID[j], <span class="dt">band =</span> <span class="dv">2</span>)), <span class="dt">Veg =</span> <span class="kw">getValues</span>(<span class="kw">raster</span>(x$Veg[j])))
        d &lt;-<span class="st"> </span><span class="kw">filter</span>(cells, Cell %in%<span class="st"> </span><span class="kw">which</span>(!<span class="kw">is.na</span>(v$FID))) %&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">Vegetation =</span> <span class="kw">factor</span>(veg.labels[v$Veg[Cell]], 
            <span class="dt">levels =</span> veg.labels), <span class="dt">FID =</span> v$FID[Cell]) %&gt;%<span class="st"> </span><span class="kw">group_by</span>(LocGroup, 
            Location, Vegetation, FID) %&gt;%<span class="st"> </span><span class="kw">summarise</span>(<span class="dt">Val =</span> <span class="kw">length</span>(Cell), <span class="dt">Var =</span> <span class="st">&quot;Fire Size&quot;</span>)
        d.fs[[j]] &lt;-<span class="st"> </span>if (loopBy ==<span class="st"> &quot;rep&quot;</span>) 
            <span class="kw">mutate</span>(d, <span class="dt">Replicate =</span> x$iter[j]) else if (loopBy ==<span class="st"> &quot;year&quot;</span>) 
            <span class="kw">mutate</span>(d, <span class="dt">Year =</span> x$iter[j])
        <span class="kw">print</span>(switch(loopBy, <span class="dt">rep =</span> <span class="kw">paste0</span>(<span class="st">&quot;Year &quot;</span>, years[i], <span class="st">&quot;: Replicate &quot;</span>, 
            x$iter[j]), <span class="dt">year =</span> <span class="kw">paste0</span>(<span class="st">&quot;Replicate &quot;</span>, i, <span class="st">&quot;: Year &quot;</span>, years[x$iter[j]])))
    }
    d.fs &lt;-<span class="st"> </span>if (loopBy ==<span class="st"> &quot;rep&quot;</span>) 
        <span class="kw">rbindlist</span>(d.fs)[, <span class="st">`</span><span class="dt">:=</span><span class="st">`</span>(Year, <span class="kw">as.integer</span>(years[i]))] else if (loopBy ==<span class="st"> &quot;year&quot;</span>) 
        <span class="kw">rbindlist</span>(d.fs)[, <span class="st">`</span><span class="dt">:=</span><span class="st">`</span>(Replicate, <span class="kw">as.integer</span>(i))]
    d.fs &lt;-<span class="st"> </span><span class="kw">setcolorder</span>(d.fs, <span class="kw">c</span>(<span class="st">&quot;LocGroup&quot;</span>, <span class="st">&quot;Location&quot;</span>, <span class="st">&quot;Var&quot;</span>, <span class="st">&quot;Vegetation&quot;</span>, 
        <span class="st">&quot;Year&quot;</span>, <span class="st">&quot;Val&quot;</span>, <span class="st">&quot;FID&quot;</span>, <span class="st">&quot;Replicate&quot;</span>)) %&gt;%<span class="st"> </span><span class="kw">group_by</span>(LocGroup, Location, 
        Var, Vegetation, Year) %&gt;%<span class="st"> </span><span class="kw">setorder</span>(Replicate, LocGroup, Location, Var, 
        Vegetation, Year, Val)
    <span class="kw">print</span>(<span class="kw">paste</span>(<span class="st">&quot;Returning fire size by vegetation class data table.&quot;</span>))
    d.fs
}</code></pre>
</div>
<div id="extract_av" class="section level4">
<h4>extract_av</h4>
<pre class="sourceCode r"><code class="sourceCode r">extract_av &lt;-<span class="st"> </span>function(i, loopBy, mainDir, <span class="dt">ageDir =</span> <span class="ot">NULL</span>, <span class="dt">reps =</span> <span class="ot">NULL</span>, <span class="dt">years =</span> <span class="ot">NULL</span>, 
    cells, ...) {
    if (<span class="kw">is.null</span>(<span class="kw">list</span>(...)$veg.labels)) {
        veg.labels &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Black Spruce&quot;</span>, <span class="st">&quot;White Spruce&quot;</span>, <span class="st">&quot;Deciduous&quot;</span>, <span class="st">&quot;Shrub Tundra&quot;</span>, 
            <span class="st">&quot;Graminoid Tundra&quot;</span>, <span class="st">&quot;Wetland Tundra&quot;</span>, <span class="st">&quot;Barren lichen-moss&quot;</span>, <span class="st">&quot;Temperate Rainforest&quot;</span>)
    } else veg.labels &lt;-<span class="st"> </span><span class="kw">list</span>(...)$veg.labels
    if (!<span class="kw">is.numeric</span>(<span class="kw">list</span>(...)$n.samples)) 
        n.samples &lt;-<span class="st"> </span><span class="dv">1000</span> else n.samples &lt;-<span class="st"> </span><span class="kw">list</span>(...)$n.samples
    x &lt;-<span class="st"> </span><span class="kw">prep_alf_files</span>(<span class="dt">i =</span> i, <span class="dt">loopBy =</span> loopBy, <span class="dt">mainDir =</span> mainDir, <span class="dt">reps =</span> reps, 
        <span class="dt">years =</span> years)
    cells &lt;-<span class="st"> </span><span class="kw">group_by</span>(cells, LocGroup, Location)
    r &lt;-<span class="st"> </span><span class="kw">getValues</span>(<span class="kw">raster</span>(x$Age[<span class="dv">1</span>]))  <span class="co"># use as a template</span>
    idx &lt;-<span class="st"> </span><span class="kw">which</span>(!<span class="kw">is.na</span>(r))
    idx.rmNA &lt;-<span class="st"> </span><span class="kw">which</span>(idx %in%<span class="st"> </span><span class="dv">1</span>:<span class="kw">length</span>(r))
    d.age &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="st">&quot;list&quot;</span>, <span class="kw">length</span>(x$iter))
    for (j in <span class="dv">1</span>:<span class="kw">length</span>(x$iter)) {
        v &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">Age =</span> <span class="kw">getValues</span>(<span class="kw">raster</span>(x$Age[j]))[idx], <span class="dt">Veg =</span> <span class="kw">getValues</span>(<span class="kw">raster</span>(x$Veg[j]))[idx])
        v$Age[v$Age &lt;<span class="st"> </span><span class="dv">0</span>] &lt;-<span class="st"> </span>v$Age[v$Age &lt;<span class="st"> </span><span class="dv">0</span>] +<span class="st"> </span><span class="dv">2147483647</span>  <span class="co"># temporary hack</span>
        d &lt;-<span class="st"> </span><span class="kw">filter</span>(cells, Cell_rmNA %in%<span class="st"> </span>idx.rmNA) %&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">Vegetation =</span> <span class="kw">factor</span>(veg.labels[v$Veg[Cell_rmNA]], 
            <span class="dt">levels =</span> veg.labels), <span class="dt">Age =</span> v$Age[Cell_rmNA]) %&gt;%<span class="st"> </span><span class="kw">group_by</span>(LocGroup, 
            Location, Vegetation, Age) %&gt;%<span class="st"> </span><span class="kw">summarise</span>(<span class="dt">Freq =</span> <span class="kw">length</span>(Cell_rmNA))
        d.age[[j]] &lt;-<span class="st"> </span>if (loopBy ==<span class="st"> &quot;rep&quot;</span>) 
            <span class="kw">mutate</span>(d, <span class="dt">Replicate =</span> x$iter[j]) else if (loopBy ==<span class="st"> &quot;year&quot;</span>) 
            <span class="kw">mutate</span>(d, <span class="dt">Year =</span> x$iter[j])
        <span class="kw">print</span>(switch(loopBy, <span class="dt">rep =</span> <span class="kw">paste0</span>(<span class="st">&quot;Year &quot;</span>, years[i], <span class="st">&quot;: Replicate &quot;</span>, 
            x$iter[j]), <span class="dt">year =</span> <span class="kw">paste0</span>(<span class="st">&quot;Replicate &quot;</span>, i, <span class="st">&quot;: Year &quot;</span>, years[x$iter[j]])))
    }
    d.age &lt;-<span class="st"> </span>if (loopBy ==<span class="st"> &quot;rep&quot;</span>) 
        <span class="kw">rbindlist</span>(d.age)[, <span class="st">`</span><span class="dt">:=</span><span class="st">`</span>(Year, <span class="kw">as.integer</span>(years[i]))] else if (loopBy ==<span class="st"> &quot;year&quot;</span>) 
        <span class="kw">rbindlist</span>(d.age)[, <span class="st">`</span><span class="dt">:=</span><span class="st">`</span>(Replicate, <span class="kw">as.integer</span>(i))]
    d.age &lt;-<span class="st"> </span><span class="kw">group_by</span>(d.age, LocGroup, Location, Year, Vegetation) %&gt;%<span class="st"> </span><span class="kw">setorder</span>(Replicate, 
        LocGroup, Location, Year, Vegetation, Age, Freq)
    locs &lt;-<span class="st"> </span><span class="kw">unique</span>(d.age$Location)
    if (loopBy ==<span class="st"> &quot;rep&quot;</span>) {
        d.area &lt;-<span class="st"> </span><span class="kw">group_by</span>(d.age, Replicate, <span class="dt">add =</span> T) %&gt;%<span class="st"> </span><span class="kw">summarise</span>(<span class="dt">Val =</span> <span class="kw">sum</span>(Freq))
        d.area[, <span class="st">`</span><span class="dt">:=</span><span class="st">`</span>(Var, <span class="st">&quot;Vegetated Area&quot;</span>)]
        <span class="kw">setcolorder</span>(d.area, <span class="kw">c</span>(<span class="st">&quot;LocGroup&quot;</span>, <span class="st">&quot;Location&quot;</span>, <span class="st">&quot;Var&quot;</span>, <span class="st">&quot;Vegetation&quot;</span>, <span class="st">&quot;Year&quot;</span>, 
            <span class="st">&quot;Val&quot;</span>, <span class="st">&quot;Replicate&quot;</span>))
        d.age &lt;-<span class="st"> </span><span class="kw">group_by</span>(d.age, Age, <span class="dt">add =</span> T) %&gt;%<span class="st"> </span><span class="kw">summarise</span>(<span class="dt">Freq =</span> <span class="kw">sum</span>(Freq))
        d.age[, <span class="st">`</span><span class="dt">:=</span><span class="st">`</span>(Var, <span class="st">&quot;Vegetation Age&quot;</span>)]
        <span class="kw">setcolorder</span>(d.age, <span class="kw">c</span>(<span class="st">&quot;LocGroup&quot;</span>, <span class="st">&quot;Location&quot;</span>, <span class="st">&quot;Var&quot;</span>, <span class="st">&quot;Vegetation&quot;</span>, <span class="st">&quot;Year&quot;</span>, 
            <span class="st">&quot;Age&quot;</span>, <span class="st">&quot;Freq&quot;</span>))
        <span class="kw">return</span>(<span class="kw">list</span>(<span class="dt">d.area =</span> d.area, <span class="dt">d.age =</span> d.age))
    }
    if (loopBy ==<span class="st"> &quot;year&quot;</span>) {
        d.area &lt;-<span class="st"> </span><span class="kw">summarise</span>(d.age, <span class="dt">Val =</span> <span class="kw">sum</span>(Freq))
        d.area[, <span class="st">`</span><span class="dt">:=</span><span class="st">`</span>(Var, <span class="st">&quot;Vegetated Area&quot;</span>)]
        <span class="kw">setcolorder</span>(d.area, <span class="kw">c</span>(<span class="st">&quot;LocGroup&quot;</span>, <span class="st">&quot;Location&quot;</span>, <span class="st">&quot;Var&quot;</span>, <span class="st">&quot;Vegetation&quot;</span>, <span class="st">&quot;Year&quot;</span>, 
            <span class="st">&quot;Val&quot;</span>, <span class="st">&quot;Replicate&quot;</span>))
        <span class="kw">setkey</span>(d.age, Location)
        for (j in <span class="dv">1</span>:<span class="kw">length</span>(locs)) {
            obj.name.tmp &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;age__&quot;</span>, locs[j], <span class="st">&quot;__rep&quot;</span>, i)
            <span class="kw">assign</span>(obj.name.tmp, d.age[locs[j]])
            <span class="kw">save</span>(<span class="dt">list =</span> <span class="kw">c</span>(<span class="st">&quot;locs&quot;</span>, obj.name.tmp), <span class="dt">file =</span> <span class="kw">paste0</span>(ageDir, <span class="st">&quot;/&quot;</span>, 
                obj.name.tmp, <span class="st">&quot;.RData&quot;</span>))
            <span class="kw">print</span>(<span class="kw">paste</span>(obj.name.tmp, <span class="st">&quot;object&quot;</span>, j, <span class="st">&quot;of&quot;</span>, <span class="kw">length</span>(locs), <span class="st">&quot;saved.&quot;</span>))
            <span class="kw">rm</span>(<span class="dt">list =</span> obj.name.tmp)
            <span class="kw">gc</span>()
        }
        <span class="kw">rm</span>(d.age)
        <span class="kw">gc</span>()
        <span class="kw">return</span>(<span class="kw">list</span>(<span class="dt">d.area =</span> d.area))
    }
}</code></pre>
</div>
</div>
</div>

<!-- some extra javascript for older browsers -->
<script type="text/javascript" src="libs/polyfill.js"></script>
<script>
  // manage active state of menu based on current page
  $(document).ready(function () {
  
    // active menu
    href = window.location.pathname
    href = href.substr(href.lastIndexOf('/') + 1)
    $('a[href="' + href + '"]').parent().addClass('active');
    
    // manage active menu header
    if (href.startsWith('authoring_'))
      $('a[href="' + 'authoring' + '"]').parent().addClass('active');
    else if (href.endsWith('_format.html'))
      $('a[href="' + 'formats' + '"]').parent().addClass('active');
    else if (href.startsWith('developer_'))
      $('a[href="' + 'developer' + '"]').parent().addClass('active');
	  
  });
</script>

</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>


</body>
</html>
