<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="author" content="Matthew Leonawicz" />


<title>CRU 3.x Cities Setup Code</title>

<script src="libs/jquery-1.11.0/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.1/css/cosmo.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.1/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/respond.min.js"></script>
<style type="text/css">
/* padding for bootstrap navbar */
body {
padding-top: 50px;
padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar) */
.section h2 {
padding-top: 55px;
margin-top: -55px;
}
.section h3 {
padding-top: 55px;
margin-top: -55px;
}
/* don't use link color in navbar */
.dropdown-menu>li>a {
color: black;
}
/* some padding for disqus */
#disqus_thread {
margin-top: 45px;
}
p {
  text-align: justify;
}
img.centered {
  display: block;
  margin-left: auto;
  margin-right: auto;
}
</style>
<link rel="stylesheet" href="libs/font-awesome-4.1.0/css/font-awesome.min.css"/>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; background-color: #303030; color: #cccccc; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; }
td.sourceCode { padding-left: 5px; }
pre, code { color: #cccccc; background-color: #303030; }
code > span.kw { color: #f0dfaf; }
code > span.dt { color: #dfdfbf; }
code > span.dv { color: #dcdccc; }
code > span.bn { color: #dca3a3; }
code > span.fl { color: #c0bed1; }
code > span.ch { color: #dca3a3; }
code > span.st { color: #cc9393; }
code > span.co { color: #7f9f7f; }
code > span.ot { color: #efef8f; }
code > span.al { color: #ffcfaf; }
code > span.fu { color: #efef8f; }
code > span.er { color: #c3bf9f; }
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>



<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-46129458-3', 'auto');
  ga('send', 'pageview');

</script>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img { 
  max-width:100%; 
  height: auto; 
}
</style>
<div class="container-fluid main-container">

<div class="navbar navbar-default navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">SNAP Data QA/QC</a>
      </div>
      <div class="navbar-collapse collapse navbar-responsive-collapse">
        <ul class="nav navbar-nav">
          <li><a href="index.html">Overview</a></li>

          <li class="dropdown">
            <a href="climate" class="dropdown-toggle" data-toggle="dropdown">Climate <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li class="dropdown-header">Extraction</li>
              <li><a href="AR4_AR5_extract.html">Downscaled GCMs</a></li>
              <li><a href="CRU_extract.html">Downscaled CRU 3.x</a></li>
              <li><a href="PRISM_extract.html">2-km PRISM</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">GCM organization</li>
              <li><a href="stats_setup.html">Regions: stats</a></li>
              <li><a href="samples_setup.html">Regions: densities</a></li>
              <li><a href="cities_setup.html">Cities: stats</a></li>
              <li class="dropdown-header">CRU organization</li>
              <li><a href="stats_setup_CRU.html">Regions: stats</a></li>
              <li><a href="samples_setup_CRU.html">Regions: densities</a></li>
              <li><a href="cities_setup_CRU.html">Cities: stats</a></li>
            </ul>

          <li class="dropdown">
            <a href="fire-&-veg" class="dropdown-toggle" data-toggle="dropdown">Fire & Veg <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li class="dropdown-header">Extraction</li>
              <li><a href="alfStatsByRep_Rmpi.html">ALFRESCO: Rmpi</a></li>
              <li><a href="alfStatsByRep.html">ALFRESCO: functions</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">Organization</li>
              <li><a href="getAlfStatsAndDensities.html">ALFRESCO: stats and densities</a></li>
            </ul>

          <li class="dropdown">
            <a href="analyses" class="dropdown-toggle" data-toggle="dropdown">Analyses <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li class="dropdown-header">Autocorrelation</li>
              <li><a href="sp_ac_clump.html">Intro/example</a></li>
            </ul>

          <li class="dropdown">
            <a href="app-docs" class="dropdown-toggle" data-toggle="dropdown">App docs <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li><a href="aboutapp.html">About</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">Help documents</li>
              <li><a href="help01_start.html">Getting started</a></li>
              <li><a href="help02_data.html">Working with data</a></li>
              <li><a href="help03_plotOptions.html">Graphical options</a></li>
              <li><a href="help04_updating.html">Updating settings</a></li>
              <li><a href="help05_01_graphTS.html">Graphing: time series</a></li>
              <li><a href="help05_02_graphScatter.html">Graphing: scatter plots</a></li>
              <li><a href="help05_03_graphHeat.html">Graphing: heat maps</a></li>
              <li><a href="help05_04_graphVar.html">Graphing: variability</a></li>
              <li><a href="help05_05_graphSpatial.html">Graphing: distributions</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">Prep R code</li>
              <li><a href="qaqc_app_metadata.html">QA/QC App Metadata</a></li>
            </ul>

          <li class="dropdown">
            <a href="app-code" class="dropdown-toggle" data-toggle="dropdown">App code <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li class="dropdown-header">App R code</li>
              <li><a href="appcode_global.html">global.R</a></li>
              <li><a href="appcode_ui.html">ui.R</a></li>
              <li><a href="appcode_server.html">server.R</a></li>
              <li><a href="appcode_about.html">about.R</a></li>
              <li class="divider"></li>
              <li><a href="appcode_sidebar.html">sidebar.R</a></li>
              <li><a href="appcode_main.html">main.R</a></li>
              <li><a href="appcode_serverHead.html">serverHead.R</a></li>
              <li><a href="appcode_app.html">app.R</a></li>
              <li class="divider"></li>
              <li><a href="appcode_io_sidebar.html">io_sidebar.R</a></li>
              <li><a href="appcode_io_main.html">io_main.R</a></li>
              <li><a href="appcode_reactives.html">reactives.R</a></li>
              <li class="divider"></li>
              <li><a href="appcode_plot_ts.html">plot_ts.R</a></li>
              <li><a href="appcode_plot_scatter.html">plot_scatter.R</a></li>
              <li><a href="appcode_plot_heatmap.html">plot_heatmap.R</a></li>
              <li><a href="appcode_plot_variability.html">plot_variability.R</a></li>
              <li><a href="appcode_plot_spatial.html">plot_spatial.R</a></li>
            </ul>

          <li><a href="http://leonawicz.github.io">All Projects</a></li>
        </ul>
        <ul class="nav navbar-nav navbar-right">
          <a class="btn btn-link" href="https://github.com/leonawicz/SNAPQAQC">
            <i class="fa fa-github fa-lg"></i>
            Github
          </a>
        </ul>
      </div><!--/.nav-collapse -->
    </div>
  </div>

<div id="header">
<h1 class="title">CRU 3.x Cities Setup Code</h1>
<h4 class="author"><em>Matthew Leonawicz</em></h4>
</div>


<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>The <code>cities_setup_CRU.R</code> script prepares extracted CRU 3.x community temperature and precipitation data for direct use.</p>
<div id="motivation" class="section level3">
<h3>Motivation</h3>
<p>This script transforms and organizes output data from a parent script into a format that is easier to work with in certain frameworks.</p>
</div>
<div id="details" class="section level3">
<h3>Details</h3>
<p>The data are extracted based on coordinates of communities. Using the 2-km Alaska_Canada extent, single 2-km raster grid cells in which coordinate pairs for each community fall are used as point location estimates. This is done for SNAPâ€™s CRU 3.x data set. Data manipulation is performed to organize the inputs into more usefully formatted outputs.</p>
<div id="capabilities" class="section level4">
<h4>Capabilities</h4>
<p>This script uses parallel processing via the base <code>parallel</code> package and the function <code>mclapply</code>. It uses as many CPU cores as are available since it is parallelized across cities, which exceed the number of cores. It becomes serial beyond the number of cores simultaneously in use.</p>
</div>
<div id="limitations" class="section level4">
<h4>Limitations</h4>
<p>This code expects CRU 3.x data have been processed by the parent script. The code does not make use of <code>Rmpi</code> or similar options so it cannot take advantage of multi-node cluster parallel processing.</p>
</div>
</div>
</div>
<div id="related-items" class="section level2">
<h2>Related items</h2>
<div id="files-and-data" class="section level3">
<h3>Files and data</h3>
<p>The input files are produced by the <strong>R</strong> script, <code>CRU_extract.R</code>. <code>cities_setup_CRU.R</code> assumes a complete and successful run of this precursory code.</p>
<p>The <code>CRU_extract.R</code> script produces three main sets of output data: * Data for variables at the scale and location of individual communities * Spatially aggregated summary statistics of this data over larger regions * Regional probability distribution estimates for these same regions.</p>
<p>For this reason, <code>cities_setup_CRU.R</code> has two companion <strong>R</strong> scripts which share the parent script, <code>CRU_extract.R</code>. These are <code>stats_setup_CRU.R</code> and <code>samples_setup_CRU.R</code>.</p>
<p>In the hierarchy of these extraction and data preparation scripts, <code>AR4_AR5_extract.R</code> exists alongside <code>CRU_extract.R</code>. As a result, this script and its two companion scripts mentioned above are related to a similar set of three <strong>R</strong> scripts which perform similar intermediary data manipulation on extracted GCM data.</p>
</div>
</div>
<div id="r-code" class="section level2">
<h2><strong>R</strong> Code</h2>
<div id="setup" class="section level3">
<h3>Setup</h3>
<p>Setup is minimal. Set working directory. List CRU 3.x files.</p>
<pre class="sourceCode r"><code class="sourceCode r">comArgs &lt;-<span class="st"> </span><span class="kw">commandArgs</span>(<span class="ot">TRUE</span>)
if (<span class="kw">length</span>(comArgs)) for (i in <span class="dv">1</span>:<span class="kw">length</span>(comArgs)) <span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> comArgs[[i]]))
if (!<span class="kw">exists</span>(<span class="st">&quot;domain&quot;</span>)) <span class="kw">stop</span>(<span class="st">&quot;domain argument not provided. Must be either &#39;akcan2km&#39; or &#39;world10min&#39;&quot;</span>)
if (!<span class="kw">exists</span>(<span class="st">&quot;cities.batch&quot;</span>)) cities.batch &lt;-<span class="st"> </span><span class="dv">1</span>
if (!<span class="kw">exists</span>(<span class="st">&quot;cru&quot;</span>)) cru &lt;-<span class="st"> &quot;32&quot;</span>

<span class="kw">setwd</span>(<span class="st">&quot;/workspace/UA/mfleonawicz/projects/SNAPQAQC/data/cities&quot;</span>)

<span class="kw">library</span>(data.table)

files &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="dt">pattern =</span> <span class="kw">paste0</span>(<span class="st">&quot;^CRU&quot;</span>, cru, <span class="st">&quot;.*.batch&quot;</span>, cities.batch, 
    <span class="st">&quot;_&quot;</span>, domain, <span class="st">&quot;.RData$&quot;</span>))

models &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;CRU&quot;</span>, cru)</code></pre>
<div id="load-and-compile-data" class="section level4">
<h4>Load and compile data</h4>
<pre class="sourceCode r"><code class="sourceCode r">dlist &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="st">&quot;list&quot;</span>, <span class="kw">length</span>(files))
for (i in <span class="dv">1</span>:<span class="kw">length</span>(files)) {
    <span class="kw">load</span>(files[i])
    cities.meta &lt;-<span class="st"> </span>d.cities
    m &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(d)
    n &lt;-<span class="st"> </span><span class="kw">length</span>(m)
    dlist[[i]] &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">Var =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;Temperature&quot;</span>, <span class="st">&quot;Precipitation&quot;</span>), <span class="dt">each =</span> n/(<span class="dv">2</span> *<span class="st"> </span>
<span class="st">        </span><span class="kw">nrow</span>(cities.meta))), <span class="dt">Location =</span> <span class="kw">rep</span>(<span class="kw">paste0</span>(cities.meta$loc, <span class="st">&quot;, &quot;</span>, cities.meta$region), 
        <span class="dt">each =</span> n/<span class="kw">nrow</span>(cities.meta)), <span class="dt">Val =</span> m, <span class="dt">stringsAsFactors =</span> F)
    <span class="kw">gc</span>()
    <span class="kw">print</span>(i)
}
d &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">rbindlist</span>(dlist))
<span class="kw">rm</span>(n, m, i, files, models, dlist, cities.batch)</code></pre>
</div>
<div id="organize-data-frame-and-support-objects" class="section level4">
<h4>Organize data frame and support objects</h4>
<pre class="sourceCode r"><code class="sourceCode r">d$Val[d$Var ==<span class="st"> &quot;Temperature&quot;</span>] &lt;-<span class="st"> </span><span class="kw">round</span>(d$Val[d$Var ==<span class="st"> &quot;Temperature&quot;</span>], <span class="dv">1</span>)
d$Val[d$Var ==<span class="st"> &quot;Precipitation&quot;</span>] &lt;-<span class="st"> </span><span class="kw">round</span>(d$Val[d$Var ==<span class="st"> &quot;Precipitation&quot;</span>])
d$Month &lt;-<span class="st"> </span>month.abb
d$Year &lt;-<span class="st"> </span>results.years  <span class="co">#rep(1901:2009,each=12)</span>
d$Month &lt;-<span class="st"> </span><span class="kw">factor</span>(d$Month, <span class="dt">levels =</span> d$Month[<span class="dv">1</span>:<span class="dv">12</span>])
cities.meta$loc &lt;-<span class="st"> </span><span class="kw">paste0</span>(cities.meta$loc, <span class="st">&quot;, &quot;</span>, cities.meta$region)
cities.meta &lt;-<span class="st"> </span>cities.meta[<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span>:<span class="dv">6</span>)]
<span class="kw">names</span>(cities.meta) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Country&quot;</span>, <span class="st">&quot;Location&quot;</span>, <span class="st">&quot;Population&quot;</span>, <span class="st">&quot;Lat&quot;</span>, <span class="st">&quot;Lon&quot;</span>)
d$Decade &lt;-<span class="st"> </span><span class="kw">as.character</span>(d$Year -<span class="st"> </span>d$Year%%<span class="dv">10</span>)
<span class="kw">gc</span>()
d.cities.cru &lt;-<span class="st"> </span>d
<span class="kw">rm</span>(d, results.years)
<span class="kw">gc</span>()
<span class="co"># save.image(&#39;../final/data_cities_CRU31.RData&#39;)</span></code></pre>
</div>
<div id="save-output-files" class="section level4">
<h4>Save output files</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(parallel)
f &lt;-<span class="st"> </span>function(i, <span class="dt">overwrite =</span> <span class="ot">FALSE</span>) {
    name.tmp &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;</span><span class="ch">\\</span><span class="st">.&quot;</span>, <span class="st">&quot;PER&quot;</span>, <span class="kw">gsub</span>(<span class="st">&quot;/&quot;</span>, <span class="st">&quot;FSLASH&quot;</span>, <span class="kw">gsub</span>(<span class="st">&quot;`&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="kw">gsub</span>(<span class="st">&quot;~&quot;</span>, 
        <span class="st">&quot;&quot;</span>, <span class="kw">gsub</span>(<span class="st">&quot;?&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="kw">gsub</span>(<span class="st">&quot;</span><span class="ch">\\</span><span class="st">&#39;&quot;</span>, <span class="st">&quot;APOS&quot;</span>, cities.meta$Location[i]))))))
    filename &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;../final/city_files_CRU&quot;</span>, cru, <span class="st">&quot;/&quot;</span>, domain, <span class="st">&quot;/&quot;</span>, <span class="kw">gsub</span>(<span class="st">&quot;, &quot;</span>, 
        <span class="st">&quot;--&quot;</span>, name.tmp), <span class="st">&quot;__&quot;</span>, domain, <span class="st">&quot;.RData&quot;</span>)
    if (overwrite |<span class="st"> </span>!<span class="kw">file.exists</span>(filename)) {
        city.cru.dat &lt;-<span class="st"> </span><span class="kw">subset</span>(d.cities.cru, Location ==<span class="st"> </span>cities.meta$Location[i])
        <span class="kw">save</span>(city.cru.dat, <span class="dt">file =</span> filename)
    }
    <span class="kw">print</span>(i)
}

<span class="kw">mclapply</span>(<span class="dv">1</span>:<span class="kw">length</span>(cities.meta$Location), f, <span class="dt">mc.cores =</span> <span class="dv">32</span>)

<span class="kw">rm</span>(cru, d.cities.cru, f, domain)
<span class="kw">save</span>(cities.meta, <span class="dt">file =</span> <span class="st">&quot;../final/cities_meta.RData&quot;</span>)  <span class="co"># only necessary one time out of all versions of CRU and GCMs, 10-minute resolution inputs provide larger city set (Northwest Territories)</span>
<span class="co"># load(&#39;../final/meta.RData&#39;) save.image(&#39;../final/meta.RData&#39;)</span></code></pre>
</div>
</div>
</div>

<!-- some extra javascript for older browsers -->
<script type="text/javascript" src="libs/polyfill.js"></script>
<script>
  // manage active state of menu based on current page
  $(document).ready(function () {
  
    // active menu
    href = window.location.pathname
    href = href.substr(href.lastIndexOf('/') + 1)
    $('a[href="' + href + '"]').parent().addClass('active');
    
    // manage active menu header
    if (href.startsWith('authoring_'))
      $('a[href="' + 'authoring' + '"]').parent().addClass('active');
    else if (href.endsWith('_format.html'))
      $('a[href="' + 'formats' + '"]').parent().addClass('active');
    else if (href.startsWith('developer_'))
      $('a[href="' + 'developer' + '"]').parent().addClass('active');
	  
  });
</script>

</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>


</body>
</html>
